<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>5-Gallon Bottle Tracking System - Multi-Barcode Scanner</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body {
    background: linear-gradient(135deg,#e3f2fd 0%,#f8f9fa 100%);
    font-family: 'Segoe UI', Arial, sans-serif;
    color: #222;
    margin: 0;
    padding: 0;
}

.container {
    max-width: 1200px;
    margin: 40px auto;
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 8px 32px rgba(33,150,243,0.08);
    padding: 32px 24px;
}

.header {
    text-align: center;
    margin-bottom: 32px;
    position: relative;
}

.tabs {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-bottom: 32px;
    flex-wrap: wrap;
}

.tab {
    background: linear-gradient(90deg,#2196F3 0%,#20c997 100%);
    color: #fff;
    border: none;
    border-radius: 25px;
    padding: 12px 28px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s, box-shadow 0.2s;
    box-shadow: 0 2px 8px rgba(33,150,243,0.08);
}

.tab:not(.active):hover {
    background: linear-gradient(90deg,#20c997 0%,#2196F3 100%);
}

.tab.active {
    background: linear-gradient(90deg,#1565c0 0%,#43e97b 100%);
    box-shadow: 0 4px 16px rgba(33,150,243,0.12);
}

.tab-content {
    display: none;
    animation: fadeIn 0.3s;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px);}
    to { opacity: 1; transform: translateY(0);}
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
    gap: 18px;
    margin-bottom: 32px;
}

.stat-card {
    background: #fff;
    border-radius: 15px;
    box-shadow: 0 2px 8px rgba(33,150,243,0.07);
    padding: 24px 18px;
    text-align: center;
}

.stat-number {
    font-size: 2.2rem;
    font-weight: bold;
    color: #2196F3;
}

.stat-label {
    font-size: 1rem;
    color: #6c757d;
    margin-top: 8px;
}

.bottle-grid, #client-list, #users-list {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(320px,1fr));
    gap: 18px;
    margin-top: 18px;
}

.bottle-card {
    background: #fff;
    border-radius: 15px;
    box-shadow: 0 2px 8px rgba(33,150,243,0.07);
    padding: 22px 18px;
    transition: box-shadow 0.2s;
}

.bottle-card:hover {
    box-shadow: 0 6px 24px rgba(33,150,243,0.13);
}

.bottle-id {
    font-size: 1.2rem;
    font-weight: bold;
    color: #1565c0;
    margin-bottom: 8px;
}

.status {
    display: inline-block;
    padding: 6px 16px;
    border-radius: 12px;
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 8px;
}

.status.available { background: #e3f2fd; color: #2196F3; }
.status.with-client { background: #d4edda; color: #28a745; }
.status.needs-refill { background: #fff3cd; color: #856404; }
.status.maintenance { background: #f8d7da; color: #dc3545; }

.btn, .login-btn {
    background: linear-gradient(90deg,#2196F3 0%,#20c997 100%);
    color: #fff;
    border: none;
    border-radius: 25px;
    padding: 10px 24px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    margin: 4px;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(33,150,243,0.08);
}

.btn:hover, .login-btn:hover {
    background: linear-gradient(90deg,#20c997 0%,#2196F3 100%);
    transform: translateY(-2px);
}

.btn-success { background: linear-gradient(90deg,#43e97b 0%,#38f9d7 100%); }
.btn-warning { background: linear-gradient(90deg,#ffc107 0%,#ff9800 100%); }
.btn-danger { background: linear-gradient(90deg,#dc3545 0%,#ff6a00 100%); }
.btn-secondary { background: linear-gradient(90deg,#6c757d 0%,#b0bec5 100%); }
.btn-sm { padding: 6px 14px; font-size: 0.95rem; }

input, select, textarea {
    font-size: 1rem;
    padding: 12px;
    border-radius: 10px;
    border: 2px solid #e9ecef;
    margin-bottom: 8px;
    width: 100%;
    box-sizing: border-box;
    transition: border 0.2s;
}

input:focus, select:focus, textarea:focus {
    border-color: #2196F3;
    outline: none;
}

.modal {
    display: none;
    position: fixed;
    z-index: 4000;
    left: 0; top: 0;
    width: 100vw; height: 100vh;
    background: rgba(33,150,243,0.12);
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 8px 32px rgba(33,150,243,0.18);
    padding: 32px 24px;
    max-width: 420px;
    width: 95vw;
    position: relative;
    animation: fadeIn 0.3s;
}

.close {
    position: absolute;
    top: 18px;
    right: 24px;
    font-size: 2rem;
    color: #2196F3;
    cursor: pointer;
    font-weight: bold;
}

.user-info-badge {
    position: absolute;
    top: -10px;
    right: 0;
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 2px 8px rgba(33,150,243,0.08);
    padding: 10px 18px;
    display: flex;
    align-items: center;
    gap: 18px;
    font-size: 0.95rem;
}

.logout-btn {
    background: linear-gradient(90deg,#dc3545 0%,#ff6a00 100%);
    color: #fff;
    border: none;
    border-radius: 18px;
    padding: 6px 18px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
}

#login-screen {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: linear-gradient(135deg,#2196F3 0%,#43e97b 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 5000;
}

.login-box {
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 8px 32px rgba(33,150,243,0.18);
    padding: 38px 28px;
    max-width: 350px;
    width: 95vw;
}

.small {
    font-size: 0.95rem;
    color: #6c757d;
}

/* BARCODE SCANNER STYLES */
.scanner-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    padding: 30px;
    margin: 20px 0;
    color: white;
    text-align: center;
}

.barcode-input-large {
    font-size: 24px !important;
    padding: 20px !important;
    text-align: center;
    font-family: 'Courier New', monospace;
    border: 3px solid #2196F3 !important;
    background: #fff;
    color: #000;
    font-weight: bold;
}

.barcode-input-large:focus {
    border-color: #43e97b !important;
    box-shadow: 0 0 20px rgba(67, 233, 123, 0.5);
}

.scanned-list {
    background: rgba(255,255,255,0.95);
    border-radius: 15px;
    padding: 20px;
    margin-top: 20px;
    max-height: 450px;
    overflow-y: auto;
}

.scanned-item {
    background: linear-gradient(90deg, #e3f2fd 0%, #f8f9fa 100%);
    padding: 15px;
    margin: 10px 0;
    border-radius: 10px;
    border-left: 5px solid #2196F3;
    display: flex;
    justify-content: space-between;
    align-items: center;
    animation: slideIn 0.3s;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.scanned-item.duplicate {
    border-left-color: #ffc107;
    background: linear-gradient(90deg, #fff3cd 0%, #f8f9fa 100%);
}

.scanned-item-code {
    font-size: 20px;
    font-weight: bold;
    font-family: 'Courier New', monospace;
    color: #1565c0;
}

.scanned-item-status {
    font-size: 14px;
    color: #6c757d;
    margin-top: 5px;
}

.remove-btn {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 35px;
    height: 35px;
    cursor: pointer;
    font-size: 18px;
    transition: all 0.2s;
}

.remove-btn:hover {
    background: #c82333;
    transform: scale(1.1);
}

.batch-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 20px;
}

.scanner-status {
    display: inline-block;
    padding: 10px 20px;
    border-radius: 25px;
    font-weight: bold;
    font-size: 16px;
    margin: 10px 0;
    animation: pulse 2s infinite;
}

.scanner-status.active {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.search-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 18px;
}

.search-input {
    max-width: 320px;
}

@media (max-width: 768px) {
    .container { padding: 16px; }
    .tabs { gap: 6px; }
    .tab { padding: 10px 16px; font-size: 0.95rem; }
    .stat-card { padding: 16px 12px; }
    .modal-content { padding: 20px 16px; }
    .user-info-badge { position: static; margin-bottom: 20px; }
}
</style>
</head>

<body>

<!-- LOGIN SCREEN -->
<div id="login-screen" style="display:none;">
    <div class="login-box">
        <div style="text-align:center;margin-bottom:30px;">
            <h1 style="color:#2196F3;font-size:2.5rem;margin-bottom:10px;">üî∑ Bottle Tracker</h1>
            <p style="color:#6c757d;">Secure Login Required</p>
        </div>

        <div id="login-form">
            <input type="text" id="login-username" placeholder="Username" class="login-input" style="width:100%;box-sizing:border-box;">
            <input type="password" id="login-password" placeholder="Password" class="login-input" style="width:100%;box-sizing:border-box;" onkeypress="if(event.key==='Enter')attemptLogin()">
            <button onclick="attemptLogin()" class="login-btn" style="width:100%;">üîì Login</button>
            <div style="text-align:center;margin-top:20px;">
                <a href="#" onclick="showRequestAccess();return false;" style="color:#2196F3;text-decoration:none;font-weight:600;">üìù Request Access</a>
            </div>
        </div>

        <div id="request-form" style="display:none;">
            <input type="text" id="req-name" placeholder="Your Full Name" class="login-input" style="width:100%;box-sizing:border-box;">
            <input type="text" id="req-username" placeholder="Desired Username" class="login-input" style="width:100%;box-sizing:border-box;">
            <input type="password" id="req-password" placeholder="Password" class="login-input" style="width:100%;box-sizing:border-box;">
            <select id="req-role" class="login-input" style="width:100%;box-sizing:border-box;">
                <option value="">Select Role</option>
                <option value="worker">üë∑ Store Worker</option>
                <option value="driver">üöö Driver</option>
                <option value="manager">üè™ Manager</option>
                <option value="admin">üëë Admin</option>
            </select>
            <button onclick="submitAccessRequest()" class="login-btn" style="background:linear-gradient(45deg,#28a745,#20c997);width:100%;">üì§ Submit Request</button>
            <button onclick="showLoginForm()" class="login-btn" style="background:#6c757d;width:100%;margin-top:10px;">‚Üê Back to Login</button>
        </div>
    </div>
</div>

<div class="container">
<div class="header">
<h1>üî∑ Bottle Tracking System</h1>
<p>All rights credited to AR GREEN</p>
</div>

<div class="tabs">
<button class="tab active" onclick="showTab(event,'dashboard')" id="dashboard-tab">üè† Dashboard</button>
<button class="tab" onclick="showTab(event,'scanner')" id="scanner-tab">üî∑ Scanner</button>
<button class="tab" onclick="showTab(event,'inventory')" id="inventory-tab">üì¶ Inventory</button>
<button class="tab" onclick="showTab(event,'clients')" id="clients-tab">üë• Clients</button>
<button class="tab" onclick="showTab(event,'reports')" id="reports-tab">üìä Reports</button>
<button class="tab" onclick="showTab(event,'users')" id="users-tab" style="display:none;">üë• Users</button>
</div>

<!-- Dashboard Tab -->
<div id="dashboard" class="tab-content active">
<h2>üìä System Overview</h2>
<div class="stats-grid">
<div class="stat-card">
<div class="stat-number" id="total-bottles">0</div>
<div class="stat-label">Total Bottles</div>
</div>
<div class="stat-card">
<div class="stat-number" id="available-bottles">0</div>
<div class="stat-label">Available</div>
</div>
<div class="stat-card">
<div class="stat-number" id="with-client-bottles">0</div>
<div class="stat-label">With Clients</div>
</div>
<div class="stat-card">
<div class="stat-number" id="needs-refill-bottles">0</div>
<div class="stat-label">Need Refill</div>
</div>
<div class="stat-card">
<div class="stat-number" id="maintenance-bottles">0</div>
<div class="stat-label">Maintenance</div>
</div>
<div class="stat-card">
<div class="stat-number" id="total-clients">0</div>
<div class="stat-label">Active Clients</div>
</div>
</div>

<h3>üî• Recent Activity</h3>
<div id="recent-activity" style="background:rgba(255,255,255,0.8);border-radius:15px;padding:20px;margin-top:15px;max-height:300px;overflow-y:auto;">
<p class="small">No recent activity</p>
</div>

<h3 style="margin-top:25px;">‚ö†Ô∏è Alerts & Notifications</h3>
<div id="alerts" style="background:rgba(255,255,255,0.8);border-radius:15px;padding:20px;margin-top:15px;">
<p class="small">No alerts</p>
</div>
</div>

<!-- Scanner Tab - HARDWARE BARCODE SCANNER -->
<div id="scanner" class="tab-content">
<h2>üî∑ Multi-Barcode Scanner Station</h2>

<div class="scanner-container">
    <div style="font-size:4rem;margin-bottom:15px;">üîçüìä</div>
    <h3 style="margin:0 0 10px 0;">Hardware Barcode Scanner Ready</h3>
    <p style="opacity:0.9;margin-bottom:20px;">Use your USB/Bluetooth barcode scanner to scan multiple bottles quickly</p>

    <div class="scanner-status active" id="scanner-status">
        üü¢ Scanner Active - Ready to Scan
    </div>

    <div style="margin-top:25px;">
        <label style="display:block;margin-bottom:10px;font-weight:bold;font-size:18px;">üì± Scan Barcode Here:</label>
        <input type="text" 
               id="barcode-scanner-input" 
               class="barcode-input-large" 
               placeholder="Keep focused, scan barcodes..." 
               autocomplete="off"
               autofocus>
        <p style="font-size:14px;opacity:0.8;margin-top:10px;">üí° Tip: Input stays focused automatically. Scan bottles continuously.</p>
    </div>
</div>

<div class="scanned-list" id="scanned-barcodes-list">
    <h3 style="color:#2196F3;margin-top:0;">üìã Scanned Barcodes Queue (<span id="scanned-count">0</span>)</h3>
    <div id="scanned-items-container">
        <p class="small" style="text-align:center;padding:30px;color:#6c757d;">
            <span style="font-size:3rem;display:block;margin-bottom:10px;">üì¶</span>
            No barcodes scanned yet.<br>Scan a barcode with your device to begin.
        </p>
    </div>
</div>

<div class="batch-actions">
    <button class="btn btn-success" onclick="batchRefill()">üîÑ Batch Refill All (<span id="batch-refill-count">0</span>)</button>
    <button class="btn btn-warning" onclick="batchDeliver()">üöö Batch Deliver All (<span id="batch-deliver-count">0</span>)</button>
    <button class="btn btn-secondary" onclick="batchReturn()">‚Ü©Ô∏è Batch Return All (<span id="batch-return-count">0</span>)</button>
    <button class="btn btn-danger" onclick="clearAllScanned()">üóëÔ∏è Clear All</button>
</div>

</div>

<!-- Inventory Tab -->
<div id="inventory" class="tab-content">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;margin-bottom:25px;">
<h2>üì¶ Inventory Management</h2>
<div id="add-bottle-btn-container"></div>
</div>

<div class="search-row">
<input type="text" id="search-bottles" class="search-input" placeholder="üîç Search bottles..." onkeyup="searchBottles()">
<select id="filter-status" onchange="filterBottles()" style="padding:12px;border-radius:25px;border:2px solid #e9ecef;">
<option value="">All Statuses</option>
<option value="available">Available</option>
<option value="with-client">With Client</option>
<option value="needs-refill">Needs Refill</option>
<option value="maintenance">Maintenance</option>
</select>
</div>

<div id="bottle-inventory" class="bottle-grid"></div>
</div>

<!-- Clients Tab -->
<div id="clients" class="tab-content">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;margin-bottom:25px;">
<h2>üë• Client Management</h2>
<div id="add-client-btn-container"></div>
</div>

<div class="search-row">
<input type="text" id="search-clients" class="search-input" placeholder="üîç Search clients..." onkeyup="searchClients()">
</div>

<div id="client-list" class="bottle-grid"></div>
</div>

<!-- Reports Tab -->
<div id="reports" class="tab-content">
<h2>üìä Reports & Analytics</h2>

<div class="search-row">
<input type="date" id="report-start" style="padding:12px;border-radius:10px;border:2px solid #e9ecef;">
<input type="date" id="report-end" style="padding:12px;border-radius:10px;border:2px solid #e9ecef;">
<button class="btn" onclick="generateReport()">üìà Generate Report</button>
<button class="btn btn-success" onclick="exportToExcel()">üì• Export to Excel</button>
</div>

<div id="reports-content" style="margin-top:25px;">
<div style="background:rgba(255,255,255,0.8);border-radius:15px;padding:25px;">
<h3>üìã Summary Report</h3>
<div id="report-summary">
<p class="small">Select date range and click "Generate Report"</p>
</div>
</div>
</div>
</div>

<!-- Users Tab -->
<div id="users" class="tab-content">
<h2>üë• User Management</h2>

<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;margin-bottom:25px;">
    <div style="display:flex;gap:15px;flex-wrap:wrap;">
        <span style="padding:10px 20px;background:rgba(33,150,243,0.1);border-radius:10px;color:#2196F3;font-weight:bold;">
            Total Users: <span id="total-users">0</span>
        </span>
        <span style="padding:10px 20px;background:rgba(255,193,7,0.1);border-radius:10px;color:#856404;font-weight:bold;">
            Pending: <span id="pending-requests">0</span>
        </span>
    </div>
</div>

<div id="access-requests-section" style="margin-bottom:30px;">
    <h3>üìã Pending Access Requests</h3>
    <div id="access-requests-list" style="background:rgba(255,255,255,0.8);border-radius:15px;padding:20px;margin-top:15px;">
        <p class="small">No pending requests</p>
    </div>
</div>

<h3>‚úÖ Active Users</h3>
<div id="users-list" class="bottle-grid"></div>
</div>
</div>

<!-- Modals -->
<div id="add-client-modal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeClientModal()">√ó</span>
<h2>‚ûï Add New Client</h2>
<div style="display:flex;flex-direction:column;gap:15px;margin-top:20px;">
<input type="text" id="new-client-name" placeholder="Client Name">
<input type="tel" id="new-client-phone" placeholder="Phone Number">
<input type="text" id="new-client-address" placeholder="Address (optional)">
<textarea id="new-client-notes" placeholder="Notes (optional)" style="resize:vertical;min-height:80px;"></textarea>
<button class="btn btn-success" onclick="createNewClient()">‚úÖ Create Client</button>
</div>
</div>
</div>

<div id="delivery-modal" class="modal">
<div class="modal-content" style="max-width:500px;">
<span class="close" onclick="closeDeliveryModal()">√ó</span>
<h2>üöö Batch Deliver Bottles</h2>
<div style="display:flex;flex-direction:column;gap:15px;margin-top:20px;">

<div style="display:flex;gap:10px;margin-bottom:10px;">
<button class="btn btn-sm" id="existing-client-btn" onclick="toggleClientMode('existing')" style="flex:1;">Existing Client</button>
<button class="btn btn-sm btn-secondary" id="new-client-btn" onclick="toggleClientMode('new')" style="flex:1;">New Client</button>
</div>

<div id="existing-client-section">
<input type="text" id="delivery-client-search" placeholder="üîç Search client..." 
       style="width:100%;margin-bottom:10px;"
       oninput="filterDeliveryClients()">
<select id="delivery-client-select" size="5" style="width:100%;">
<option value="">Select Client</option>
</select>
</div>

<div id="new-client-section" style="display:none;flex-direction:column;gap:15px;">
<input type="text" id="delivery-new-client-name" placeholder="Client Name *">
<input type="tel" id="delivery-new-client-phone" placeholder="Phone Number *">
<input type="text" id="delivery-new-client-address" placeholder="Address (optional)">
<textarea id="delivery-new-client-notes" placeholder="Notes (optional)" style="resize:vertical;min-height:60px;"></textarea>
</div>

<input type="date" id="delivery-date">
<input type="time" id="delivery-time">
<textarea id="delivery-notes" placeholder="Delivery notes (optional)" style="resize:vertical;min-height:80px;"></textarea>
<button class="btn btn-success" onclick="confirmBatchDelivery()">‚úÖ Confirm Batch Delivery</button>
</div>
</div>
</div>

<script>
// ============================================
// GLOBAL VARIABLES
// ============================================

const STORAGE_KEY = 'bottleAppData_v3';
const SUPABASE_URL = 'https://oqvrssqsbwxxijhnneev.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xdnJzc3FzYnd4eGlqaG5uZWV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxODEzOTMsImV4cCI6MjA3NDc1NzM5M30.lh7LKucWlSaoC54d6yCb8bHSR3OHkBTbnm4ozWdRFag';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;
let users = [
    {
        id: 'admin_001',
        username: 'admin',
        password: '1234',
        role: 'admin',
        name: 'Administrator',
        created: new Date().toISOString(),
        active: true
    },
    {
        id: 'manager_001',
        username: 'manager',
        password: '1234',
        role: 'manager',
        name: 'Store Manager',
        created: new Date().toISOString(),
        active: true
    },
    {
        id: 'driver_001',
        username: 'driver',
        password: '1234',
        role: 'driver',
        name: 'Driver',
        created: new Date().toISOString(),
        active: true
    },
    {
        id: 'worker_001',
        username: 'worker',
        password: '1234',
        role: 'worker',
        name: 'Store Worker',
        created: new Date().toISOString(),
        active: true
    }
];
let accessRequests = [];

let bottles = [];
let clients = [];
let activityLog = [];
let deliveryClientMode = 'existing';

// MULTI-BARCODE SCANNER VARIABLES
let scannedBarcodes = [];

// Increase limit to 500 barcodes
const MAX_BARCODES = 500;

// Fix: update addScannedBarcode and paste handler to use MAX_BARCODES
function addScannedBarcode(barcode) {
    if (scannedBarcodes.length >= MAX_BARCODES) {
        showNotification(`‚ö†Ô∏è Maximum ${MAX_BARCODES} barcodes allowed per batch!`, 'warning');
        return;
    }
    if (scannedBarcodes.includes(barcode)) {
        showNotification(`‚ö†Ô∏è Bottle ${barcode} already in queue!`, 'warning');
        return;
    }
    scannedBarcodes.push(barcode);
    updateScannedList();
    showNotification(`‚úÖ Bottle ${barcode} added to queue`, 'success');
    playBeep();
}

// Fix: allow pasting up to 500 barcodes at once
document.getElementById('barcode-scanner-input').addEventListener('paste', function(e) {
    e.preventDefault();
    const pasted = (e.clipboardData || window.clipboardData).getData('text');
    const codes = pasted.split(/[\s,;\n]+/)
        .map(code => code.replace(/[^0-9]/g, ''))
        .filter(code => code.length >= 6);
    let added = 0;
    codes.forEach(code => {
        if (scannedBarcodes.length < MAX_BARCODES && !scannedBarcodes.includes(code)) {
            scannedBarcodes.push(code);
            added++;
        }
    });
    updateScannedList();
    showNotification(`‚úÖ ${added} barcode(s) added from paste`, 'success');
    this.value = '';
});

const DELETE_PASSWORD = '1234';
const REPORTS_PASSWORD = '1234';
let reportsUnlocked = false;

// ============================================
// MULTI-BARCODE SCANNER FUNCTIONS
// ============================================

function initBarcodeScanner() {
    const input = document.getElementById('barcode-scanner-input');
    if (!input) return;

    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const barcode = this.value.trim().replace(/[^0-9]/g, '');

            if (barcode.length >= 6) {
                addScannedBarcode(barcode);
                this.value = '';
            }

            setTimeout(() => this.focus(), 100);
        }
    });

    input.addEventListener('blur', function() {
        setTimeout(() => this.focus(), 200);
    });

    input.focus();
}

function addScannedBarcode(barcode) {
    if (scannedBarcodes.length >= MAX_BARCODES) {
        showNotification(`‚ö†Ô∏è Maximum ${MAX_BARCODES} barcodes allowed per batch!`, 'warning');
        return;
    }
    if (scannedBarcodes.includes(barcode)) {
        showNotification(`‚ö†Ô∏è Bottle ${barcode} already in queue!`, 'warning');
        return;
    }
    scannedBarcodes.push(barcode);
    updateScannedList();
    showNotification(`‚úÖ Bottle ${barcode} added to queue`, 'success');
    playBeep();
}

// Optionally, allow pasting multiple barcodes at once
document.getElementById('barcode-scanner-input').addEventListener('paste', function(e) {
    e.preventDefault();
    const pasted = (e.clipboardData || window.clipboardData).getData('text');
    const codes = pasted.split(/[\s,;\n]+/).map(code => code.replace(/[^0-9]/g, '')).filter(code => code.length >= 6);
    let added = 0;
    codes.forEach(code => {
        if (scannedBarcodes.length < MAX_BARCODES && !scannedBarcodes.includes(code)) {
            scannedBarcodes.push(code);
            added++;
        }
    });
    updateScannedList();
    showNotification(`‚úÖ ${added} barcode(s) added from paste`, 'success');
    this.value = '';
});

function updateScannedList() {
    const container = document.getElementById('scanned-items-container');
    const count = document.getElementById('scanned-count');

    count.textContent = scannedBarcodes.length;
    document.getElementById('batch-refill-count').textContent = scannedBarcodes.length;
    document.getElementById('batch-deliver-count').textContent = scannedBarcodes.length;
    document.getElementById('batch-return-count').textContent = scannedBarcodes.length;

    if (scannedBarcodes.length === 0) {
        container.innerHTML = `
            <p class="small" style="text-align:center;padding:30px;color:#6c757d;">
                <span style="font-size:3rem;display:block;margin-bottom:10px;">üì¶</span>
                No barcodes scanned yet.<br>Scan a barcode to begin.
            </p>
        `;
        return;
    }

    container.innerHTML = scannedBarcodes.map((barcode, index) => {
        const bottle = bottles.find(b => b.id === barcode);
        let statusText = 'New Bottle';
        let statusClass = '';

        if (bottle) {
            statusText = `Status: ${bottle.status.toUpperCase().replace('-', ' ')}`;
        }

        return `
            <div class="scanned-item ${statusClass}">
                <div>
                    <div class="scanned-item-code">${barcode}</div>
                    <div class="scanned-item-status">${statusText}</div>
                </div>
                <button class="remove-btn" onclick="removeScannedBarcode(${index})" title="Remove">‚úï</button>
            </div>
        `;
    }).join('');
}

function removeScannedBarcode(index) {
    const barcode = scannedBarcodes[index];
    scannedBarcodes.splice(index, 1);
    updateScannedList();
    showNotification(`Removed bottle ${barcode} from queue`, 'info');
}

function clearAllScanned() {
    if (scannedBarcodes.length === 0) {
        alert('No barcodes to clear');
        return;
    }

    if (confirm(`Clear all ${scannedBarcodes.length} scanned barcodes?`)) {
        scannedBarcodes = [];
        updateScannedList();
        showNotification('Queue cleared', 'info');
    }
}

function batchRefill() {
    if (scannedBarcodes.length === 0) {
        alert('No barcodes scanned. Please scan bottles first.');
        return;
    }

    if (!confirm(`Refill ${scannedBarcodes.length} bottles?`)) {
        return;
    }

    let processed = 0;
    let created = 0;

    scannedBarcodes.forEach(barcode => {
        let bottle = bottles.find(b => b.id === barcode);

        if (!bottle) {
            bottle = createNewBottleRecord(barcode, 'available');
            created++;
        } else {
            bottle.refillCount = (bottle.refillCount || 0) + 1;
            bottle.status = 'available';
            bottle.clientId = '';
            bottle.clientName = '';
            bottle.clientPhone = '';
            bottle.lastUpdated = new Date().toISOString();
            bottle.history = bottle.history || [];
            bottle.history.push({
                action: `Batch Refilled (Count: ${bottle.refillCount}) by ${currentUser.name}`,
                timestamp: new Date().toISOString()
            });
        }
        processed++;
    });

    addActivity(`Batch refill: ${processed} bottles (${created} new) by ${currentUser.name}`);
    saveData();
    updateAllDisplays();
    scannedBarcodes = [];
    updateScannedList();

    alert(`‚úÖ Success!\n\n${processed} bottles refilled\n${created} new bottles added`);
}

function batchDeliver() {
    if (scannedBarcodes.length === 0) {
        alert('No barcodes scanned. Please scan bottles first.');
        return;
    }

    const unavailable = scannedBarcodes.filter(barcode => {
        const bottle = bottles.find(b => b.id === barcode);
        return bottle && bottle.status !== 'available';
    });

    if (unavailable.length > 0) {
        alert(`‚ùå Cannot deliver!\n\n${unavailable.length} bottle(s) not available:\n${unavailable.join(', ')}\n\nOnly available bottles can be delivered.`);
        return;
    }

    populateClientDropdowns();
    toggleClientMode('existing');
    document.getElementById('delivery-date').value = new Date().toISOString().split('T')[0];
    document.getElementById('delivery-time').value = new Date().toTimeString().slice(0,5);
    document.getElementById('delivery-modal').style.display = 'flex';
}

function batchReturn() {
    if (scannedBarcodes.length === 0) {
        alert('No barcodes scanned. Please scan bottles first.');
        return;
    }

    if (!confirm(`Mark ${scannedBarcodes.length} bottles as returned (needs refill)?`)) {
        return;
    }

    let processed = 0;

    scannedBarcodes.forEach(barcode => {
        let bottle = bottles.find(b => b.id === barcode);

        if (!bottle) {
            bottle = createNewBottleRecord(barcode, 'needs-refill');
        } else {
            bottle.status = 'needs-refill';
            bottle.returnDate = new Date().toISOString();
            bottle.lastUpdated = new Date().toISOString();
            bottle.history = bottle.history || [];
            bottle.history.push({
                action: `Batch returned, needs refill - by ${currentUser.name}`,
                timestamp: new Date().toISOString()
            });
        }
        processed++;
    });

    addActivity(`Batch return: ${processed} bottles for refill by ${currentUser.name}`);
    saveData();
    updateAllDisplays();
    scannedBarcodes = [];
    updateScannedList();

    alert(`‚úÖ Success!\n\n${processed} bottles marked as "Needs Refill"`);
}

function showNotification(message, type) {
    const colors = {
        success: '#28a745',
        warning: '#ffc107',
        error: '#dc3545',
        info: '#2196F3'
    };

    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type] || colors.info};
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 9999;
        font-weight: bold;
        animation: fadeIn 0.3s;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.3s';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

function playBeep() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = 800;
        oscillator.type = 'sine';

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1);
    } catch (e) {
        // Audio not supported, silently fail
    }
}


// ============================================
// AUTHENTICATION FUNCTIONS
// ============================================

async function loadUsers() {
    try {
        const { data } = await supabase
            .from('bottle_data')
            .select('users')
            .eq('id', 'main')
            .single();

        if (data && Array.isArray(data.users) && data.users.length > 0) {
            users = data.users;
        }
    } catch (error) {
        console.error('Error loading users:', error);
    }
}

async function saveUsers() {
    try {
        const { data: existing } = await supabase
            .from('bottle_data')
            .select('*')
            .eq('id', 'main')
            .single();

        await supabase
            .from('bottle_data')
            .upsert({
                ...existing,
                id: 'main',
                users: users,
                last_updated: new Date().toISOString()
            });
    } catch (error) {
        console.error('Error saving users:', error);
    }
}

function checkAuth() {
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        return true;
    }
    return false;
}

function login(username, password) {
    const user = users.find(u => u.username === username && u.password === password && u.active);
    if (user) {
        currentUser = user;
        localStorage.setItem('currentUser', JSON.stringify(user));
        return true;
    }
    return false;
}

function logout() {
    if (confirm('Are you sure you want to logout?')) {
        currentUser = null;
        localStorage.removeItem('currentUser');
        reportsUnlocked = false;
        location.reload();
    }
}

function hasPermission(tab) {
    if (!currentUser) return false;

    const permissions = {
        'admin': ['dashboard', 'scanner', 'inventory', 'clients', 'reports', 'users'],
        'manager': ['dashboard', 'scanner', 'inventory', 'clients', 'reports'],
        'driver': ['scanner', 'inventory', 'clients'],
        'worker': ['scanner']
    };

    return permissions[currentUser.role]?.includes(tab) || false;
}

function attemptLogin() {
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value;

    if (!username || !password) {
        alert('Please enter username and password');
        return;
    }

    if (login(username, password)) {
        document.getElementById('login-screen').style.display = 'none';
        initializeApp();
        showUserInfo();
        setupDefaultDates();
    } else {
        alert('‚ùå Invalid username or password!');
    }
}

function showRequestAccess() {
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('request-form').style.display = 'block';
}

function showLoginForm() {
    document.getElementById('login-form').style.display = 'block';
    document.getElementById('request-form').style.display = 'none';
}

async function submitAccessRequest() {
    const name = document.getElementById('req-name').value.trim();
    const username = document.getElementById('req-username').value.trim();
    const password = document.getElementById('req-password').value;
    const role = document.getElementById('req-role').value;

    if (!name || !username || !password || !role) {
        alert('Please fill in all fields');
        return;
    }

    if (users.find(u => u.username === username)) {
        alert('‚ùå Username already exists!');
        return;
    }

    const request = {
        id: 'req_' + Date.now(),
        name: name,
        username: username,
        password: password,
        role: role,
        requested: new Date().toISOString(),
        status: 'pending'
    };

    accessRequests.push(request);
    await saveUsers();

    alert('‚úÖ Access request submitted! You will be able to login once approved.');
    showLoginForm();

    document.getElementById('req-name').value = '';
    document.getElementById('req-username').value = '';
    document.getElementById('req-password').value = '';
    document.getElementById('req-role').value = '';
}

function showUserInfo() {
    const header = document.querySelector('.header');

    const existingBadge = header.querySelector('.user-info-badge');
    if (existingBadge) existingBadge.remove();

    const roleIcons = {
        'admin': 'üëë',
        'manager': 'üè™',
        'driver': 'üöö',
        'worker': 'üë∑'
    };

    const userInfo = document.createElement('div');
    userInfo.className = 'user-info-badge';
    userInfo.innerHTML = `
        <div>
            <strong>${roleIcons[currentUser.role]} ${currentUser.name}</strong><br>
            <span style="font-size:13px;opacity:0.9;">${currentUser.role.toUpperCase()}</span>
        </div>
        <button onclick="logout()" class="logout-btn">üö™ Logout</button>
    `;
    header.appendChild(userInfo);

    const allTabs = ['dashboard', 'scanner', 'inventory', 'clients', 'reports', 'users'];
    allTabs.forEach(tab => {
        const tabBtn = document.getElementById(`${tab}-tab`);

        if (hasPermission(tab)) {
            if (tabBtn) tabBtn.style.display = 'inline-block';
        } else {
            if (tabBtn) tabBtn.style.display = 'none';
        }
    });

    const firstAllowedTab = allTabs.find(tab => hasPermission(tab));
    if (firstAllowedTab) {
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));

        document.getElementById(firstAllowedTab).classList.add('active');
        const tabBtn = document.getElementById(`${firstAllowedTab}-tab`);
        if (tabBtn) tabBtn.classList.add('active');
    }
}

async function initializeApp() {
    await loadData();
    updateAllDisplays();
}

function setupDefaultDates() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('report-start').value = today;
    document.getElementById('report-end').value = today;
}

// ============================================
// DATA MANAGEMENT
// ============================================

async function saveData() {
    try {
        const { data, error } = await supabase
            .from('bottle_data')
            .upsert({
                id: 'main',
                bottles: bottles,
                clients: clients,
                activity_log: activityLog,
                users: users,
                last_updated: new Date().toISOString()
            });

        if (error) throw error;

        localStorage.setItem(STORAGE_KEY, JSON.stringify({
            bottles: bottles,
            clients: clients,
            activityLog: activityLog,
            lastUpdated: new Date().toISOString()
        }));

    } catch (error) {
        console.error('Error saving data:', error);
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
            bottles: bottles,
            clients: clients,
            activityLog: activityLog,
            lastUpdated: new Date().toISOString()
        }));
    }
}

async function loadData() {
    try {
        const { data, error } = await supabase
            .from('bottle_data')
            .select('*')
            .eq('id', 'main')
            .single();

        if (data) {
            bottles = Array.isArray(data.bottles) ? data.bottles : [];
            clients = Array.isArray(data.clients) ? data.clients : [];
            activityLog = Array.isArray(data.activity_log) ? data.activity_log : [];
        } else {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (raw) {
                const localData = JSON.parse(raw);
                bottles = localData.bottles || [];
                clients = localData.clients || [];
                activityLog = localData.activityLog || [];
                await saveData();
            }
        }
    } catch (error) {
        console.error('Error loading data:', error);
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
            const localData = JSON.parse(raw);
            bottles = localData.bottles || [];
            clients = localData.clients || [];
            activityLog = localData.activityLog || [];
        }
    }
}

function createNewBottleRecord(bottleId, status) {
    const newBottle = {
        id: bottleId,
        status: status,
        clientId: '',
        clientName: '',
        clientPhone: '',
        refillCount: status === 'available' ? 1 : 0,
        deliveryCount: 0,
        lastUpdated: new Date().toISOString(),
        created: new Date().toISOString(),
        history: [{
            action: `Bottle created with status: ${status} by ${currentUser.name}`,
            timestamp: new Date().toISOString()
        }]
    };

    bottles.push(newBottle);
    return newBottle;
}

function addActivity(message) {
    activityLog.unshift({
        action: message,
        timestamp: new Date().toISOString()
    });

    if (activityLog.length > 100) {
        activityLog = activityLog.slice(0, 100);
    }

    saveData();
    updateDashboard();
}

function updateClientBottleCounts() {
    clients.forEach(client => {
        client.bottleCount = bottles.filter(bottle => bottle.clientId === client.id).length;
    });
}


// ============================================
// UI DISPLAY FUNCTIONS
// ============================================

function showTab(event, tabName) {
    if (tabName === 'reports' && !reportsUnlocked) {
        const password = prompt('üîí Reports section is protected.\n\nEnter password to access:');

        if (password !== REPORTS_PASSWORD) {
            alert('‚ùå Incorrect password! Access denied.');
            return;
        }

        reportsUnlocked = true;
        alert('‚úÖ Access granted!');
    }

    if (!hasPermission(tabName)) {
        alert('‚ùå You don\'t have permission to access this section!');
        return;
    }

    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

    if (event && event.target) {
        event.target.classList.add('active');
    }
    document.getElementById(tabName).classList.add('active');

    if (tabName === 'dashboard') updateDashboard();
    if (tabName === 'scanner') setTimeout(initBarcodeScanner, 300);
    if (tabName === 'inventory') updateInventoryDisplay();
    if (tabName === 'clients') updateClientDisplay();
    if (tabName === 'reports') updateReports();
}

function updateAllDisplays() {
    updateDashboard();
    updateInventoryDisplay();
    updateClientDisplay();
    updateReports();
    populateClientDropdowns();
}

function updateDashboard() {
    const stats = {
        total: bottles.length,
        available: bottles.filter(b => b.status === 'available').length,
        withClient: bottles.filter(b => b.status === 'with-client').length,
        needsRefill: bottles.filter(b => b.status === 'needs-refill').length,
        maintenance: bottles.filter(b => b.status === 'maintenance').length,
        clients: clients.length
    };

    document.getElementById('total-bottles').textContent = stats.total;
    document.getElementById('available-bottles').textContent = stats.available;
    document.getElementById('with-client-bottles').textContent = stats.withClient;
    document.getElementById('needs-refill-bottles').textContent = stats.needsRefill;
    document.getElementById('maintenance-bottles').textContent = stats.maintenance;
    document.getElementById('total-clients').textContent = stats.clients;

    const activityDiv = document.getElementById('recent-activity');
    if (activityLog.length > 0) {
        activityDiv.innerHTML = activityLog.slice(0, 15).map(activity => `
            <div style="padding:12px;margin:8px 0;background:rgba(33,150,243,0.05);border-radius:10px;border-left:4px solid #2196F3;">
                <div style="font-weight:600;color:#2196F3;margin-bottom:5px;">${activity.action}</div>
                <div class="small" style="color:#6c757d;">${new Date(activity.timestamp).toLocaleString()}</div>
            </div>
        `).join('');
    } else {
        activityDiv.innerHTML = '<p class="small">No recent activity</p>';
    }

    const alertsDiv = document.getElementById('alerts');
    const alerts = [];

    const needsRefill = bottles.filter(b => b.status === 'needs-refill').length;
    const maintenance = bottles.filter(b => b.status === 'maintenance').length;

    if (needsRefill > 0) {
        alerts.push(`${needsRefill} bottle(s) need refilling`);
    }
    if (maintenance > 0) {
        alerts.push(`${maintenance} bottle(s) need maintenance`);
    }

    if (alerts.length > 0) {
        alertsDiv.innerHTML = alerts.map(alert => `
            <div style="padding:12px;margin:8px 0;background:rgba(255,193,7,0.1);border-radius:10px;border-left:4px solid #ffc107;color:#856404;">
                ‚ö†Ô∏è ${alert}
            </div>
        `).join('');
    } else {
        alertsDiv.innerHTML = '<p class="small">No alerts</p>';
    }
}

function updateInventoryDisplay() {
    const inventoryDiv = document.getElementById('bottle-inventory');
    const searchTerm = (document.getElementById('search-bottles')?.value || '').toLowerCase();
    const statusFilter = document.getElementById('filter-status')?.value || '';

    let filteredBottles = bottles.filter(bottle => {
        const matchesSearch = !searchTerm || 
            bottle.id.toLowerCase().includes(searchTerm) ||
            (bottle.clientName && bottle.clientName.toLowerCase().includes(searchTerm)) ||
            bottle.status.toLowerCase().includes(searchTerm);

        const matchesStatus = !statusFilter || bottle.status === statusFilter;

        return matchesSearch && matchesStatus;
    });

    if (filteredBottles.length > 0) {
        inventoryDiv.innerHTML = filteredBottles.map(bottle => `
            <div class="bottle-card">
                <div class="bottle-id">Bottle #${bottle.id}</div>
                <div class="status ${bottle.status}">${bottle.status.replace('-', ' ').toUpperCase()}</div>
                <div style="margin:15px 0;">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
                        <div><strong>üîÑ Refills:</strong> ${bottle.refillCount || 0}</div>
                        <div><strong>üöö Deliveries:</strong> ${bottle.deliveryCount || 0}</div>
                    </div>
                    ${bottle.clientName ? `
                        <div style="background:rgba(40,167,69,0.1);padding:10px;border-radius:8px;margin:10px 0;">
                            <strong>üë§ Client:</strong> ${bottle.clientName}<br>
                            <strong>üìû Phone:</strong> ${bottle.clientPhone}
                        </div>
                    ` : '<div><strong>üë§ Client:</strong> None</div>'}
                    <div style="margin-top:10px;"><strong>üìÖ Updated:</strong> ${new Date(bottle.lastUpdated).toLocaleString()}</div>
                </div>
            </div>
        `).join('');
    } else {
        inventoryDiv.innerHTML = '<div style="text-align:center;padding:40px;color:#6c757d;">No bottles found</div>';
    }
}

function searchBottles() {
    updateInventoryDisplay();
}

function filterBottles() {
    updateInventoryDisplay();
}

function updateClientDisplay() {
    updateClientBottleCounts();
    const clientDiv = document.getElementById('client-list');
    const searchTerm = (document.getElementById('search-clients')?.value || '').toLowerCase();

    let filteredClients = clients.filter(client => {
        return !searchTerm || 
            client.name.toLowerCase().includes(searchTerm) ||
            client.phone.toLowerCase().includes(searchTerm) ||
            (client.address && client.address.toLowerCase().includes(searchTerm));
    });

    if (filteredClients.length > 0) {
        clientDiv.innerHTML = filteredClients.map(client => `
            <div class="bottle-card">
                <div class="bottle-id">üë§ ${client.name}</div>
                <div class="status with-client">CLIENT</div>
                <div style="margin:15px 0;">
                    <div><strong>üìû Phone:</strong> ${client.phone}</div>
                    ${client.address ? `<div><strong>üìç Address:</strong> ${client.address}</div>` : ''}
                    <div><strong>üç∂ Bottles:</strong> ${client.bottleCount || 0}</div>
                    ${client.notes ? `<div style="margin-top:10px;"><strong>üìù Notes:</strong> ${client.notes}</div>` : ''}
                    <div style="margin-top:10px;"><strong>üìÖ Added:</strong> ${new Date(client.created).toLocaleString()}</div>
                </div>
            </div>
        `).join('');
    } else {
        clientDiv.innerHTML = '<div style="text-align:center;padding:40px;color:#6c757d;">No clients found</div>';
    }
}

function searchClients() {
    updateClientDisplay();
}

// Show login screen if not authenticated
window.onload = function() {
    if (!checkAuth()) {
        document.getElementById('login-screen').style.display = 'flex';
    } else {
        document.getElementById('login-screen').style.display = 'none';
        initializeApp();
        showUserInfo();
        setupDefaultDates();
    }
    // Always initialize scanner input
    setTimeout(initBarcodeScanner, 300);
};

function closeClientModal() {
    document.getElementById('add-client-modal').style.display = 'none';
}
function closeDeliveryModal() {
    document.getElementById('delivery-modal').style.display = 'none';
}
function populateClientDropdowns() {
    // Dummy implementation for dropdowns
    const select = document.getElementById('delivery-client-select');
    if (!select) return;
    select.innerHTML = '<option value="">Select Client</option>' +
        clients.map(client => `<option value="${client.id}">${client.name}</option>`).join('');
}
function toggleClientMode(mode) {
    deliveryClientMode = mode;
    document.getElementById('existing-client-section').style.display = mode === 'existing' ? 'block' : 'none';
    document.getElementById('new-client-section').style.display = mode === 'new' ? 'flex' : 'none';
}

function updateReports() {
    // Dummy implementation
    document.getElementById('report-summary').innerHTML = '<p class="small">Select date range and click "Generate Report"</p>';
}
function generateReport() {
    alert('Report generation not implemented in this demo.');
}
function exportToExcel() {
    alert('Export to Excel not implemented in this demo.');
}
</script>
</body>
</html>

