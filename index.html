<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bottle Refill Tracking System</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        .role-badge {
            background: rgba(255,215,0,0.9);
            color: #333;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .connection-status {
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .connection-status.online {
            background: rgba(40,167,69,0.9);
        }

        .connection-status.offline {
            background: rgba(220,53,69,0.9);
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .login-screen {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .login-screen h2 {
            color: #667eea;
            margin-bottom: 30px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        .worker-interface {
            padding: 40px;
            text-align: center;
        }

        .worker-interface h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .worker-subtitle {
            color: #888;
            margin-bottom: 40px;
            font-size: 16px;
        }

        .scanner-box {
            max-width: 600px;
            margin: 0 auto;
            background: #f8f9fa;
            padding: 50px 40px;
            border-radius: 12px;
            border: 3px dashed #667eea;
        }

        .scanner-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .barcode-input {
            width: 100%;
            padding: 20px;
            font-size: 24px;
            border: 3px solid #667eea;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
            font-weight: 600;
            letter-spacing: 2px;
        }

        .auto-submit-info {
            color: #667eea;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
        }

        .recent-scans {
            max-width: 600px;
            margin: 40px auto 0;
            text-align: left;
        }

        .recent-scans h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .scan-item {
            background: white;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 5px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .scan-item-left {
            flex: 1;
        }

        .scan-item-id {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .scan-time {
            color: #888;
            font-size: 13px;
        }

        .scan-count {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 16px;
        }

        .admin-interface {
            display: flex;
            height: calc(100vh - 80px);
        }

        .admin-sidebar {
            width: 250px;
            background: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            padding: 20px 0;
        }

        .nav-item {
            padding: 15px 30px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #555;
        }

        .nav-item:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .nav-item.active {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
            border-left: 4px solid #667eea;
            font-weight: 600;
        }

        .admin-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .kpi-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h3 {
            color: #333;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-admin {
            background: #ffd700;
            color: #333;
        }

        .badge-worker {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-expired {
            background: #f8d7da;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #888;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            animation: slideIn 0.3s ease;
            display: none;
            min-width: 250px;
        }

        .toast.active {
            display: block;
        }

        .toast.success {
            border-left: 4px solid #28a745;
        }

        .toast.error {
            border-left: 4px solid #dc3545;
        }

        .toast.warning {
            border-left: 4px solid #ffc107;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-input:focus {
            outline: none;
            border-color: #667eea;
        }

        select.filter-input {
            cursor: pointer;
        }

        .hidden {
            display: none !important;
        }

        .life-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .life-fill {
            height: 100%;
            transition: width 0.3s;
        }

        .life-fill.healthy {
            background: #28a745;
        }

        .life-fill.warning {
            background: #ffc107;
        }

        .life-fill.critical {
            background: #dc3545;
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-screen">
        <h2>üîê Bottle Refill System</h2>
        <div class="form-group">
            <label>Username</label>
            <input type="text" id="loginUsername" placeholder="Enter username">
        </div>
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="loginPassword" placeholder="Enter password">
        </div>
        <button class="login-btn" onclick="login()">Login</button>
    </div>

    <div id="appContainer" class="container hidden">
        <div class="header">
            <h1>üîç Bottle Refill Tracking</h1>
            <div class="user-info">
                <div class="connection-status" id="connectionStatus">Checking...</div>
                <div class="user-badge">üë§ <span id="currentUsername"></span></div>
                <div class="role-badge" id="currentRole"></div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div id="workerInterface" class="worker-interface hidden">
            <h2>Scan Bottle Barcode</h2>
            <p class="worker-subtitle">Scanner will auto-submit when barcode is scanned</p>
            <div class="scanner-box">
                <div class="scanner-icon">üì∑</div>
                <input 
                    type="text" 
                    id="workerBarcodeInput" 
                    class="barcode-input" 
                    placeholder="Ready to scan..."
                    autofocus
                >
                <p class="auto-submit-info">‚úì Auto-submits at 6+ characters</p>
            </div>

            <div class="recent-scans">
                <h3>Recent Scans (Last 10)</h3>
                <div id="recentScansList"></div>
            </div>
        </div>

        <div id="adminInterface" class="admin-interface hidden">
            <div class="admin-sidebar">
                <div class="nav-item active" data-section="dashboard" onclick="showAdminSection('dashboard')">
                    üìä Dashboard
                </div>
                <div class="nav-item" data-section="bottles" onclick="showAdminSection('bottles')">
                    üç∂ Bottles
                </div>
                <div class="nav-item" data-section="users" onclick="showAdminSection('users')">
                    üë• Users
                </div>
                <div class="nav-item" data-section="trace" onclick="showAdminSection('trace')">
                    üìã Activity Trace
                </div>
            </div>

            <div class="admin-content">
                <div id="dashboardSection" class="admin-section">
                    <h2>Dashboard Overview</h2>
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-label">Total Bottles</div>
                            <div class="kpi-value" id="kpiTotal">0</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Total Refills</div>
                            <div class="kpi-value" id="kpiTotalRefills">0</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Active Bottles</div>
                            <div class="kpi-value" id="kpiActive">0</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Expired</div>
                            <div class="kpi-value" id="kpiExpired">0</div>
                        </div>
                    </div>
                </div>

                <div id="bottlesSection" class="admin-section hidden">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>Bottle Refill History</h3>
                            <button class="btn-primary" onclick="showAddBottleModal()">+ Add Bottle</button>
                        </div>
                        <div class="filters">
                            <input type="text" class="filter-input" id="filterBottleId" placeholder="Search Bottle ID" oninput="filterBottles()">
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Bottle ID</th>
                                    <th>Total Refills</th>
                                    <th>Life Remaining</th>
                                    <th>Last Refill</th>
                                    <th>Last User</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bottlesTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="usersSection" class="admin-section hidden">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>User Management</h3>
                            <button class="btn-primary" onclick="showAddUserModal()">+ Add User</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Created</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="traceSection" class="admin-section hidden">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>Activity Trace Log</h3>
                            <button class="btn-primary" onclick="exportTrace()">üì• Export CSV</button>
                        </div>
                        <div class="filters">
                            <input type="text" class="filter-input" id="filterTraceUser" placeholder="Filter by user" oninput="filterTrace()">
                            <select class="filter-input" id="filterTraceAction" onchange="filterTrace()">
                                <option value="">All Actions</option>
                                <option value="login">Login</option>
                                <option value="refill">Refill</option>
                                <option value="duplicate">Duplicate Scan</option>
                                <option value="add_bottle">Add Bottle</option>
                                <option value="delete_bottle">Delete Bottle</option>
                                <option value="add_user">Add User</option>
                                <option value="delete_user">Delete User</option>
                            </select>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="traceTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New User</h3>
                <button class="close-btn" onclick="closeModal('addUserModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="newUsername" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="newPassword" placeholder="Enter password">
            </div>
            <div class="form-group">
                <label>Role</label>
                <select id="newUserRole">
                    <option value="worker">Worker</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <button class="btn-primary" onclick="addUser()">Create User</button>
        </div>
    </div>

    <div id="addBottleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Bottle</h3>
                <button class="close-btn" onclick="closeModal('addBottleModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Bottle ID (Barcode)</label>
                <input type="text" id="newBottleId" placeholder="Enter bottle barcode">
            </div>
            <button class="btn-primary" onclick="addBottle()">Add Bottle</button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY';

        let supabaseClient = null;
        let isOnline = false;

        // Try to initialize Supabase
        if (SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
            try {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('‚úÖ Supabase client created');
            } catch (error) {
                console.error('‚ùå Failed to create Supabase client:', error);
            }
        }

        // Global State - IN MEMORY ONLY
        let currentUser = null;
        let bottles = [];
        let users = [];
        let activityTrace = [];
        let recentScans = [];

        // Initialize
        async function init() {
            await checkConnection();
            await loadData();
            checkAutoLogin();
            setupAutoSubmit();
            updateConnectionStatus();
        }

        // Check Supabase connection
        async function checkConnection() {
            if (!supabaseClient) {
                isOnline = false;
                return;
            }

            try {
                const { data, error } = await supabaseClient.from('users').select('count');
                isOnline = !error;
                console.log(isOnline ? 'üåê Online - Connected to Supabase' : 'üì¥ Offline');
            } catch (error) {
                isOnline = false;
                console.log('üì¥ Offline - No connection');
            }
        }

        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                if (isOnline) {
                    statusEl.textContent = 'üåê Online';
                    statusEl.className = 'connection-status online';
                } else {
                    statusEl.textContent = 'üì¥ Offline';
                    statusEl.className = 'connection-status offline';
                }
            }
        }

        // AUTO-SUBMIT SETUP
        function setupAutoSubmit() {
            const input = document.getElementById('workerBarcodeInput');
            if (input) {
                input.addEventListener('input', function(e) {
                    const value = e.target.value.trim();
                    if (value.length >= 6) {
                        setTimeout(() => {
                            workerScan();
                        }, 100);
                    }
                });
            }
        }

        // Data Management - PRIORITIZE SUPABASE
        async function loadData() {
            if (isOnline && supabaseClient) {
                // ONLINE: Load from Supabase ONLY
                await loadDataFromSupabase();
            } else {
                // OFFLINE: Load from memory (empty on first load when offline)
                console.log('üì¥ Offline mode - Using in-memory data');
                showToast('Offline: Data will sync when online', 'warning');
            }
        }

        async function loadDataFromSupabase() {
            try {
                console.log('üì• Loading data from Supabase...');
                
                const { data: bottlesData, error: bottlesError } = await supabaseClient
                    .from('bottles')
                    .select('*');
                if (!bottlesError) {
                    bottles = bottlesData || [];
                    console.log(`‚úÖ Loaded ${bottles.length} bottles`);
                }

                const { data: usersData, error: usersError } = await supabaseClient
                    .from('users')
                    .select('*');
                if (!usersError) {
                    users = usersData || [];
                    console.log(`‚úÖ Loaded ${users.length} users`);
                }

                if (users.length === 0) {
                    await createDefaultAdmin();
                }

                const { data: traceData, error: traceError } = await supabaseClient
                    .from('activity_trace')
                    .select('*')
                    .order('timestamp', { ascending: false })
                    .limit(500);
                if (!traceError) {
                    activityTrace = traceData || [];
                    console.log(`‚úÖ Loaded ${activityTrace.length} activity records`);
                }

                // Load recent scans from last 10 activity traces
                recentScans = activityTrace
                    .filter(t => t.action === 'refill')
                    .slice(0, 10)
                    .map(t => {
                        const details = typeof t.details === 'string' ? JSON.parse(t.details) : t.details;
                        return {
                            bottle_id: details.bottle_id,
                            timestamp: t.timestamp,
                            refill_count: details.refill_count
                        };
                    });

            } catch (error) {
                console.error('‚ùå Error loading from Supabase:', error);
                isOnline = false;
                updateConnectionStatus();
            }
        }

        // Sync pending data when coming back online
        async function syncPendingData() {
            if (!isOnline || !supabaseClient) return;

            console.log('üîÑ Syncing pending data to Supabase...');

            try {
                // Get pending operations from localStorage
                const pendingOps = JSON.parse(localStorage.getItem('pendingOperations') || '[]');
                
                if (pendingOps.length === 0) {
                    console.log('‚úÖ No pending operations to sync');
                    return;
                }

                console.log(`üì§ Syncing ${pendingOps.length} pending operations...`);

                for (const op of pendingOps) {
                    try {
                        if (op.type === 'insert') {
                            await supabaseClient.from(op.table).insert([op.data]);
                        } else if (op.type === 'update') {
                            await supabaseClient
                                .from(op.table)
                                .update(op.data)
                                .match(op.match);
                        } else if (op.type === 'delete') {
                            await supabaseClient
                                .from(op.table)
                                .delete()
                                .match(op.match);
                        }
                        console.log(`‚úÖ Synced: ${op.type} on ${op.table}`);
                    } catch (error) {
                        console.error(`‚ùå Failed to sync operation:`, error);
                    }
                }

                // Clear pending operations
                localStorage.removeItem('pendingOperations');
                console.log('‚úÖ All pending data synced successfully');
                showToast('‚úÖ Synced offline data to database', 'success');

                // Reload fresh data from Supabase
                await loadDataFromSupabase();

            } catch (error) {
                console.error('‚ùå Error syncing pending data:', error);
            }
        }

        // Add operation to pending queue (when offline)
        function addPendingOperation(type, table, data, match = null) {
            const pendingOps = JSON.parse(localStorage.getItem('pendingOperations') || '[]');
            pendingOps.push({
                type,
                table,
                data,
                match,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('pendingOperations', JSON.stringify(pendingOps));
            console.log(`üìù Added pending ${type} operation on ${table}`);
        }

        async function createDefaultAdmin() {
            const defaultAdmin = {
                username: 'admin',
                password: 'admin123',
                role: 'admin',
                created_at: new Date().toISOString(),
                last_login: null
            };

            if (isOnline && supabaseClient) {
                const { data, error } = await supabaseClient
                    .from('users')
                    .insert([defaultAdmin])
                    .select();

                if (!error && data) {
                    users = data;
                }
            } else {
                users.push(defaultAdmin);
                addPendingOperation('insert', 'users', defaultAdmin);
            }
        }

        function checkAutoLogin() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showApp();
            }
        }

        // Login
        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showToast('Please enter username and password', 'error');
                return;
            }

            const user = users.find(u => u.username === username && u.password === password);

            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));

                if (isOnline && supabaseClient) {
                    await supabaseClient
                        .from('users')
                        .update({ last_login: new Date().toISOString() })
                        .eq('username', username);
                } else {
                    addPendingOperation('update', 'users', 
                        { last_login: new Date().toISOString() },
                        { username }
                    );
                }

                await logActivity('login', { username });
                showApp();
                showToast(`Welcome ${username}!`, 'success');
            } else {
                showToast('Invalid username or password', 'error');
            }
        }

        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            document.getElementById('currentUsername').textContent = currentUser.username;
            document.getElementById('currentRole').textContent = currentUser.role.toUpperCase();

            if (currentUser.role === 'admin') {
                document.getElementById('adminInterface').classList.remove('hidden');
                showAdminSection('dashboard');
                refreshAdminData();
            } else {
                document.getElementById('workerInterface').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('workerBarcodeInput').focus();
                }, 100);
                loadRecentScans();
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('appContainer').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('adminInterface').classList.add('hidden');
            document.getElementById('workerInterface').classList.add('hidden');
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // Worker Interface
        async function workerScan() {
            const input = document.getElementById('workerBarcodeInput');
            const barcode = input.value.trim();

            if (!barcode || barcode.length < 6) {
                return;
            }

            let bottle = bottles.find(b => b.bottle_id === barcode);

            // Auto-create bottle if it doesn't exist
            if (!bottle) {
                bottle = {
                    bottle_id: barcode,
                    refill_count: 0,
                    last_refill: null,
                    last_user: null,
                    created_at: new Date().toISOString()
                };

                bottles.push(bottle);

                if (isOnline && supabaseClient) {
                    await supabaseClient.from('bottles').insert([bottle]);
                } else {
                    addPendingOperation('insert', 'bottles', bottle);
                }
            }

            // Check for duplicate scan (within 12 hours)
            const now = Date.now();
            const twelveHours = 12 * 60 * 60 * 1000;
            const lastRefillTime = bottle.last_refill ? new Date(bottle.last_refill).getTime() : 0;

            if (now - lastRefillTime < twelveHours) {
                showToast('‚ö†Ô∏è DUPLICATE SCAN! Already refilled within 12 hours', 'error');
                playDuplicateAlarm();
                await logActivity('duplicate', { 
                    bottle_id: barcode, 
                    last_refill: bottle.last_refill,
                    username: currentUser.username 
                });

                input.value = '';
                input.focus();
                return;
            }

            // Process refill
            bottle.refill_count = (bottle.refill_count || 0) + 1;
            bottle.last_refill = new Date().toISOString();
            bottle.last_user = currentUser.username;

            // Update in Supabase or add to pending queue
            if (isOnline && supabaseClient) {
                await supabaseClient
                    .from('bottles')
                    .update({
                        refill_count: bottle.refill_count,
                        last_refill: bottle.last_refill,
                        last_user: bottle.last_user
                    })
                    .eq('bottle_id', barcode);
            } else {
                addPendingOperation('update', 'bottles',
                    {
                        refill_count: bottle.refill_count,
                        last_refill: bottle.last_refill,
                        last_user: bottle.last_user
                    },
                    { bottle_id: barcode }
                );
            }

            // Log activity
            await logActivity('refill', {
                bottle_id: barcode,
                refill_count: bottle.refill_count,
                username: currentUser.username
            });

            // Add to recent scans
            recentScans.unshift({
                bottle_id: barcode,
                timestamp: new Date().toISOString(),
                refill_count: bottle.refill_count
            });
            if (recentScans.length > 10) recentScans.pop();

            showToast(`‚úì Refill #${bottle.refill_count} recorded for ${barcode}`, 'success');
            playSuccessSound();

            input.value = '';
            input.focus();
            loadRecentScans();
        }

        function loadRecentScans() {
            const list = document.getElementById('recentScansList');
            if (recentScans.length === 0) {
                list.innerHTML = '<p style="color: #888; text-align:center; padding:20px;">No recent scans</p>';
                return;
            }

            list.innerHTML = recentScans.map(scan => `
                <div class="scan-item">
                    <div class="scan-item-left">
                        <div class="scan-item-id">${scan.bottle_id}</div>
                        <div class="scan-time">${new Date(scan.timestamp).toLocaleString()}</div>
                    </div>
                    <div class="scan-count">Refill #${scan.refill_count}</div>
                </div>
            `).join('');
        }

        // Admin Interface
        function showAdminSection(section) {
            document.querySelectorAll('.admin-section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            document.getElementById(section + 'Section').classList.remove('hidden');
            document.querySelector(`[data-section="${section}"]`).classList.add('active');

            if (section === 'dashboard') {
                updateKPIs();
            } else if (section === 'bottles') {
                renderBottlesTable();
            } else if (section === 'users') {
                renderUsersTable();
            } else if (section === 'trace') {
                renderTraceTable();
            }
        }

        async function refreshAdminData() {
            await loadData();
            updateKPIs();
        }

        function updateKPIs() {
            const total = bottles.length;
            const totalRefills = bottles.reduce((sum, b) => sum + (b.refill_count || 0), 0);
            const active = bottles.filter(b => (b.refill_count || 0) < 30).length;
            const expired = bottles.filter(b => (b.refill_count || 0) >= 30).length;

            document.getElementById('kpiTotal').textContent = total;
            document.getElementById('kpiTotalRefills').textContent = totalRefills;
            document.getElementById('kpiActive').textContent = active;
            document.getElementById('kpiExpired').textContent = expired;
        }

        function renderBottlesTable() {
            const tbody = document.getElementById('bottlesTableBody');
            const filteredBottles = getFilteredBottles();

            if (filteredBottles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#888;">No bottles found</td></tr>';
                return;
            }

            tbody.innerHTML = filteredBottles.map(bottle => {
                const refillCount = bottle.refill_count || 0;
                const lifePercent = Math.max(0, ((30 - refillCount) / 30 * 100));
                let lifeClass = 'healthy';
                if (lifePercent < 20) lifeClass = 'critical';
                else if (lifePercent < 50) lifeClass = 'warning';

                const status = refillCount >= 30 ? 
                    '<span class="badge badge-expired">Expired</span>' : 
                    '<span class="badge badge-success">Active</span>';

                return `
                    <tr>
                        <td><strong>${bottle.bottle_id}</strong></td>
                        <td><strong>${refillCount}</strong> / 30</td>
                        <td>
                            <div class="life-bar">
                                <div class="life-fill ${lifeClass}" style="width: ${lifePercent}%"></div>
                            </div>
                        </td>
                        <td>${bottle.last_refill ? new Date(bottle.last_refill).toLocaleString() : 'Never'}</td>
                        <td>${bottle.last_user || 'N/A'}</td>
                        <td>${status}</td>
                        <td>
                            <button class="btn-danger" onclick="deleteBottle('${bottle.bottle_id}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getFilteredBottles() {
            let filtered = bottles;

            const idFilter = document.getElementById('filterBottleId')?.value.toLowerCase();
            if (idFilter) {
                filtered = filtered.filter(b => b.bottle_id.toLowerCase().includes(idFilter));
            }

            return filtered;
        }

        function filterBottles() {
            renderBottlesTable();
        }

        function showAddBottleModal() {
            document.getElementById('addBottleModal').classList.add('active');
        }

        async function addBottle() {
            const bottleId = document.getElementById('newBottleId').value.trim();

            if (!bottleId) {
                showToast('Please enter bottle ID', 'error');
                return;
            }

            if (bottles.find(b => b.bottle_id === bottleId)) {
                showToast('Bottle ID already exists', 'error');
                return;
            }

            const newBottle = {
                bottle_id: bottleId,
                refill_count: 0,
                last_refill: null,
                last_user: null,
                created_at: new Date().toISOString()
            };

            bottles.push(newBottle);

            if (isOnline && supabaseClient) {
                await supabaseClient.from('bottles').insert([newBottle]);
            } else {
                addPendingOperation('insert', 'bottles', newBottle);
            }

            await logActivity('add_bottle', { bottle_id: bottleId, username: currentUser.username });
            showToast('Bottle added successfully', 'success');
            closeModal('addBottleModal');
            renderBottlesTable();
            updateKPIs();

            document.getElementById('newBottleId').value = '';
        }

        async function deleteBottle(bottleId) {
            if (!confirm(`Delete bottle ${bottleId}?`)) return;

            bottles = bottles.filter(b => b.bottle_id !== bottleId);

            if (isOnline && supabaseClient) {
                await supabaseClient.from('bottles').delete().eq('bottle_id', bottleId);
            } else {
                addPendingOperation('delete', 'bottles', null, { bottle_id: bottleId });
            }

            await logActivity('delete_bottle', { bottle_id: bottleId, username: currentUser.username });
            showToast('Bottle deleted', 'success');
            renderBottlesTable();
            updateKPIs();
        }

        // User Management
        function renderUsersTable() {
            const tbody = document.getElementById('usersTableBody');

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#888;">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td><strong>${user.username}</strong></td>
                    <td>
                        <span class="badge ${user.role === 'admin' ? 'badge-admin' : 'badge-worker'}">
                            ${user.role.toUpperCase()}
                        </span>
                    </td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td>
                    <td>
                        ${user.username !== 'admin' ? 
                            `<button class="btn-danger" onclick="deleteUser('${user.username}')">Delete</button>` 
                            : '<span style="color:#888;">Protected</span>'}
                    </td>
                </tr>
            `).join('');
        }

        function showAddUserModal() {
            document.getElementById('addUserModal').classList.add('active');
        }

        async function addUser() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newUserRole').value;

            if (!username || !password) {
                showToast('Please fill all fields', 'error');
                return;
            }

            if (users.find(u => u.username === username)) {
                showToast('Username already exists', 'error');
                return;
            }

            const newUser = {
                username,
                password,
                role,
                created_at: new Date().toISOString(),
                last_login: null
            };

            users.push(newUser);

            if (isOnline && supabaseClient) {
                await supabaseClient.from('users').insert([newUser]);
            } else {
                addPendingOperation('insert', 'users', newUser);
            }

            await logActivity('add_user', { username, role, by: currentUser.username });
            showToast('User created successfully', 'success');
            closeModal('addUserModal');
            renderUsersTable();

            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
        }

        async function deleteUser(username) {
            if (username === 'admin') {
                showToast('Cannot delete admin user', 'error');
                return;
            }

            if (!confirm(`Delete user ${username}?`)) return;

            users = users.filter(u => u.username !== username);

            if (isOnline && supabaseClient) {
                await supabaseClient.from('users').delete().eq('username', username);
            } else {
                addPendingOperation('delete', 'users', null, { username });
            }

            await logActivity('delete_user', { username, by: currentUser.username });
            showToast('User deleted', 'success');
            renderUsersTable();
        }

        // Activity Trace
        function renderTraceTable() {
            const tbody = document.getElementById('traceTableBody');
            const filteredTrace = getFilteredTrace();

            if (filteredTrace.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#888;">No activity found</td></tr>';
                return;
            }

            tbody.innerHTML = filteredTrace.slice(0, 100).map(entry => `
                <tr>
                    <td>${new Date(entry.timestamp).toLocaleString()}</td>
                    <td><strong>${entry.username || 'System'}</strong></td>
                    <td><span class="badge badge-worker">${entry.action}</span></td>
                    <td>${formatTraceDetails(entry.details)}</td>
                </tr>
            `).join('');
        }

        function getFilteredTrace() {
            let filtered = activityTrace;

            const userFilter = document.getElementById('filterTraceUser')?.value.toLowerCase();
            if (userFilter) {
                filtered = filtered.filter(t => 
                    (t.username || '').toLowerCase().includes(userFilter)
                );
            }

            const actionFilter = document.getElementById('filterTraceAction')?.value;
            if (actionFilter) {
                filtered = filtered.filter(t => t.action === actionFilter);
            }

            return filtered;
        }

        function filterTrace() {
            renderTraceTable();
        }

        function formatTraceDetails(details) {
            if (typeof details === 'string') {
                try {
                    const parsed = JSON.parse(details);
                    return JSON.stringify(parsed);
                } catch {
                    return details;
                }
            }
            return JSON.stringify(details);
        }

        async function logActivity(action, details) {
            const entry = {
                timestamp: new Date().toISOString(),
                username: currentUser?.username || 'System',
                action,
                details: typeof details === 'object' ? JSON.stringify(details) : details
            };

            activityTrace.unshift(entry);

            if (isOnline && supabaseClient) {
                await supabaseClient.from('activity_trace').insert([entry]);
            } else {
                addPendingOperation('insert', 'activity_trace', entry);
            }
        }

        function exportTrace() {
            const csv = ['Timestamp,User,Action,Details'];
            activityTrace.forEach(entry => {
                const details = typeof entry.details === 'object' ? 
                    JSON.stringify(entry.details).replace(/"/g, '""') : 
                    String(entry.details).replace(/"/g, '""');
                csv.push(`"${entry.timestamp}","${entry.username}","${entry.action}","${details}"`);
            });

            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `activity-trace-${Date.now()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Modals
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Toast Notifications
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} active`;

            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }

        // Sound Effects
        function playSuccessSound() {
            try {
                const audio = new AudioContext();
                const oscillator = audio.createOscillator();
                const gainNode = audio.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audio.destination);
                oscillator.frequency.value = 800;
                gainNode.gain.setValueAtTime(0.3, audio.currentTime);
                oscillator.start();
                oscillator.stop(audio.currentTime + 0.1);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playDuplicateAlarm() {
            try {
                const audio = new AudioContext();
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        const oscillator = audio.createOscillator();
                        const gainNode = audio.createGain();
                        oscillator.connect(gainNode);
                        gainNode.connect(audio.destination);
                        oscillator.frequency.value = 400;
                        gainNode.gain.setValueAtTime(0.5, audio.currentTime);
                        oscillator.start();
                        oscillator.stop(audio.currentTime + 0.2);
                    }, i * 300);
                }
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        // Online/Offline Event Listeners
        window.addEventListener('online', async () => {
            console.log('üåê Back online!');
            showToast('Connection restored. Syncing...', 'success');
            
            await checkConnection();
            updateConnectionStatus();
            
            if (isOnline) {
                await syncPendingData();
            }
        });

        window.addEventListener('offline', () => {
            console.log('üì¥ Offline mode');
            isOnline = false;
            updateConnectionStatus();
            showToast('Offline: Changes will sync when online', 'warning');
        });

        // Periodic connection check (every 30 seconds)
        setInterval(async () => {
            const wasOnline = isOnline;
            await checkConnection();
            
            if (!wasOnline && isOnline) {
                // Just came back online
                updateConnectionStatus();
                await syncPendingData();
            } else if (wasOnline && !isOnline) {
                // Just went offline
                updateConnectionStatus();
            }
        }, 30000);

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            const loginPassword = document.getElementById('loginPassword');
            if (loginPassword) {
                loginPassword.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') login();
                });
            }

            const loginUsername = document.getElementById('loginUsername');
            if (loginUsername) {
                loginUsername.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('loginPassword').focus();
                    }
                });
            }

            init();
        });
    </script>
</body>
</html>
