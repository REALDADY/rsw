<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>5-Gallon Bottle + Smart Pallet Tracking System</title>
<style>
  * { box-sizing: border-box; }
  body { 
    background: linear-gradient(135deg,#e3f2fd 0%,#f8f9fa 100%); 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    color: #222; margin: 0; padding: 0; min-height: 100vh;
  }
  .container { 
    max-width: 1300px; margin: 20px auto; background: #fff; 
    border-radius: 20px; box-shadow: 0 10px 40px rgba(33,150,243,0.1); 
    padding: 36px 28px; position: relative;
  }
  .header { text-align: center; margin-bottom: 32px; position: relative; padding-bottom: 16px; border-bottom: 2px solid #e3f2fd; }
  .header h1 { margin: 0 0 8px 0; font-size: 2rem; color: #1565c0; }
  .header .subtitle { font-size: 0.95rem; color: #6c757d; line-height: 1.5; }
  
  .user-badge { 
    position: absolute; top: 0; right: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
    border-radius: 20px; padding: 12px 20px; display: flex; align-items: center; gap: 14px; 
    box-shadow: 0 4px 12px rgba(102,126,234,0.25); color: white;
  }
  .user-badge .role { 
    background: rgba(255,255,255,0.25); padding: 4px 10px; border-radius: 10px; 
    font-size: 0.85rem; font-weight: 600; text-transform: uppercase;
  }
  
  .tabs { 
    display: flex; justify-content: center; gap: 10px; margin-bottom: 32px; 
    flex-wrap: wrap; padding: 0 10px;
  }
  .tab { 
    background: linear-gradient(90deg,#2196F3 0%,#20c997 100%); color: #fff; border: none; 
    border-radius: 28px; padding: 13px 30px; font-size: 1.05rem; font-weight: 600; 
    cursor: pointer; transition: all 0.3s; box-shadow: 0 3px 10px rgba(33,150,243,0.15);
    letter-spacing: 0.3px;
  }
  .tab:not(.active):hover { 
    background: linear-gradient(90deg,#20c997 0%,#2196F3 100%); 
    transform: translateY(-2px); box-shadow: 0 5px 15px rgba(33,150,243,0.25);
  }
  .tab.active { 
    background: linear-gradient(90deg,#1565c0 0%,#43e97b 100%); 
    box-shadow: 0 5px 20px rgba(33,150,243,0.3);
    transform: translateY(-1px);
  }
  
  .tab-content { display: none; animation: fadeIn 0.4s ease-in-out; }
  .tab-content.active { display: block; }
  @keyframes fadeIn { from {opacity: 0; transform: translateY(20px);} to {opacity:1; transform: translateY(0);} }

  .scanner-container { 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
    border-radius: 18px; padding: 30px; margin: 20px 0; color: white; text-align: center;
    box-shadow: 0 8px 24px rgba(102,126,234,0.3);
  }
  .scanner-container h3 { margin: 0 0 10px 0; font-size: 1.5rem; }
  .scanner-status { 
    margin-top: 10px; padding: 12px 20px; border-radius: 14px; 
    background: rgba(255,255,255,0.2); display: inline-block; font-weight: 600;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
  }
  .barcode-input-large { 
    width: 100%; font-size: 1.3rem; padding: 16px 20px; border-radius: 14px; 
    border: 3px solid rgba(255,255,255,0.3); outline: none; margin-top: 12px;
    transition: all 0.3s; font-weight: 600; text-align: center;
  }
  .barcode-input-large:focus { 
    border-color: #43e97b; box-shadow: 0 0 0 4px rgba(67,233,123,0.2);
    transform: scale(1.02);
  }

  .mode-toggle { 
    background: rgba(255,255,255,0.15); border-radius: 12px; padding: 16px; 
    margin: 16px 0; display: flex; align-items: center; gap: 12px; justify-content: center;
    flex-wrap: wrap;
  }
  .mode-toggle label { 
    display: flex; align-items: center; gap: 10px; cursor: pointer; 
    padding: 10px 16px; background: rgba(255,255,255,0.1); border-radius: 10px;
    transition: all 0.3s;
  }
  .mode-toggle label:hover { background: rgba(255,255,255,0.25); }
  .mode-toggle input[type="checkbox"] { 
    width: 20px; height: 20px; cursor: pointer; 
  }

  .scanned-list { 
    background: #fff; border-radius: 16px; 
    box-shadow: 0 4px 12px rgba(33,150,243,0.08); padding: 22px; margin-top: 20px;
  }
  .scanned-list h3 { 
    color: #1565c0; margin: 0 0 12px 0; display: flex; 
    align-items: center; gap: 10px; font-size: 1.3rem;
  }
  .scanned-item { 
    display: flex; align-items: center; justify-content: space-between; 
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
    border-radius: 12px; padding: 14px 16px; margin: 8px 0;
    transition: all 0.2s; border-left: 4px solid #2196F3;
  }
  .scanned-item:hover { 
    background: linear-gradient(135deg, #e3f2fd 0%, #d1e7fd 100%); 
    transform: translateX(4px); box-shadow: 0 2px 8px rgba(33,150,243,0.15);
  }
  .scanned-item-code { font-weight: 700; color: #1565c0; font-size: 1.1rem; }
  .remove-btn { 
    border: none; background: #dc3545; cursor: pointer; color: white; 
    font-size: 1rem; width: 32px; height: 32px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
  }
  .remove-btn:hover { background: #c82333; transform: rotate(90deg) scale(1.1); }

  .bottle-grid, #client-list, #pallet-grid { 
    display: grid; grid-template-columns: repeat(auto-fit,minmax(320px,1fr)); 
    gap: 20px; margin-top: 20px;
  }
  .bottle-card, .pallet-card { 
    background: #fff; border-radius: 16px; 
    box-shadow: 0 4px 12px rgba(33,150,243,0.08); padding: 22px; 
    transition: all 0.3s; position: relative; border: 2px solid transparent;
  }
  .bottle-card:hover, .pallet-card:hover { 
    box-shadow: 0 8px 28px rgba(33,150,243,0.15); 
    border-color: #2196F3; transform: translateY(-4px);
  }
  .bottle-id, .pallet-id { 
    font-size: 1.2rem; font-weight: bold; color: #1565c0; 
    margin-bottom: 10px; display: flex; align-items: center; gap: 8px;
  }
  
  .status { 
    display: inline-block; padding: 7px 14px; border-radius: 14px; 
    font-size: 0.9rem; font-weight: 700; margin-bottom: 10px;
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  .status.available { background: #e3f2fd; color: #1976d2; }
  .status.with-client { background: #c8e6c9; color: #2e7d32; }
  .status.needs-refill { background: #fff3cd; color: #856404; }
  .status.empty { background: #f8d7da; color: #721c24; }
  .status.partial { background: #ffe5b4; color: #d97706; }
  .status.full { background: #d1f2eb; color: #0f5132; }

  .btn { 
    background: linear-gradient(90deg,#2196F3 0%,#20c997 100%); color: #fff; 
    border: none; border-radius: 28px; padding: 11px 22px; font-size: 1rem; 
    font-weight: 600; cursor: pointer; margin: 5px; transition: all 0.3s;
    box-shadow: 0 3px 10px rgba(33,150,243,0.2); letter-spacing: 0.3px;
  }
  .btn:hover { 
    background: linear-gradient(90deg,#20c997 0%,#2196F3 100%); 
    transform: translateY(-2px); box-shadow: 0 5px 15px rgba(33,150,243,0.3);
  }
  .btn:active { transform: translateY(0); }
  .btn-sm { padding: 8px 16px; font-size: 0.9rem; }
  .btn-success { background: linear-gradient(90deg,#43e97b 0%,#38f9d7 100%); }
  .btn-success:hover { background: linear-gradient(90deg,#38f9d7 0%,#43e97b 100%); }
  .btn-warning { background: linear-gradient(90deg,#ffc107 0%,#ff9800 100%); }
  .btn-warning:hover { background: linear-gradient(90deg,#ff9800 0%,#ffc107 100%); }
  .btn-danger { background: linear-gradient(90deg,#dc3545 0%,#ff6a00 100%); }
  .btn-danger:hover { background: linear-gradient(90deg,#c82333 0%,#e63900 100%); }
  .btn-secondary { background: linear-gradient(90deg,#6c757d 0%,#b0bec5 100%); }
  .btn-secondary:hover { background: linear-gradient(90deg,#5a6268 0%,#90a4ae 100%); }

  .small { font-size: 0.95rem; color: #6c757d; margin: 4px 0; }
  .search-row { 
    display: flex; flex-wrap: wrap; gap: 14px; align-items: center; 
    margin-bottom: 20px; padding: 16px; background: #f8f9fa; border-radius: 12px;
  }
  .search-input, select, input, textarea { 
    font-size: 1rem; padding: 13px 16px; border-radius: 12px; 
    border: 2px solid #e9ecef; flex: 1; min-width: 200px;
    transition: all 0.3s;
  }
  .search-input:focus, select:focus, input:focus, textarea:focus {
    border-color: #2196F3; outline: none; box-shadow: 0 0 0 3px rgba(33,150,243,0.1);
  }
  
  .modal { 
    display: none; position: fixed; z-index: 5000; left:0; top:0; 
    width:100vw; height:100vh; background: rgba(0,0,0,0.5); 
    align-items: center; justify-content: center; backdrop-filter: blur(4px);
  }
  .modal-content { 
    background: #fff; border-radius: 20px; 
    box-shadow: 0 10px 50px rgba(0,0,0,0.3); padding: 32px 26px; 
    max-width: 520px; width: 92vw; position: relative; 
    animation: modalSlideIn 0.3s ease-out; max-height: 90vh; overflow-y: auto;
  }
  @keyframes modalSlideIn { from {opacity:0; transform: scale(0.9) translateY(-20px);} to {opacity:1; transform: scale(1) translateY(0);} }
  .close { 
    position: absolute; top: 16px; right: 20px; font-size: 2rem; 
    color: #2196F3; cursor: pointer; font-weight: bold; 
    transition: all 0.2s; width: 36px; height: 36px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 50%; background: #e3f2fd;
  }
  .close:hover { background: #2196F3; color: white; transform: rotate(90deg); }

  .toast { 
    position: fixed; right: 20px; top: 20px; z-index: 6000; 
    display: flex; flex-direction: column; gap: 12px; max-width: 400px;
  }
  .toast-item { 
    background: #fff; border-left: 6px solid #2196F3; border-radius: 12px; 
    padding: 14px 18px; box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    animation: toastSlideIn 0.3s ease-out;
  }
  @keyframes toastSlideIn { from {opacity:0; transform: translateX(100%);} to {opacity:1; transform: translateX(0);} }
  .toast-item.success { border-color: #28a745; background: #d4edda; }
  .toast-item.warning { border-color: #ff9800; background: #fff3cd; }
  .toast-item.error { border-color: #dc3545; background: #f8d7da; }
  
  .right { text-align: right; }
  .bottle-list-mini { 
    background: #f8f9fa; border-radius: 10px; padding: 14px; 
    margin: 12px 0; max-height: 200px; overflow-y: auto;
    border: 2px solid #e9ecef;
  }
  .bottle-list-mini div { padding: 6px 0; font-size: 0.95rem; border-bottom: 1px solid #e9ecef; }
  .bottle-list-mini div:last-child { border-bottom: none; }
  
  .progress-bar { 
    background: #e9ecef; border-radius: 10px; height: 28px; 
    overflow: hidden; margin: 12px 0; position: relative;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
  }
  .progress-fill { 
    background: linear-gradient(90deg,#43e97b 0%,#38f9d7 100%); 
    height: 100%; transition: width 0.4s ease; display: flex; 
    align-items: center; justify-content: center; color: #fff; 
    font-weight: 800; font-size: 0.95rem; letter-spacing: 0.5px;
  }
  
  .badge-danger { 
    position: absolute; top: 10px; right: 10px; z-index: 10;
  }
  
  .stats-mini { 
    display: flex; gap: 8px; margin: 10px 0; flex-wrap: wrap;
  }
  .stats-mini .stat-badge { 
    background: #e3f2fd; color: #1565c0; padding: 6px 12px; 
    border-radius: 8px; font-size: 0.85rem; font-weight: 700;
  }
  
  .section-header { 
    display: flex; justify-content: space-between; align-items: center; 
    margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #e3f2fd;
  }
  .section-header h2 { margin: 0; color: #1565c0; font-size: 1.6rem; }

  .empty-state { 
    text-align: center; padding: 60px 20px; color: #6c757d;
  }
  .empty-state .icon { font-size: 4rem; margin-bottom: 16px; opacity: 0.5; }
  .empty-state .message { font-size: 1.1rem; }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üè≠ 5-Gallon Bottle Tracking System</h1>
    <div class="subtitle">Auto-create pallets at 32 bottles ‚Ä¢ Deliver individually or in bulk ‚Ä¢ Real-time tracking</div>
    <div class="user-badge">
      <div>
        <div style="font-weight:700; font-size:1.1rem;" id="user-name">Admin User</div>
        <div class="role" id="user-role">ADMIN</div>
      </div>
      <button class="btn btn-sm btn-danger" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="openTab('scanner', this)">üì± Scanner</button>
    <button class="tab" onclick="openTab('pallets', this)">üì¶ Pallets</button>
    <button class="tab" onclick="openTab('inventory', this)">üìä Inventory</button>
    <button class="tab" onclick="openTab('clients', this)">üë• Clients</button>
    <button class="tab" onclick="openTab('activity', this)">üìã Activity</button>
  </div>

  <!-- SCANNER TAB -->
  <div id="scanner" class="tab-content active">
    <div class="scanner-container">
      <div style="font-size:3.5rem;margin-bottom:12px;">üîç</div>
      <h3>Barcode Scanner Active</h3>
      <div class="scanner-status" id="scanner-status">üü¢ Ready to Scan</div>
      <div style="margin-top:20px;">
        <input id="barcode-input" class="barcode-input-large" placeholder="Focus here ‚Ä¢ Auto-add length < 4 ‚Ä¢ Enter for longer" autocomplete="off" autofocus>
      </div>
      
      <div class="mode-toggle">
        <label>
          <input type="radio" name="scanner-mode" value="bottle" checked onchange="setScannerMode('bottle')">
          <span style="font-weight:700;">üß¥ Bottle Mode</span>
        </label>
        <label>
          <input type="radio" name="scanner-mode" value="pallet" onchange="setScannerMode('pallet')">
          <span style="font-weight:700;">üì¶ Pallet Mode</span>
        </label>
      </div>
      
      <div id="mode-help" class="small" style="opacity:0.9; margin-top:8px; background: rgba(255,255,255,0.15); padding:10px; border-radius:8px;">
        üí° <strong>Bottle Mode:</strong> Scan bottles to build queue ‚Üí auto-create pallet at 32
      </div>
    </div>

    <!-- Bottle Queue -->
    <div class="scanned-list" id="bottle-queue">
      <h3>üìã Bottle Queue (<span id="scanned-count">0</span> / 32)</h3>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width:0%;">0 / 32</div>
      </div>
      <div id="scanned-items-container">
        <div class="empty-state">
          <div class="icon">üìã</div>
          <div class="message">No bottles scanned yet</div>
        </div>
      </div>
      <div class="right" style="margin-top:14px;">
        <button class="btn btn-success" onclick="batchRefill()" id="btn-batch-refill">üîÑ Refill Queue (0)</button>
        <button class="btn btn-warning" onclick="batchDeliver()" id="btn-batch-deliver">üöö Deliver Queue (0)</button>
        <button class="btn btn-secondary" onclick="batchReturn()" id="btn-batch-return">‚Ü©Ô∏è Return Queue (0)</button>
        <button class="btn btn-danger" onclick="clearAllScanned()">üóëÔ∏è Clear</button>
      </div>
    </div>

    <!-- Pallet Scanner Panel -->
    <div class="scanned-list" id="pallet-scanner-panel" style="display:none;">
      <h3>üì¶ Pallet Quick Actions</h3>
      <div id="pallet-scan-info" class="small" style="margin-bottom:12px;">Scan a pallet barcode (e.g., PAL-xxx) to load it for quick actions</div>
      <div id="pallet-scan-result"></div>
      <div class="right" style="margin-top:14px;">
        <button class="btn btn-success" onclick="quickRefillPallet()" id="btn-pallet-refill" disabled>üîÑ Refill Pallet</button>
        <button class="btn btn-warning" onclick="quickDeliverPallet()" id="btn-pallet-deliver" disabled>üöö Deliver Pallet</button>
        <button class="btn btn-secondary" onclick="quickReturnPallet()" id="btn-pallet-return" disabled>‚Ü©Ô∏è Return Pallet</button>
      </div>
    </div>
  </div>

  <!-- PALLETS TAB -->
  <div id="pallets" class="tab-content">
    <div class="section-header">
      <h2>üì¶ Pallets (<span id="pallet-count">0</span>)</h2>
    </div>
    <div class="search-row">
      <input id="search-pallets" class="search-input" placeholder="üîç Search pallets..." oninput="searchPallets()">
      <select id="filter-pallet-status" onchange="filterPallets()">
        <option value="">All Status</option>
        <option value="empty">Empty</option>
        <option value="partial">Partial</option>
        <option value="full">Full</option>
        <option value="with-client">With Client</option>
      </select>
    </div>
    <div id="pallet-grid" class="bottle-grid"></div>
  </div>

  <!-- INVENTORY TAB -->
  <div id="inventory" class="tab-content">
    <div class="section-header">
      <h2>üìä Inventory (<span id="bottle-count">0</span>)</h2>
      <div><button class="btn btn-sm" onclick="addBottlePrompt()" id="btn-add-bottle">‚ûï Add Bottle</button></div>
    </div>
    <div class="search-row">
      <input id="search-bottles" class="search-input" placeholder="üîç Search bottles..." oninput="searchBottles()">
      <select id="filter-status" onchange="filterBottles()">
        <option value="">All Status</option>
        <option value="available">Available</option>
        <option value="with-client">With Client</option>
        <option value="needs-refill">Needs Refill</option>
      </select>
    </div>
    <div id="bottle-inventory" class="bottle-grid"></div>
  </div>

  <!-- CLIENTS TAB -->
  <div id="clients" class="tab-content">
    <div class="section-header">
      <h2>üë• Clients (<span id="client-count">0</span>)</h2>
      <div><button class="btn btn-sm btn-success" onclick="openAddClient()">‚ûï Add Client</button></div>
    </div>
    <div class="search-row">
      <input id="search-clients" class="search-input" placeholder="üîç Search clients..." oninput="searchClients()">
    </div>
    <div id="client-list" class="bottle-grid"></div>
  </div>

  <!-- ACTIVITY TAB -->
  <div id="activity" class="tab-content">
    <div class="section-header">
      <h2>üìã Recent Activity</h2>
    </div>
    <div id="activity-list" class="scanned-list"></div>
  </div>
</div>

<!-- DELIVERY MODAL -->
<div id="delivery-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeDeliveryModal()">√ó</span>
    <h3 style="margin:0 0 16px 0; color:#1565c0; font-size:1.5rem;">üöö Delivery</h3>
    <div style="display:flex; gap:10px; margin-bottom:16px;">
      <button class="btn btn-sm" id="existing-client-btn" onclick="toggleClientMode('existing')" style="flex:1;">Existing Client</button>
      <button class="btn btn-sm btn-secondary" id="new-client-btn" onclick="toggleClientMode('new')" style="flex:1;">New Client</button>
    </div>
    <div id="existing-client-section">
      <input id="delivery-client-search" placeholder="üîç Search client..." oninput="filterDeliveryClients()" style="margin-bottom:10px; width:100%;">
      <select id="delivery-client-select" size="6" style="width:100%;"></select>
    </div>
    <div id="new-client-section" style="display:none;">
      <input id="delivery-new-client-name" placeholder="Client Name *" style="width:100%; margin-bottom:10px;">
      <input id="delivery-new-client-phone" placeholder="Phone *" style="width:100%; margin-bottom:10px;">
      <input id="delivery-new-client-address" placeholder="Address (optional)" style="width:100%;">
    </div>
    <div style="display:flex; gap:10px; margin:16px 0;">
      <input type="date" id="delivery-date" style="flex:1;">
      <input type="time" id="delivery-time" style="flex:1;">
    </div>
    <div class="right">
      <button class="btn btn-success" onclick="confirmBatchDelivery()">‚úÖ Confirm Delivery</button>
    </div>
  </div>
</div>

<!-- PALLET DETAILS MODAL -->
<div id="pallet-details-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closePalletDetails()">√ó</span>
    <h3 style="margin:0 0 16px 0; color:#1565c0; font-size:1.5rem;" id="pallet-detail-title">Pallet Details</h3>
    <div id="pallet-detail-info"></div>
    <div class="bottle-list-mini" id="pallet-detail-bottles"></div>
    <div class="right" style="margin-top:16px;">
      <button class="btn btn-success" onclick="refillPalletById(currentPalletId)" id="btn-detail-refill">üîÑ Refill All</button>
      <button class="btn btn-warning" onclick="deliverPalletById(currentPalletId)" id="btn-detail-deliver">üöö Deliver All</button>
      <button class="btn btn-secondary" onclick="returnPalletById(currentPalletId)" id="btn-detail-return">‚Ü©Ô∏è Return All</button>
      <button class="btn btn-danger" onclick="deletePallet(currentPalletId)" id="btn-detail-delete">üóëÔ∏è Delete</button>
    </div>
  </div>
</div>

<!-- ADD CLIENT MODAL -->
<div id="add-client-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeAddClient()">√ó</span>
    <h3 style="margin:0 0 16px 0; color:#1565c0; font-size:1.5rem;">‚ûï Add New Client</h3>
    <input id="new-client-name" placeholder="Name *" style="width:100%; margin-bottom:12px;">
    <input id="new-client-phone" placeholder="Phone *" style="width:100%; margin-bottom:12px;">
    <input id="new-client-address" placeholder="Address (optional)" style="width:100%; margin-bottom:16px;">
    <div class="right">
      <button class="btn btn-success" onclick="createNewClient()">‚úÖ Create Client</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* =========================
   GLOBALS & PERMISSIONS
   ========================= */
const STORAGE_KEY = 'bottle_app_production_v1';
const PALLET_CAPACITY = 32;
const MAX_BARCODES = 500;

let bottles = [];
let clients = [];
let pallets = [];
let activityLog = [];
let scannedBarcodes = [];

let deliveryClientMode = 'existing';
let currentUser = { id: 'u1', name: 'Admin User', role: 'admin' }; // or 'worker', 'delivery'
let currentPalletId = '';
let scannerMode = 'bottle'; // 'bottle' or 'pallet'
let activePalletScan = null;

// Permission system
const PERMISSIONS = {
  admin: ['scan', 'deliver', 'return', 'refill', 'add_bottle', 'delete_bottle', 'delete_pallet', 'add_client'],
  worker: ['scan', 'deliver', 'return', 'refill'],
  delivery: ['scan', 'deliver', 'return']
};

function hasPermission(action) {
  const role = currentUser.role || 'worker';
  return PERMISSIONS[role]?.includes(action) || false;
}

function updateUIPermissions() {
  // Hide/disable delete buttons for non-admins
  const canDelete = hasPermission('delete_bottle');
  document.getElementById('btn-add-bottle')?.style.setProperty('display', hasPermission('add_bottle') ? 'inline-block' : 'none');
  
  // Update user badge
  document.getElementById('user-name').textContent = currentUser.name;
  document.getElementById('user-role').textContent = currentUser.role.toUpperCase();
}

/* =========================
   PERSISTENCE
   ========================= */
function saveData() {
  const payload = { bottles, clients, pallets, activityLog, lastUpdated: new Date().toISOString() };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
}

function loadData() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return;
  try {
    const data = JSON.parse(raw);
    bottles = Array.isArray(data.bottles) ? data.bottles : [];
    clients = Array.isArray(data.clients) ? data.clients : [];
    pallets = Array.isArray(data.pallets) ? data.pallets : [];
    activityLog = Array.isArray(data.activityLog) ? data.activityLog : [];
  } catch (e) { console.error('Load error:', e); }
}

function addActivity(msg) {
  activityLog.unshift({ id: 'act_' + Date.now(), message: msg, timestamp: new Date().toISOString(), user: currentUser.name });
  updateActivity();
  saveData();
}

function showNotification(text, type='info', timeout=3000) {
  const host = document.getElementById('toast');
  const el = document.createElement('div');
  el.className = 'toast-item ' + (type==='success'?'success':type==='warning'?'warning':type==='error'?'error':'');
  el.textContent = text;
  host.appendChild(el);
  setTimeout(() => { if(host.contains(el)) host.removeChild(el); }, timeout);
}

/* =========================
   DATA HELPERS
   ========================= */
function createNewBottleRecord(id, status='available', palletId='') {
  const b = { id, status, palletId, deliveryCount: 0, refillCount: 0, clientId: '', clientName: '', clientPhone: '', created: new Date().toISOString(), lastUpdated: new Date().toISOString(), history: [{ action: 'Created', timestamp: new Date().toISOString(), user: currentUser.name }] };
  bottles.push(b);
  return b;
}

function createNewClientRecord({ name, phone, address='' }) {
  const c = { id: 'client_' + Date.now(), name, phone, address, created: new Date().toISOString(), lastUpdated: new Date().toISOString(), bottleCount: 0, history: [{ action: 'Client created', timestamp: new Date().toISOString(), user: currentUser.name }] };
  clients.push(c);
  saveData();
  return c;
}

function updateClientBottleCounts() {
  const counts = {};
  bottles.forEach(b => { if (b.clientId) counts[b.clientId] = (counts[b.clientId]||0) + 1; });
  clients.forEach(c => c.bottleCount = counts[c.id] || 0);
}

/* =========================
   PALLET HELPERS
   ========================= */
function createNewPalletRecord(name='') {
  const id = 'PAL-' + Date.now();
  const pallet = { id, name: name || id, bottleIds: [], capacity: PALLET_CAPACITY, status: 'empty', clientId: '', created: new Date().toISOString(), lastUpdated: new Date().toISOString(), history: [{ action: 'Pallet created', timestamp: new Date().toISOString(), user: currentUser.name }] };
  pallets.push(pallet);
  return pallet;
}

function findPalletById(palletId) { return pallets.find(p => p.id === palletId); }

function recalcPalletStatus(pallet) {
  const count = pallet.bottleIds.length;
  if (pallet.clientId) pallet.status = 'with-client';
  else if (count === 0) pallet.status = 'empty';
  else if (count < pallet.capacity) pallet.status = 'partial';
  else if (count === pallet.capacity) {
    const anyNeeds = pallet.bottleIds.some(id => (bottles.find(b => b.id === id)?.status === 'needs-refill'));
    pallet.status = anyNeeds ? 'needs-refill' : 'full';
  }
  pallet.lastUpdated = new Date().toISOString();
}

function addBottleToPallet(pallet, bottleId) {
  if (pallet.bottleIds.includes(bottleId)) return false;
  if (pallet.bottleIds.length >= pallet.capacity) return false;
  let b = bottles.find(x => x.id === bottleId);
  if (!b) b = createNewBottleRecord(bottleId, 'available', pallet.id);
  else b.palletId = pallet.id;
  pallet.bottleIds.push(bottleId);
  recalcPalletStatus(pallet);
  return true;
}

function removeBottleFromPallet(pallet, bottleId) {
  pallet.bottleIds = pallet.bottleIds.filter(id => id !== bottleId);
  const b = bottles.find(x => x.id === bottleId);
  if (b) b.palletId = '';
  recalcPalletStatus(pallet);
  saveData();
}

function autoRemoveFromPallet(bottleId) {
  const b = bottles.find(x => x.id === bottleId);
  if (!b || !b.palletId) return;
  const pallet = findPalletById(b.palletId);
  if (!pallet) return;
  pallet.bottleIds = pallet.bottleIds.filter(id => id !== bottleId);
  b.palletId = '';
  recalcPalletStatus(pallet);
  pallet.history.push({ action: `Bottle ${bottleId} removed (delivered separately)`, timestamp: new Date().toISOString(), user: currentUser.name });
}

/* =========================
   AUTO PALLET AT 32
   ========================= */
function checkAutoCreatePallet() {
  if (scannedBarcodes.length === PALLET_CAPACITY) {
    const pallet = createNewPalletRecord();
    scannedBarcodes.forEach(bottleId => addBottleToPallet(pallet, bottleId));
    addActivity(`‚úÖ Auto-created pallet ${pallet.id} with ${PALLET_CAPACITY} bottles`);
    showNotification(`‚úÖ Pallet ${pallet.id} created with 32 bottles!`, 'success', 4000);
    scannedBarcodes = [];
    updateScannedList();
    saveData();
    updateAllDisplays();
  }
}

/* =========================
   SCANNER MODES
   ========================= */
function setScannerMode(mode) {
  scannerMode = mode;
  document.getElementById('bottle-queue').style.display = mode === 'bottle' ? 'block' : 'none';
  document.getElementById('pallet-scanner-panel').style.display = mode === 'pallet' ? 'block' : 'none';
  document.getElementById('mode-help').innerHTML = mode === 'bottle' 
    ? 'üí° <strong>Bottle Mode:</strong> Scan bottles to build queue ‚Üí auto-create pallet at 32'
    : 'üí° <strong>Pallet Mode:</strong> Scan a pallet barcode (PAL-xxx) for quick deliver/return/refill actions';
  document.getElementById('barcode-input').focus();
  activePalletScan = null;
  updatePalletScanUI();
}

function updatePalletScanUI() {
  const resultDiv = document.getElementById('pallet-scan-result');
  const btnRefill = document.getElementById('btn-pallet-refill');
  const btnDeliver = document.getElementById('btn-pallet-deliver');
  const btnReturn = document.getElementById('btn-pallet-return');
  
  if (!activePalletScan) {
    resultDiv.innerHTML = '<div class="empty-state"><div class="icon">üì¶</div><div class="message">Waiting for pallet scan...</div></div>';
    btnRefill.disabled = true;
    btnDeliver.disabled = true;
    btnReturn.disabled = true;
    return;
  }
  
  const pallet = findPalletById(activePalletScan);
  if (!pallet) {
    resultDiv.innerHTML = '<div class="empty-state" style="padding:20px;"><div class="message" style="color:#dc3545;">‚ùå Pallet not found</div></div>';
    btnRefill.disabled = true;
    btnDeliver.disabled = true;
    btnReturn.disabled = true;
    return;
  }
  
  resultDiv.innerHTML = `
    <div class="scanned-item" style="background: linear-gradient(135deg, #e3f2fd 0%, #d1e7fd 100%); border-left: 6px solid #2196F3;">
      <div>
        <div class="pallet-id">üì¶ ${pallet.name}</div>
        <div class="status ${pallet.status}">${pallet.status.toUpperCase()}</div>
        <div class="small">Bottles: ${pallet.bottleIds.length} / ${pallet.capacity}</div>
      </div>
    </div>
  `;
  
  btnRefill.disabled = false;
  btnDeliver.disabled = false;
  btnReturn.disabled = false;
}

function quickRefillPallet() {
  if (!activePalletScan) return;
  refillPalletById(activePalletScan);
  activePalletScan = null;
  updatePalletScanUI();
}

function quickDeliverPallet() {
  if (!activePalletScan) return;
  deliverPalletById(activePalletScan);
}

function quickReturnPallet() {
  if (!activePalletScan) return;
  returnPalletById(activePalletScan);
  activePalletScan = null;
  updatePalletScanUI();
}

/* =========================
   SCANNER INPUT HANDLER
   ========================= */
function addScannedBarcode(code) {
  if (!code) return;
  if (!hasPermission('scan')) { showNotification('No scan permission', 'error'); return; }
  
  if (scannerMode === 'pallet') {
    // Check if it's a pallet ID
    if (/^PAL[-_]/i.test(code)) {
      activePalletScan = code;
      updatePalletScanUI();
      showNotification(`üì¶ Pallet ${code} loaded`, 'success');
    } else {
      showNotification('‚ö†Ô∏è Invalid pallet ID. Expected PAL-xxx format', 'warning');
    }
    return;
  }
  
  // Bottle mode
  if (scannedBarcodes.length >= MAX_BARCODES) { showNotification('Max batch reached', 'warning'); return; }
  if (scannedBarcodes.includes(code)) { showNotification('Already in queue', 'warning'); return; }
  scannedBarcodes.push(code);
  updateScannedList();
  showNotification(`‚úÖ Added ${code}`, 'success', 1500);
  checkAutoCreatePallet();
}

function clearAllScanned() { 
  scannedBarcodes = []; 
  updateScannedList(); 
  showNotification('Queue cleared', 'info');
}

/* =========================
   BOTTLE BATCH ACTIONS
   ========================= */
function batchRefill() {
  if (!scannedBarcodes.length) return showNotification('Queue is empty', 'warning');
  if (!hasPermission('refill')) return showNotification('No refill permission', 'error');
  
  scannedBarcodes.forEach(id => {
    let b = bottles.find(x => x.id === id) || createNewBottleRecord(id, 'available');
    b.status = 'available';
    b.clientId = ''; b.clientName = ''; b.clientPhone = '';
    b.refillCount = (b.refillCount||0) + 1;
    b.lastUpdated = new Date().toISOString();
    b.history.push({ action: 'Batch refilled', timestamp: new Date().toISOString(), user: currentUser.name });
  });
  
  addActivity(`üîÑ Batch refilled ${scannedBarcodes.length} bottles by ${currentUser.name}`);
  showNotification(`‚úÖ Refilled ${scannedBarcodes.length} bottles`, 'success');
  saveData();
  updateAllDisplays();
  clearAllScanned();
}

function batchReturn() {
  if (!scannedBarcodes.length) return showNotification('Queue is empty', 'warning');
  if (!hasPermission('return')) return showNotification('No return permission', 'error');
  
  scannedBarcodes.forEach(id => {
    let b = bottles.find(x => x.id === id) || createNewBottleRecord(id, 'needs-refill');
    b.status = 'needs-refill';
    b.clientId = ''; b.clientName = ''; b.clientPhone = '';
    b.lastUpdated = new Date().toISOString();
    b.history.push({ action: 'Batch returned', timestamp: new Date().toISOString(), user: currentUser.name });
  });
  
  addActivity(`‚Ü©Ô∏è Batch returned ${scannedBarcodes.length} bottles by ${currentUser.name}`);
  showNotification(`‚úÖ Returned ${scannedBarcodes.length} bottles`, 'success');
  saveData();
  updateAllDisplays();
  clearAllScanned();
}

function batchDeliver() {
  if (!scannedBarcodes.length) return showNotification('Queue is empty', 'warning');
  if (!hasPermission('deliver')) return showNotification('No deliver permission', 'error');
  openDeliveryModal();
}

function confirmBatchDelivery() {
  if (!hasPermission('deliver')) return showNotification('No deliver permission', 'error');
  
  let client = null;
  if (deliveryClientMode === 'existing') {
    const id = document.getElementById('delivery-client-select').value;
    client = clients.find(c => c.id === id);
  } else {
    const name = document.getElementById('delivery-new-client-name').value.trim();
    const phone = document.getElementById('delivery-new-client-phone').value.trim();
    const address = document.getElementById('delivery-new-client-address').value.trim();
    if (!name || !phone) return alert('Enter client name and phone');
    client = createNewClientRecord({ name, phone, address });
  }
  if (!client) return alert('Select or create client');

  const unavailable = scannedBarcodes.filter(id => {
    const b = bottles.find(x => x.id === id);
    return b && b.status !== 'available';
  });
  if (unavailable.length) { return alert(`Cannot deliver. ${unavailable.length} not available:\n${unavailable.join(', ')}`); }

  scannedBarcodes.forEach(id => {
    const b = bottles.find(x => x.id === id) || createNewBottleRecord(id, 'available');
    b.status = 'with-client';
    b.deliveryCount = (b.deliveryCount||0) + 1;
    b.clientId = client.id; b.clientName = client.name; b.clientPhone = client.phone;
    b.lastUpdated = new Date().toISOString();
    b.history.push({ action: `Delivered to ${client.name}`, timestamp: new Date().toISOString(), user: currentUser.name });
    autoRemoveFromPallet(id);
  });
  
  updateClientBottleCounts();
  addActivity(`üöö Delivered ${scannedBarcodes.length} bottles to ${client.name} by ${currentUser.name}`);
  showNotification(`‚úÖ Delivered ${scannedBarcodes.length} bottles to ${client.name}`, 'success');
  saveData();
  updateAllDisplays();
  closeDeliveryModal();
  clearAllScanned();
}

/* =========================
   PALLET ACTIONS
   ========================= */
function deliverPalletById(palletId) {
  if (!hasPermission('deliver')) return showNotification('No deliver permission', 'error');
  const pallet = findPalletById(palletId);
  if (!pallet) return alert('Pallet not found');
  if (!pallet.bottleIds.length) return alert('Pallet is empty');
  scannedBarcodes = [...pallet.bottleIds];
  closePalletDetails();
  batchDeliver();
}

function returnPalletById(palletId) {
  if (!hasPermission('return')) return showNotification('No return permission', 'error');
  const pallet = findPalletById(palletId);
  if (!pallet) return alert('Pallet not found');
  
  pallet.bottleIds.forEach(id => {
    const b = bottles.find(x => x.id === id) || createNewBottleRecord(id, 'needs-refill');
    b.status = 'needs-refill';
    b.clientId = ''; b.clientName = ''; b.clientPhone = '';
    b.lastUpdated = new Date().toISOString();
    b.history.push({ action: `Returned from pallet ${pallet.id}`, timestamp: new Date().toISOString(), user: currentUser.name });
  });
  
  pallet.clientId = '';
  pallet.history.push({ action: 'Returned to store', timestamp: new Date().toISOString(), user: currentUser.name });
  recalcPalletStatus(pallet);
  addActivity(`‚Ü©Ô∏è Pallet ${pallet.id} returned (${pallet.bottleIds.length} bottles) by ${currentUser.name}`);
  showNotification(`‚úÖ Pallet ${pallet.id} returned`, 'success');
  saveData();
  updateAllDisplays();
}

function refillPalletById(palletId) {
  if (!hasPermission('refill')) return showNotification('No refill permission', 'error');
  const pallet = findPalletById(palletId);
  if (!pallet) return alert('Pallet not found');
  
  pallet.bottleIds.forEach(id => {
    const b = bottles.find(x => x.id === id) || createNewBottleRecord(id, 'available');
    b.status = 'available';
    b.clientId = ''; b.clientName = ''; b.clientPhone = '';
    b.refillCount = (b.refillCount||0) + 1;
    b.lastUpdated = new Date().toISOString();
    b.history.push({ action: `Refilled from pallet ${pallet.id}`, timestamp: new Date().toISOString(), user: currentUser.name });
  });
  
  pallet.history.push({ action: 'Batch refilled', timestamp: new Date().toISOString(), user: currentUser.name });
  recalcPalletStatus(pallet);
  addActivity(`üîÑ Pallet ${pallet.id} refilled (${pallet.bottleIds.length} bottles) by ${currentUser.name}`);
  showNotification(`‚úÖ Pallet ${pallet.id} refilled`, 'success');
  saveData();
  updateAllDisplays();
}

/* =========================
   ADMIN DELETE ACTIONS
   ========================= */
function deleteBottle(id) {
  if (!hasPermission('delete_bottle')) return alert('No delete permission');
  const b = bottles.find(x => x.id === id);
  if (!b) return alert('Bottle not found');
  if (!confirm(`Delete bottle ${id}? This cannot be undone.`)) return;

  pallets.forEach(p => {
    if (p.bottleIds.includes(id)) {
      p.bottleIds = p.bottleIds.filter(x => x !== id);
      recalcPalletStatus(p);
    }
  });

  scannedBarcodes = scannedBarcodes.filter(x => x !== id);
  bottles = bottles.filter(x => x.id !== id);

  updateClientBottleCounts();
  addActivity(`üóëÔ∏è Deleted bottle ${id} by ${currentUser.name}`);
  saveData();
  updateAllDisplays();
  showNotification(`Bottle ${id} deleted`, 'success');
}

function deletePallet(palletId) {
  if (!hasPermission('delete_pallet')) return alert('No delete permission');
  const pallet = findPalletById(palletId);
  if (!pallet) return alert('Pallet not found');
  if (!confirm(`Delete pallet ${palletId}? Bottles will remain in inventory.`)) return;

  pallet.bottleIds.forEach(id => {
    const b = bottles.find(x => x.id === id);
    if (b) b.palletId = '';
  });

  pallets = pallets.filter(p => p.id !== palletId);
  addActivity(`üóëÔ∏è Deleted pallet ${palletId} by ${currentUser.name}`);
  saveData();
  updateAllDisplays();
  closePalletDetails();
  showNotification(`Pallet ${palletId} deleted`, 'success');
}

/* =========================
   UI RENDERING
   ========================= */
function renderPallets(items=pallets) {
  const host = document.getElementById('pallet-grid');
  document.getElementById('pallet-count').textContent = String(pallets.length);
  if (!items.length) { 
    host.innerHTML = '<div class="empty-state"><div class="icon">üì¶</div><div class="message">No pallets yet. Scan 32 bottles to auto-create one!</div></div>'; 
    return; 
  }
  host.innerHTML = items.map(p => `
    <div class="pallet-card" onclick="openPalletDetails('${p.id}')" style="cursor:pointer;">
      <div class="pallet-id">üì¶ ${p.name}</div>
      <div class="status ${p.status}">${p.status.toUpperCase()}</div>
      <div class="stats-mini">
        <div class="stat-badge">üß¥ ${p.bottleIds.length}/${p.capacity}</div>
        <div class="stat-badge">üìÖ ${new Date(p.created).toLocaleDateString()}</div>
      </div>
      <div class="progress-bar" style="margin:10px 0;">
        <div class="progress-fill" style="width:${(p.bottleIds.length/p.capacity*100).toFixed(0)}%;">${p.bottleIds.length} / ${p.capacity}</div>
      </div>
      ${hasPermission('delete_pallet') ? `<button class="btn btn-sm btn-danger badge-danger" onclick="event.stopPropagation(); deletePallet('${p.id}')">üóëÔ∏è</button>` : ''}
    </div>
  `).join('');
}

function openPalletDetails(palletId) {
  const pallet = findPalletById(palletId);
  if (!pallet) return;
  currentPalletId = pallet.id;
  document.getElementById('pallet-detail-title').textContent = `üì¶ ${pallet.name}`;
  document.getElementById('pallet-detail-info').innerHTML = `
    <div class="status ${pallet.status}">${pallet.status.toUpperCase()}</div>
    <div class="stats-mini">
      <div class="stat-badge">üß¥ ${pallet.bottleIds.length}/${pallet.capacity}</div>
      <div class="stat-badge">üìÖ ${new Date(pallet.created).toLocaleString()}</div>
    </div>
  `;
  const bottleList = document.getElementById('pallet-detail-bottles');
  if (!pallet.bottleIds.length) {
    bottleList.innerHTML = '<div class="empty-state" style="padding:20px;"><div class="message">No bottles in this pallet</div></div>';
  } else {
    bottleList.innerHTML = '<div style="font-weight:700; margin-bottom:8px; color:#1565c0;">Bottle IDs:</div>' +
      pallet.bottleIds.map((id, idx) => {
        const b = bottles.find(x => x.id === id);
        return `<div><strong>${idx+1}.</strong> ${id} ${b ? `<span class="status ${b.status}" style="padding:3px 8px; font-size:0.75rem; margin-left:8px;">${b.status}</span>` : ''}</div>`;
      }).join('');
  }
  
  // Show/hide action buttons based on permissions
  document.getElementById('btn-detail-refill').style.display = hasPermission('refill') ? 'inline-block' : 'none';
  document.getElementById('btn-detail-deliver').style.display = hasPermission('deliver') ? 'inline-block' : 'none';
  document.getElementById('btn-detail-return').style.display = hasPermission('return') ? 'inline-block' : 'none';
  document.getElementById('btn-detail-delete').style.display = hasPermission('delete_pallet') ? 'inline-block' : 'none';
  
  document.getElementById('pallet-details-modal').style.display = 'flex';
}

function closePalletDetails() { document.getElementById('pallet-details-modal').style.display = 'none'; }

function searchPallets() {
  const q = document.getElementById('search-pallets').value.trim().toLowerCase();
  const items = pallets.filter(p => p.id.toLowerCase().includes(q) || p.name.toLowerCase().includes(q));
  renderPallets(items);
}

function filterPallets() {
  const s = document.getElementById('filter-pallet-status').value;
  const items = s ? pallets.filter(p => p.status === s) : pallets;
  renderPallets(items);
}

function renderInventory(items=bottles) {
  const host = document.getElementById('bottle-inventory');
  document.getElementById('bottle-count').textContent = String(bottles.length);
  if (!items.length) { 
    host.innerHTML = '<div class="empty-state"><div class="icon">üß¥</div><div class="message">No bottles in inventory</div></div>'; 
    return; 
  }
  const canDelete = hasPermission('delete_bottle');
  host.innerHTML = items.map(b => `
    <div class="bottle-card">
      <div class="bottle-id">üß¥ ${b.id}</div>
      <div class="status ${b.status}">${b.status}</div>
      <div class="stats-mini">
        <div class="stat-badge">üì¶ ${b.palletId || 'None'}</div>
        <div class="stat-badge">üë§ ${b.clientName || 'No client'}</div>
      </div>
      <div class="small">üöö Deliveries: ${b.deliveryCount||0} ‚Ä¢ üîÑ Refills: ${b.refillCount||0}</div>
      <div class="right" style="margin-top:12px;">
        <button class="btn btn-sm" onclick="setBottleStatus('${b.id}','available')">‚úÖ Available</button>
        <button class="btn btn-sm btn-secondary" onclick="setBottleStatus('${b.id}','needs-refill')">‚ö†Ô∏è Needs Refill</button>
        <button class="btn btn-sm btn-warning" onclick="quickReturn('${b.id}')">‚Ü©Ô∏è Return</button>
        ${canDelete ? `<button class="btn btn-sm btn-danger" onclick="deleteBottle('${b.id}')">üóëÔ∏è</button>` : ''}
      </div>
    </div>
  `).join('');
}

function setBottleStatus(id, status) {
  let b = bottles.find(x => x.id === id);
  if (!b) b = createNewBottleRecord(id, status);
  b.status = status;
  if (status !== 'with-client') { b.clientId=''; b.clientName=''; b.clientPhone=''; }
  b.lastUpdated = new Date().toISOString();
  b.history.push({ action: `Status changed to ${status}`, timestamp: new Date().toISOString(), user: currentUser.name });
  saveData();
  updateAllDisplays();
  showNotification(`Bottle ${id} set to ${status}`, 'success');
}

function quickReturn(id) {
  if (!hasPermission('return')) return showNotification('No return permission', 'error');
  let b = bottles.find(x => x.id === id) || createNewBottleRecord(id, 'needs-refill');
  b.status = 'needs-refill';
  b.clientId=''; b.clientName=''; b.clientPhone='';
  b.lastUpdated = new Date().toISOString();
  b.history.push({ action: 'Quick returned', timestamp: new Date().toISOString(), user: currentUser.name });
  saveData();
  updateAllDisplays();
  showNotification(`Bottle ${id} returned`, 'success');
}

function addBottlePrompt() {
  if (!hasPermission('add_bottle')) return showNotification('No add bottle permission', 'error');
  const id = prompt('Enter new bottle ID:');
  if (!id) return;
  if (bottles.some(x => x.id === id)) return alert('Bottle ID already exists');
  createNewBottleRecord(id, 'available');
  saveData();
  updateAllDisplays();
  showNotification(`Bottle ${id} added`, 'success');
}

function searchBottles() {
  const q = document.getElementById('search-bottles').value.trim().toLowerCase();
  const items = bottles.filter(b => b.id.toLowerCase().includes(q));
  renderInventory(items);
}

function filterBottles() {
  const s = document.getElementById('filter-status').value;
  const items = s ? bottles.filter(b => b.status === s) : bottles;
  renderInventory(items);
}

function renderClients(items=clients) {
  const host = document.getElementById('client-list');
  document.getElementById('client-count').textContent = String(clients.length);
  if (!items.length) { 
    host.innerHTML = '<div class="empty-state"><div class="icon">üë•</div><div class="message">No clients yet</div></div>'; 
    return; 
  }
  host.innerHTML = items.map(c => `
    <div class="bottle-card">
      <div class="bottle-id">üë§ ${c.name}</div>
      <div class="stats-mini">
        <div class="stat-badge">üìû ${c.phone}</div>
        <div class="stat-badge">üß¥ ${c.bottleCount||0} bottles</div>
      </div>
      ${c.address ? `<div class="small">üìç ${c.address}</div>` : ''}
    </div>
  `).join('');
}

function searchClients() {
  const q = document.getElementById('search-clients').value.trim().toLowerCase();
  const items = clients.filter(c => c.name.toLowerCase().includes(q) || c.phone.toLowerCase().includes(q));
  renderClients(items);
}

function openAddClient() { 
  if (!hasPermission('add_client')) return showNotification('No add client permission', 'error');
  document.getElementById('add-client-modal').style.display = 'flex'; 
}
function closeAddClient() { document.getElementById('add-client-modal').style.display = 'none'; }
function createNewClient() {
  const name = document.getElementById('new-client-name').value.trim();
  const phone = document.getElementById('new-client-phone').value.trim();
  const address = document.getElementById('new-client-address').value.trim();
  if (!name || !phone) return alert('Enter name and phone');
  createNewClientRecord({ name, phone, address });
  closeAddClient();
  renderClients();
  populateClientDropdowns();
  showNotification(`Client ${name} created`, 'success');
}

function updateActivity() {
  const host = document.getElementById('activity-list');
  if (!activityLog.length) { 
    host.innerHTML = '<div class="empty-state"><div class="icon">üìã</div><div class="message">No activity yet</div></div>'; 
    return; 
  }
  host.innerHTML = activityLog.slice(0,100).map(a => `
    <div class="scanned-item">
      <div>
        <div style="font-weight:600; color:#1565c0;">${a.message}</div>
        <div class="small">üìÖ ${new Date(a.timestamp).toLocaleString()} ‚Ä¢ üë§ ${a.user || 'System'}</div>
      </div>
    </div>
  `).join('');
}

function openDeliveryModal() {
  populateClientDropdowns();
  toggleClientMode('existing');
  document.getElementById('delivery-date').valueAsDate = new Date();
  const t = new Date(); 
  document.getElementById('delivery-time').value = `${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;
  document.getElementById('delivery-modal').style.display = 'flex';
}

function closeDeliveryModal() { document.getElementById('delivery-modal').style.display = 'none'; }

function toggleClientMode(mode) {
  deliveryClientMode = mode;
  document.getElementById('existing-client-section').style.display = mode==='existing' ? 'block' : 'none';
  document.getElementById('new-client-section').style.display = mode==='new' ? 'block' : 'none';
  document.getElementById('existing-client-btn').className = mode==='existing' ? 'btn btn-sm' : 'btn btn-sm btn-secondary';
  document.getElementById('new-client-btn').className = mode==='new' ? 'btn btn-sm' : 'btn btn-sm btn-secondary';
}

function populateClientDropdowns() {
  const sel = document.getElementById('delivery-client-select');
  sel.innerHTML = clients.map(c => `<option value="${c.id}">${c.name} ‚Äî ${c.phone}</option>`).join('');
}

function filterDeliveryClients() {
  const q = document.getElementById('delivery-client-search').value.trim().toLowerCase();
  const sel = document.getElementById('delivery-client-select');
  const items = clients.filter(c => c.name.toLowerCase().includes(q) || c.phone.toLowerCase().includes(q));
  sel.innerHTML = items.map(c => `<option value="${c.id}">${c.name} ‚Äî ${c.phone}</option>`).join('');
}

function updateScannedList() {
  const host = document.getElementById('scanned-items-container');
  const count = scannedBarcodes.length;
  document.getElementById('scanned-count').textContent = String(count);
  document.getElementById('btn-batch-refill').textContent = `üîÑ Refill Queue (${count})`;
  document.getElementById('btn-batch-deliver').textContent = `üöö Deliver Queue (${count})`;
  document.getElementById('btn-batch-return').textContent = `‚Ü©Ô∏è Return Queue (${count})`;

  const pct = Math.min((count / PALLET_CAPACITY * 100), 100).toFixed(0);
  const fill = document.getElementById('progress-fill');
  fill.style.width = pct + '%';
  fill.textContent = `${count} / ${PALLET_CAPACITY}`;

  if (!count) {
    host.innerHTML = '<div class="empty-state"><div class="icon">üìã</div><div class="message">No bottles scanned yet</div></div>';
    return;
  }
  host.innerHTML = scannedBarcodes.map(code => `
    <div class="scanned-item">
      <div class="scanned-item-code">üß¥ ${code}</div>
      <button class="remove-btn" onclick="removeFromQueue('${code}')" title="Remove">√ó</button>
    </div>
  `).join('');
}

function removeFromQueue(code) {
  scannedBarcodes = scannedBarcodes.filter(x => x !== code);
  updateScannedList();
}

function openTab(id, btn) {
  document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.getElementById('barcode-input').focus();
}

function logout() { 
  if (confirm('Logout and clear session?')) {
    showNotification('Logged out', 'success'); 
    // In production, redirect to login page
  }
}

function updateAllDisplays() {
  renderInventory();
  renderClients();
  renderPallets();
  updateActivity();
  updateUIPermissions();
}

/* =========================
   INITIALIZATION
   ========================= */
document.addEventListener('DOMContentLoaded', () => {
  loadData();
  updateAllDisplays();
  updateUIPermissions();

  const inp = document.getElementById('barcode-input');

  // Auto-include when length < 4 (non-empty), then clear
  inp.addEventListener('input', () => {
    const code = inp.value.trim();
    if (code && code.length < 4) {
      addScannedBarcode(code);
      inp.value = '';
    }
  });

  // Enter to include any length
  inp.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const code = inp.value.trim();
      if (!code) return;
      addScannedBarcode(code);
      inp.value = '';
    }
  });

  // Keep focus for hardware scanners
  setInterval(() => { 
    if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'SELECT' && document.activeElement.tagName !== 'TEXTAREA') {
      inp.focus(); 
    }
  }, 2000);
});
</script>
</body>
</html>
