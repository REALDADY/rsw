<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>5-Gallon Bottle Tracking System</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  * { box-sizing: border-box; }
  body { 
    background: linear-gradient(135deg,#e3f2fd 0%,#f8f9fa 100%); 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    color: #222; margin: 0; padding: 0; min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }
  .container { 
    max-width: 1300px; margin: 10px auto; background: #fff; 
    border-radius: 20px; box-shadow: 0 10px 40px rgba(33,150,243,0.1); 
    padding: 20px 16px; position: relative;
  }
  
  @media (min-width: 768px) {
    .container { margin: 20px auto; padding: 36px 28px; }
  }
  
  .header { 
    text-align: center; margin-bottom: 20px; position: relative; 
    padding-bottom: 16px; border-bottom: 2px solid #e3f2fd; 
  }
  .header h1 { 
    margin: 0 0 8px 0; font-size: 1.4rem; color: #1565c0; 
    padding-right: 0; line-height: 1.3;
  }
  .header .subtitle { 
    font-size: 0.8rem; color: #6c757d; line-height: 1.4; 
    padding: 0 10px;
  }
  
  @media (min-width: 768px) {
    .header h1 { font-size: 2rem; padding-right: 140px; }
    .header .subtitle { font-size: 0.95rem; padding: 0; }
  }
  
  .export-badge { 
    position: static; 
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); 
    border-radius: 15px; padding: 10px 16px; display: flex; 
    align-items: center; justify-content: center; gap: 10px; 
    box-shadow: 0 4px 12px rgba(67,233,123,0.25); color: white; 
    cursor: pointer; transition: all 0.3s; margin: 10px auto 0; 
    max-width: 280px; font-size: 0.9rem;
  }
  
  @media (min-width: 768px) {
    .export-badge {
      position: absolute; top: 0; right: 0; margin: 0;
      padding: 12px 20px; max-width: none; font-size: 1rem;
    }
  }
  
  .export-badge:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 6px 20px rgba(67,233,123,0.35); 
  }
  .export-badge:active { transform: translateY(0); }
  
  .tabs { 
    display: flex; justify-content: center; gap: 6px; margin-bottom: 20px; 
    flex-wrap: wrap; padding: 0 5px; overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  @media (min-width: 768px) {
    .tabs { gap: 10px; margin-bottom: 32px; padding: 0 10px; }
  }
  
  .tab { 
    background: linear-gradient(90deg,#2196F3 0%,#20c997 100%); 
    color: #fff; border: none; border-radius: 20px; 
    padding: 10px 16px; font-size: 0.85rem; font-weight: 600; 
    cursor: pointer; transition: all 0.3s; 
    box-shadow: 0 3px 10px rgba(33,150,243,0.15);
    letter-spacing: 0.3px; white-space: nowrap;
    -webkit-tap-highlight-color: transparent;
  }
  
  @media (min-width: 768px) {
    .tab { 
      border-radius: 28px; padding: 13px 30px; 
      font-size: 1.05rem; 
    }
  }
  
  .tab:not(.active):hover { 
    background: linear-gradient(90deg,#20c997 0%,#2196F3 100%); 
  }
  .tab:not(.active):active { 
    transform: scale(0.95); 
  }
  .tab.active { 
    background: linear-gradient(90deg,#1565c0 0%,#43e97b 100%); 
    box-shadow: 0 5px 20px rgba(33,150,243,0.3);
  }
  
  .tab-content { display: none; animation: fadeIn 0.4s ease-in-out; }
  .tab-content.active { display: block; }
  @keyframes fadeIn { 
    from {opacity: 0; transform: translateY(20px);} 
    to {opacity:1; transform: translateY(0);} 
  }

  .scanner-container { 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
    border-radius: 15px; padding: 20px 16px; margin: 15px 0; 
    color: white; text-align: center;
    box-shadow: 0 8px 24px rgba(102,126,234,0.3);
  }
  
  @media (min-width: 768px) {
    .scanner-container { 
      border-radius: 18px; padding: 30px; margin: 20px 0; 
    }
  }
  
  .scanner-container h3 { 
    margin: 0 0 8px 0; font-size: 1.2rem; 
  }
  
  @media (min-width: 768px) {
    .scanner-container h3 { font-size: 1.5rem; margin: 0 0 10px 0; }
  }
  
  .scanner-status { 
    margin-top: 8px; padding: 10px 16px; border-radius: 12px; 
    background: rgba(255,255,255,0.2); display: inline-block; 
    font-weight: 600; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    font-size: 0.9rem;
  }
  
  @media (min-width: 768px) {
    .scanner-status { 
      margin-top: 10px; padding: 12px 20px; 
      border-radius: 14px; font-size: 1rem; 
    }
  }
  
  .barcode-input-large { 
    width: 100%; font-size: 1.1rem; padding: 14px 16px; 
    border-radius: 12px; border: 3px solid rgba(255,255,255,0.3); 
    outline: none; margin-top: 10px; transition: all 0.3s; 
    font-weight: 600; text-align: center;
  }
  
  @media (min-width: 768px) {
    .barcode-input-large { 
      font-size: 1.3rem; padding: 16px 20px; 
      border-radius: 14px; margin-top: 12px; 
    }
  }
  
  .barcode-input-large:focus { 
    border-color: #43e97b; 
    box-shadow: 0 0 0 4px rgba(67,233,123,0.2);
    transform: scale(1.01);
  }

  .mode-toggle { 
    background: rgba(255,255,255,0.15); border-radius: 10px; 
    padding: 12px; margin: 12px 0; display: flex; 
    align-items: center; gap: 8px; justify-content: center;
    flex-wrap: wrap;
  }
  
  @media (min-width: 768px) {
    .mode-toggle { 
      border-radius: 12px; padding: 16px; margin: 16px 0; gap: 12px; 
    }
  }
  
  .mode-toggle label { 
    display: flex; align-items: center; gap: 8px; cursor: pointer; 
    padding: 8px 12px; background: rgba(255,255,255,0.1); 
    border-radius: 8px; transition: all 0.3s; font-size: 0.9rem;
    -webkit-tap-highlight-color: transparent;
  }
  
  @media (min-width: 768px) {
    .mode-toggle label { 
      gap: 10px; padding: 10px 16px; border-radius: 10px; 
      font-size: 1rem; 
    }
  }
  
  .mode-toggle label:active { background: rgba(255,255,255,0.25); }
  .mode-toggle input[type="radio"] { 
    width: 18px; height: 18px; cursor: pointer; 
  }
  
  @media (min-width: 768px) {
    .mode-toggle input[type="radio"] { width: 20px; height: 20px; }
  }

  .scanned-list { 
    background: #fff; border-radius: 14px; 
    box-shadow: 0 4px 12px rgba(33,150,243,0.08); 
    padding: 16px; margin-top: 16px;
  }
  
  @media (min-width: 768px) {
    .scanned-list { 
      border-radius: 16px; padding: 22px; margin-top: 20px; 
    }
  }
  
  .scanned-list h3 { 
    color: #1565c0; margin: 0 0 10px 0; display: flex; 
    align-items: center; gap: 8px; font-size: 1.1rem;
    flex-wrap: wrap;
  }
  
  @media (min-width: 768px) {
    .scanned-list h3 { 
      margin: 0 0 12px 0; gap: 10px; font-size: 1.3rem; 
    }
  }
  
  .scanned-item { 
    display: flex; align-items: center; justify-content: space-between; 
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
    border-radius: 10px; padding: 12px 14px; margin: 6px 0;
    transition: all 0.2s; border-left: 4px solid #2196F3;
  }
  
  @media (min-width: 768px) {
    .scanned-item { 
      border-radius: 12px; padding: 14px 16px; margin: 8px 0; 
    }
  }
  
  .scanned-item:active { 
    background: linear-gradient(135deg, #e3f2fd 0%, #d1e7fd 100%); 
    transform: translateX(4px); 
  }
  .scanned-item-code { 
    font-weight: 700; color: #1565c0; font-size: 1rem; 
    word-break: break-all;
  }
  
  @media (min-width: 768px) {
    .scanned-item-code { font-size: 1.1rem; }
  }
  
  .remove-btn { 
    border: none; background: #dc3545; cursor: pointer; 
    color: white; font-size: 0.95rem; width: 30px; height: 30px; 
    border-radius: 50%; display: flex; align-items: center; 
    justify-content: center; transition: all 0.2s;
    -webkit-tap-highlight-color: transparent; flex-shrink: 0;
  }
  
  @media (min-width: 768px) {
    .remove-btn { 
      font-size: 1rem; width: 32px; height: 32px; 
    }
  }
  
  .remove-btn:active { 
    background: #c82333; transform: rotate(90deg) scale(1.1); 
  }

  .bottle-grid, #client-list, #pallet-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
    gap: 14px; margin-top: 16px;
  }
  
  @media (min-width: 768px) {
    .bottle-grid, #client-list, #pallet-grid { 
      grid-template-columns: repeat(auto-fit,minmax(320px,1fr)); 
      gap: 20px; margin-top: 20px;
    }
  }
  
  .bottle-card, .pallet-card { 
    background: #fff; border-radius: 14px; 
    box-shadow: 0 4px 12px rgba(33,150,243,0.08); 
    padding: 18px; transition: all 0.3s; position: relative; 
    border: 2px solid transparent;
  }
  
  @media (min-width: 768px) {
    .bottle-card, .pallet-card { 
      border-radius: 16px; padding: 22px; 
    }
  }
  
  .bottle-card:active, .pallet-card:active { 
    box-shadow: 0 8px 28px rgba(33,150,243,0.15); 
    border-color: #2196F3; transform: translateY(-2px);
  }
  .bottle-id, .pallet-id { 
    font-size: 1.05rem; font-weight: bold; color: #1565c0; 
    margin-bottom: 8px; display: flex; align-items: center; 
    gap: 6px; word-break: break-word;
  }
  
  @media (min-width: 768px) {
    .bottle-id, .pallet-id { 
      font-size: 1.2rem; margin-bottom: 10px; gap: 8px; 
    }
  }
  
  .status { 
    display: inline-block; padding: 6px 12px; border-radius: 12px; 
    font-size: 0.8rem; font-weight: 700; margin-bottom: 8px;
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  
  @media (min-width: 768px) {
    .status { 
      padding: 7px 14px; border-radius: 14px; 
      font-size: 0.9rem; margin-bottom: 10px; 
    }
  }
  
  .status.available { background: #e3f2fd; color: #1976d2; }
  .status.with-client { background: #c8e6c9; color: #2e7d32; }
  .status.needs-refill { background: #fff3cd; color: #856404; }
  .status.empty { background: #f8d7da; color: #721c24; }
  .status.partial { background: #ffe5b4; color: #d97706; }
  .status.full { background: #d1f2eb; color: #0f5132; }

  .btn { 
    background: linear-gradient(90deg,#2196F3 0%,#20c997 100%); 
    color: #fff; border: none; border-radius: 22px; 
    padding: 10px 18px; font-size: 0.9rem; font-weight: 600; 
    cursor: pointer; margin: 4px; transition: all 0.3s;
    box-shadow: 0 3px 10px rgba(33,150,243,0.2); 
    letter-spacing: 0.3px;
    -webkit-tap-highlight-color: transparent;
    white-space: nowrap;
  }
  
  @media (min-width: 768px) {
    .btn { 
      border-radius: 28px; padding: 11px 22px; 
      font-size: 1rem; margin: 5px; 
    }
  }
  
  .btn:active { 
    background: linear-gradient(90deg,#20c997 0%,#2196F3 100%); 
    transform: translateY(0) scale(0.97); 
  }
  .btn-sm { padding: 7px 14px; font-size: 0.85rem; }
  
  @media (min-width: 768px) {
    .btn-sm { padding: 8px 16px; font-size: 0.9rem; }
  }
  
  .btn-success { 
    background: linear-gradient(90deg,#43e97b 0%,#38f9d7 100%); 
  }
  .btn-warning { 
    background: linear-gradient(90deg,#ffc107 0%,#ff9800 100%); 
  }
  .btn-danger { 
    background: linear-gradient(90deg,#dc3545 0%,#ff6a00 100%); 
  }
  .btn-secondary { 
    background: linear-gradient(90deg,#6c757d 0%,#b0bec5 100%); 
  }

  .small { font-size: 0.85rem; color: #6c757d; margin: 4px 0; }
  
  @media (min-width: 768px) {
    .small { font-size: 0.95rem; }
  }
  
  .search-row { 
    display: flex; flex-wrap: wrap; gap: 10px; align-items: stretch; 
    margin-bottom: 16px; padding: 12px; background: #f8f9fa; 
    border-radius: 10px;
  }
  
  @media (min-width: 768px) {
    .search-row { 
      gap: 14px; margin-bottom: 20px; padding: 16px; 
      border-radius: 12px; 
    }
  }
  
  .search-input, select, input, textarea { 
    font-size: 0.95rem; padding: 12px 14px; border-radius: 10px; 
    border: 2px solid #e9ecef; flex: 1; min-width: 150px;
    transition: all 0.3s;
  }
  
  @media (min-width: 768px) {
    .search-input, select, input, textarea { 
      font-size: 1rem; padding: 13px 16px; 
      border-radius: 12px; min-width: 200px; 
    }
  }
  
  .search-input:focus, select:focus, input:focus, textarea:focus {
    border-color: #2196F3; outline: none; 
    box-shadow: 0 0 0 3px rgba(33,150,243,0.1);
  }
  
  .modal { 
    display: none; position: fixed; z-index: 5000; left:0; top:0; 
    width:100vw; height:100vh; background: rgba(0,0,0,0.5); 
    align-items: center; justify-content: center; 
    backdrop-filter: blur(4px); padding: 10px;
  }
  .modal-content { 
    background: #fff; border-radius: 18px; 
    box-shadow: 0 10px 50px rgba(0,0,0,0.3); 
    padding: 24px 18px; max-width: 520px; width: 100%; 
    position: relative; animation: modalSlideIn 0.3s ease-out; 
    max-height: 90vh; overflow-y: auto;
  }
  
  @media (min-width: 768px) {
    .modal-content { 
      padding: 32px 26px; width: 92vw; 
      border-radius: 20px; 
    }
  }
  
  @keyframes modalSlideIn { 
    from {opacity:0; transform: scale(0.9) translateY(-20px);} 
    to {opacity:1; transform: scale(1) translateY(0);} 
  }
  .close { 
    position: absolute; top: 12px; right: 16px; 
    font-size: 1.8rem; color: #2196F3; cursor: pointer; 
    font-weight: bold; transition: all 0.2s; 
    width: 34px; height: 34px; display: flex; 
    align-items: center; justify-content: center;
    border-radius: 50%; background: #e3f2fd;
    -webkit-tap-highlight-color: transparent;
  }
  
  @media (min-width: 768px) {
    .close { 
      top: 16px; right: 20px; font-size: 2rem; 
      width: 36px; height: 36px; 
    }
  }
  
  .close:active { 
    background: #2196F3; color: white; 
    transform: rotate(90deg); 
  }

  .toast { 
    position: fixed; right: 10px; top: 10px; z-index: 6000; 
    display: flex; flex-direction: column; gap: 10px; 
    max-width: calc(100vw - 20px);
  }
  
  @media (min-width: 768px) {
    .toast { right: 20px; top: 20px; max-width: 400px; gap: 12px; }
  }
  
  .toast-item { 
    background: #fff; border-left: 5px solid #2196F3; 
    border-radius: 10px; padding: 12px 16px; 
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    animation: toastSlideIn 0.3s ease-out; font-size: 0.9rem;
  }
  
  @media (min-width: 768px) {
    .toast-item { 
      border-left: 6px solid #2196F3; 
      border-radius: 12px; padding: 14px 18px; 
      font-size: 1rem; 
    }
  }
  
  @keyframes toastSlideIn { 
    from {opacity:0; transform: translateX(100%);} 
    to {opacity:1; transform: translateX(0);} 
  }
  .toast-item.success { 
    border-color: #28a745; background: #d4edda; 
  }
  .toast-item.warning { 
    border-color: #ff9800; background: #fff3cd; 
  }
  .toast-item.error { 
    border-color: #dc3545; background: #f8d7da; 
  }
  
  .right { text-align: right; }
  
  .bottle-list-mini { 
    background: #f8f9fa; border-radius: 8px; padding: 12px; 
    margin: 10px 0; max-height: 180px; overflow-y: auto;
    border: 2px solid #e9ecef; font-size: 0.9rem;
  }
  
  @media (min-width: 768px) {
    .bottle-list-mini { 
      border-radius: 10px; padding: 14px; margin: 12px 0; 
      max-height: 200px; font-size: 0.95rem; 
    }
  }
  
  .bottle-list-mini div { 
    padding: 5px 0; font-size: 0.85rem; 
    border-bottom: 1px solid #e9ecef; 
  }
  
  @media (min-width: 768px) {
    .bottle-list-mini div { padding: 6px 0; font-size: 0.95rem; }
  }
  
  .bottle-list-mini div:last-child { border-bottom: none; }
  
  .progress-bar { 
    background: #e9ecef; border-radius: 8px; height: 24px; 
    overflow: hidden; margin: 10px 0; position: relative;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
  }
  
  @media (min-width: 768px) {
    .progress-bar { 
      border-radius: 10px; height: 28px; margin: 12px 0; 
    }
  }
  
  .progress-fill { 
    background: linear-gradient(90deg,#43e97b 0%,#38f9d7 100%); 
    height: 100%; transition: width 0.4s ease; display: flex; 
    align-items: center; justify-content: center; color: #fff; 
    font-weight: 800; font-size: 0.85rem; letter-spacing: 0.5px;
  }
  
  @media (min-width: 768px) {
    .progress-fill { font-size: 0.95rem; }
  }
  
  .badge-danger { 
    position: absolute; top: 8px; right: 8px; z-index: 10;
  }
  
  @media (min-width: 768px) {
    .badge-danger { top: 10px; right: 10px; }
  }
  
  .stats-mini { 
    display: flex; gap: 6px; margin: 8px 0; flex-wrap: wrap;
  }
  
  @media (min-width: 768px) {
    .stats-mini { gap: 8px; margin: 10px 0; }
  }
  
  .stats-mini .stat-badge { 
    background: #e3f2fd; color: #1565c0; padding: 5px 10px; 
    border-radius: 7px; font-size: 0.8rem; font-weight: 700;
  }
  
  @media (min-width: 768px) {
    .stats-mini .stat-badge { 
      padding: 6px 12px; border-radius: 8px; 
      font-size: 0.85rem; 
    }
  }
  
  .section-header { 
    display: flex; justify-content: space-between; 
    align-items: center; margin-bottom: 16px; 
    padding-bottom: 10px; border-bottom: 2px solid #e3f2fd;
    flex-wrap: wrap; gap: 10px;
  }
  
  @media (min-width: 768px) {
    .section-header { 
      margin-bottom: 20px; padding-bottom: 12px; 
    }
  }
  
  .section-header h2 { 
    margin: 0; color: #1565c0; font-size: 1.3rem; 
  }
  
  @media (min-width: 768px) {
    .section-header h2 { font-size: 1.6rem; }
  }

  .empty-state { 
    text-align: center; padding: 40px 20px; color: #6c757d;
  }
  
  @media (min-width: 768px) {
    .empty-state { padding: 60px 20px; }
  }
  
  .empty-state .icon { 
    font-size: 3rem; margin-bottom: 12px; opacity: 0.5; 
  }
  
  @media (min-width: 768px) {
    .empty-state .icon { 
      font-size: 4rem; margin-bottom: 16px; 
    }
  }
  
  .empty-state .message { font-size: 1rem; }
  
  @media (min-width: 768px) {
    .empty-state .message { font-size: 1.1rem; }
  }
  
  /* Mobile action buttons stacking */
  @media (max-width: 767px) {
    .right { 
      text-align: center; 
      display: flex; 
      flex-direction: column; 
      gap: 8px; 
    }
    .right .btn { 
      margin: 0; 
      width: 100%; 
    }
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>🏭 5-Gallon Bottle Tracking</h1>
    <div class="subtitle">Auto-pallets at 32 • Track deliveries • Export Excel reports</div>
    <div class="export-badge" onclick="generateExcelReport()">
      <div style="text-align:center;">
        <div style="font-weight:700; font-size:1rem;">📊 Export Excel</div>
        <div style="font-size:0.75rem; opacity:0.9;">5 detailed sheets</div>
      </div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="openTab('scanner', this)">📱 Scanner</button>
    <button class="tab" onclick="openTab('pallets', this)">📦 Pallets</button>
    <button class="tab" onclick="openTab('inventory', this)">📊 Inventory</button>
    <button class="tab" onclick="openTab('clients', this)">👥 Clients</button>
    <button class="tab" onclick="openTab('activity', this)">📋 Activity</button>
  </div>

  <!-- SCANNER TAB -->
  <div id="scanner" class="tab-content active">
    <div class="scanner-container">
      <div style="font-size:2.5rem;margin-bottom:10px;">🔍</div>
      <h3>Barcode Scanner Active</h3>
      <div class="scanner-status" id="scanner-status">🟢 Ready</div>
      <div style="margin-top:16px;">
        <input id="barcode-input" class="barcode-input-large" placeholder="Scan 5+ chars..." autocomplete="off" autofocus>
      </div>
      
      <div class="mode-toggle">
        <label>
          <input type="radio" name="scanner-mode" value="bottle" checked onchange="setScannerMode('bottle')">
          <span style="font-weight:700;">🧴 Bottle</span>
        </label>
        <label>
          <input type="radio" name="scanner-mode" value="pallet" onchange="setScannerMode('pallet')">
          <span style="font-weight:700;">📦 Pallet</span>
        </label>
      </div>
      
      <div id="mode-help" class="small" style="opacity:0.9; margin-top:8px; background: rgba(255,255,255,0.15); padding:8px; border-radius:8px;">
        💡 <strong>Bottle Mode:</strong> Scan 5+ chars → auto-pallet at 32
      </div>
    </div>

    <!-- Bottle Queue -->
    <div class="scanned-list" id="bottle-queue">
      <h3>📋 Queue (<span id="scanned-count">0</span> / 32)</h3>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width:0%;">0 / 32</div>
      </div>
      <div id="scanned-items-container">
        <div class="empty-state">
          <div class="icon">📋</div>
          <div class="message">No bottles scanned</div>
        </div>
      </div>
      <div class="right" style="margin-top:14px;">
        <button class="btn btn-success" onclick="batchRefill()" id="btn-batch-refill">🔄 Refill (0)</button>
        <button class="btn btn-warning" onclick="batchDeliver()" id="btn-batch-deliver">🚚 Deliver (0)</button>
        <button class="btn btn-secondary" onclick="batchReturn()" id="btn-batch-return">↩️ Return (0)</button>
        <button class="btn btn-danger" onclick="clearAllScanned()">🗑️ Clear</button>
      </div>
    </div>

    <!-- Pallet Scanner Panel -->
    <div class="scanned-list" id="pallet-scanner-panel" style="display:none;">
      <h3>📦 Pallet Actions</h3>
      <div id="pallet-scan-info" class="small" style="margin-bottom:10px;">Scan pallet barcode (PAL-xxx)</div>
      <div id="pallet-scan-result"></div>
      <div class="right" style="margin-top:14px;">
        <button class="btn btn-success" onclick="quickRefillPallet()" id="btn-pallet-refill" disabled>🔄 Refill</button>
        <button class="btn btn-warning" onclick="quickDeliverPallet()" id="btn-pallet-deliver" disabled>🚚 Deliver</button>
        <button class="btn btn-secondary" onclick="quickReturnPallet()" id="btn-pallet-return" disabled>↩️ Return</button>
      </div>
    </div>
  </div>

  <!-- PALLETS TAB -->
  <div id="pallets" class="tab-content">
    <div class="section-header">
      <h2>📦 Pallets (<span id="pallet-count">0</span>)</h2>
    </div>
    <div class="search-row">
      <input id="search-pallets" class="search-input" placeholder="🔍 Search..." oninput="searchPallets()">
      <select id="filter-pallet-status" onchange="filterPallets()">
        <option value="">All</option>
        <option value="empty">Empty</option>
        <option value="partial">Partial</option>
        <option value="full">Full</option>
        <option value="with-client">With Client</option>
      </select>
    </div>
    <div id="pallet-grid" class="bottle-grid"></div>
  </div>

  <!-- INVENTORY TAB -->
  <div id="inventory" class="tab-content">
    <div class="section-header">
      <h2>📊 Inventory (<span id="bottle-count">0</span>)</h2>
      <div><button class="btn btn-sm" onclick="addBottlePrompt()">➕ Add</button></div>
    </div>
    <div class="search-row">
      <input id="search-bottles" class="search-input" placeholder="🔍 Search..." oninput="searchBottles()">
      <select id="filter-status" onchange="filterBottles()">
        <option value="">All</option>
        <option value="available">Available</option>
        <option value="with-client">With Client</option>
        <option value="needs-refill">Needs Refill</option>
      </select>
    </div>
    <div id="bottle-inventory" class="bottle-grid"></div>
  </div>

  <!-- CLIENTS TAB -->
  <div id="clients" class="tab-content">
    <div class="section-header">
      <h2>👥 Clients (<span id="client-count">0</span>)</h2>
      <div><button class="btn btn-sm btn-success" onclick="openAddClient()">➕ Add</button></div>
    </div>
    <div class="search-row">
      <input id="search-clients" class="search-input" placeholder="🔍 Search..." oninput="searchClients()">
    </div>
    <div id="client-list" class="bottle-grid"></div>
  </div>

  <!-- ACTIVITY TAB -->
  <div id="activity" class="tab-content">
    <div class="section-header">
      <h2>📋 Activity</h2>
      <button class="btn btn-sm btn-success" onclick="generateExcelReport()">📊 Export</button>
    </div>
    <div id="activity-list" class="scanned-list"></div>
  </div>
</div>

<!-- DELIVERY MODAL -->
<div id="delivery-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeDeliveryModal()">×</span>
    <h3 style="margin:0 0 14px 0; color:#1565c0; font-size:1.3rem;">🚚 Delivery</h3>
    <div style="display:flex; gap:8px; margin-bottom:14px;">
      <button class="btn btn-sm" id="existing-client-btn" onclick="toggleClientMode('existing')" style="flex:1;">Existing</button>
      <button class="btn btn-sm btn-secondary" id="new-client-btn" onclick="toggleClientMode('new')" style="flex:1;">New</button>
    </div>
    <div id="existing-client-section">
      <input id="delivery-client-search" placeholder="🔍 Search..." oninput="filterDeliveryClients()" style="margin-bottom:8px; width:100%;">
      <select id="delivery-client-select" size="5" style="width:100%;"></select>
    </div>
    <div id="new-client-section" style="display:none;">
      <input id="delivery-new-client-name" placeholder="Name *" style="width:100%; margin-bottom:8px;">
      <input id="delivery-new-client-phone" placeholder="Phone *" style="width:100%; margin-bottom:8px;">
      <input id="delivery-new-client-address" placeholder="Address" style="width:100%;">
    </div>
    <div style="display:flex; gap:8px; margin:14px 0;">
      <input type="date" id="delivery-date" style="flex:1;">
      <input type="time" id="delivery-time" style="flex:1;">
    </div>
    <div class="right">
      <button class="btn btn-success" onclick="confirmBatchDelivery()" style="width:100%;">✅ Confirm</button>
    </div>
  </div>
</div>

<!-- PALLET DETAILS MODAL -->
<div id="pallet-details-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closePalletDetails()">×</span>
    <h3 style="margin:0 0 14px 0; color:#1565c0; font-size:1.3rem;" id="pallet-detail-title">Pallet</h3>
    <div id="pallet-detail-info"></div>
    <div class="bottle-list-mini" id="pallet-detail-bottles"></div>
    <div class="right" style="margin-top:14px;">
      <button class="btn btn-success" onclick="refillPalletById(currentPalletId)">🔄 Refill All</button>
      <button class="btn btn-warning" onclick="deliverPalletById(currentPalletId)">🚚 Deliver All</button>
      <button class="btn btn-secondary" onclick="returnPalletById(currentPalletId)">↩️ Return All</button>
      <button class="btn btn-danger" onclick="deletePallet(currentPalletId)">🗑️ Delete</button>
    </div>
  </div>
</div>

<!-- ADD CLIENT MODAL -->
<div id="add-client-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeAddClient()">×</span>
    <h3 style="margin:0 0 14px 0; color:#1565c0; font-size:1.3rem;">➕ Add Client</h3>
    <input id="new-client-name" placeholder="Name *" style="width:100%; margin-bottom:10px;">
    <input id="new-client-phone" placeholder="Phone *" style="width:100%; margin-bottom:10px;">
    <input id="new-client-address" placeholder="Address" style="width:100%; margin-bottom:14px;">
    <div class="right">
      <button class="btn btn-success" onclick="createNewClient()" style="width:100%;">✅ Create</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* Same JavaScript as before - no changes needed */
const STORAGE_KEY = 'bottle_app_v5_excel';
const PALLET_CAPACITY = 32;
const MAX_BARCODES = 500;

let bottles = [];
let clients = [];
let pallets = [];
let activityLog = [];
let deletedRecords = [];
let scannedBarcodes = [];

let deliveryClientMode = 'existing';
let currentPalletId = '';
let scannerMode = 'bottle';
let activePalletScan = null;

function saveData() {
  const payload = { bottles, clients, pallets, activityLog, deletedRecords, lastUpdated: new Date().toISOString() };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
}

function loadData() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return;
  try {
    const data = JSON.parse(raw);
    bottles = Array.isArray(data.bottles) ? data.bottles : [];
    clients = Array.isArray(data.clients) ? data.clients : [];
    pallets = Array.isArray(data.pallets) ? data.pallets : [];
    activityLog = Array.isArray(data.activityLog) ? data.activityLog : [];
    deletedRecords = Array.isArray(data.deletedRecords) ? data.deletedRecords : [];
  } catch (e) { console.error('Load error:', e); }
}

function addActivity(msg) {
  activityLog.unshift({ id: 'act_' + Date.now(), message: msg, timestamp: new Date().toISOString() });
  updateActivity();
  saveData();
}

function showNotification(text, type='info', timeout=3000) {
  const host = document.getElementById('toast');
  const el = document.createElement('div');
  el.className = 'toast-item ' + (type==='success'?'success':type==='warning'?'warning':type==='error'?'error':'');
  el.textContent = text;
  host.appendChild(el);
  setTimeout(() => { if(host.contains(el)) host.removeChild(el); }, timeout);
}

function createNewBottleRecord(id, status='available', palletId='') {
  const b = { 
    id, status, palletId, deliveryCount: 0, refillCount: 0, 
    clientId: '', clientName: '', clientPhone: '', 
    created: new Date().toISOString(), 
    lastUpdated: new Date().toISOString(), 
    history: [{ action: 'Created', timestamp: new Date().toISOString() }] 
  };
  bottles.push(b);
  return b;
}

function createNewClientRecord({ name, phone, address='' }) {
  const c = { 
    id: 'client_' + Date.now(), name, phone, address, 
    created: new Date().toISOString(), 
    lastUpdated: new Date().toISOString(), 
    bottleCount: 0, 
    history: [{ action: 'Client created', timestamp: new Date().toISOString() }] 
  };
  clients.push(c);
  saveData();
  return c;
}

function updateClientBottleCounts() {
  const counts = {};
  bottles.forEach(b => { if (b.clientId) counts[b.clientId] = (counts[b.clientId]||0) + 1; });
  clients.forEach(c => c.bottleCount = counts[c.id] || 0);
}

function createNewPalletRecord(name='') {
  const id = 'PAL-' + Date.now();
  const pallet = { 
    id, name: name || id, bottleIds: [], capacity: PALLET_CAPACITY, 
    status: 'empty', clientId: '', 
    created: new Date().toISOString(), 
    lastUpdated: new Date().toISOString(), 
    history: [{ action: 'Pallet created', timestamp: new Date().toISOString() }] 
  };
  pallets.push(pallet);
  return pallet;
}

function findPalletById(palletId) { return pallets.find(p => p.id === palletId); }

function recalcPalletStatus(pallet) {
  const count = pallet.bottleIds.length;
  if (pallet.clientId) pallet.status = 'with-client';
  else if (count === 0) pallet.status = 'empty';
  else if (count < pallet.capacity) pallet.status = 'partial';
  else if (count === pallet.capacity) {
    const anyNeeds = pallet.bottleIds.some(id => (bottles.find(b => b.id === id)?.status === 'needs-refill'));
    pallet.status = anyNeeds ? 'needs-refill' : 'full';
  }
  pallet.lastUpdated = new Date().toISOString();
}

function addBottleToPallet(pallet, bottleId) {
  if (pallet.bottleIds.includes(bottleId)) return false;
  if (pallet.bottleIds.length >= pallet.capacity) return false;
  let b = bottles.find(x => x.id === bottleId);
  if (!b) b = createNewBottleRecord(bottleId, 'available', pallet.id);
  else b.palletId = pallet.id;
  pallet.bottleIds.push(bottleId);
  recalcPalletStatus(pallet);
  return true;
}

function removeBottleFromPallet(pallet, bottleId) {
  pallet.bottleIds = pallet.bottleIds.filter(id => id !== bottleId);
  const b = bottles.find(x => x.id === bottleId);
  if (b) b.palletId = '';
  recalcPalletStatus(pallet);
  saveData();
}

function autoRemoveFromPallet(bottleId) {
  const b = bottles.find(x => x.id === bottleId);
  if (!b || !b.palletId) return;
  const pallet = findPalletById(b.palletId);
  if (!pallet) return;
  pallet.bottleIds = pallet.bottleIds.filter(id => id !== bottleId);
  b.palletId = '';
  recalcPalletStatus(pallet);
  pallet.history.push({ action: `Bottle ${bottleId} removed (delivered separately)`, timestamp: new Date().toISOString() });
}

function checkAutoCreatePallet() {
  if (scannedBarcodes.length === PALLET_CAPACITY) {
    const pallet = createNewPalletRecord();
    scannedBarcodes.forEach(bottleId => addBottleToPallet(pallet, bottleId));
    addActivity(`✅ Auto-created pallet ${pallet.id} with ${PALLET_CAPACITY} bottles`);
    showNotification(`✅ Pallet ${pallet.id} created with 32 bottles!`, 'success', 4000);
    scannedBarcodes = [];
    updateScannedList();
    saveData();
    updateAllDisplays();
  }
}

function setScannerMode(mode) {
  scannerMode = mode;
  document.getElementById('bottle-queue').style.display = mode === 'bottle' ? 'block' : 'none';
  document.getElementById('pallet-scanner-panel').style.display = mode === 'pallet' ? 'block' : 'none';
  document.getElementById('mode-help').innerHTML = mode === 'bottle' 
    ? '💡 <strong>Bottle Mode:</strong> Scan 5+ chars → auto-pallet at 32'
    : '💡 <strong>Pallet Mode:</strong> Scan pallet (PAL-xxx) for quick actions';
  document.getElementById('barcode-input').focus();
  activePalletScan = null;
  updatePalletScanUI();
}

function updatePalletScanUI() {
  const resultDiv = document.getElementById('pallet-scan-result');
  const btnRefill = document.getElementById('btn-pallet-refill');
  const btnDeliver = document.getElementById('btn-pallet-deliver');
  const btnReturn = document.getElementById('btn-pallet-return');
  
  if (!activePalletScan) {
    resultDiv.innerHTML = '<div class="empty-state"><div class="icon">📦</div><div class="message">Waiting for scan...</div></div>';
    btnRefill.disabled = true;
    btnDeliver.disabled = true;
    btnReturn.disabled = true;
    return;
  }
  
  const pallet = findPalletById(activePalletScan);
  if (!pallet) {
    resultDiv.innerHTML = '<div class="empty-state" style="padding:20px;"><div class="message" style="color:#dc3545;">❌ Not found</div></div>';
    btnRefill.disabled = true;
    btnDeliver.disabled = true;
    btnReturn.disabled = true;
    return;
  }
  
  resultDiv.innerHTML = `
    <div class="scanned-item" style="background: linear-gradient(135deg, #e3f2fd 0%, #d1e7fd 100%); border-left: 6px solid #2196F3;">
      <div>
        <div class="pallet-id">📦 ${pallet.name}</div>
        <div class="status ${pallet.status}">${pallet.status.toUpperCase()}</div>
        <div class="small">Bottles: ${pallet.bottleIds.length} / ${pallet.capacity}</div>
      </div>
    </div>
  `;
  
  btnRefill.disabled = false;
  btnDeliver.disabled = false;
  btnReturn.disabled = false;
}

function quickRefillPallet() {
  if (!activePalletScan) return;
  refillPalletById(activePalletScan);
  activePalletScan = null;
  updatePalletScanUI();
}

function quickDeliverPallet() {
  if (!activePalletScan) return;
  deliverPalletById(activePalletScan);
}

function quickReturnPallet() {
  if (!activePalletScan) return;
  returnPalletById(activePalletScan);
  activePalletScan = null;
  updatePalletScanUI();
}

function addScannedBarcode(code) {
  if (!code || code.length < 5) return;
  
  if (scannerMode === 'pallet') {
    if (/^PAL[-_]/i.test(code)) {
      activePalletScan = code;
      updatePalletScanUI();
      showNotification(`📦 Pallet ${code} loaded`, 'success');
    } else {
      showNotification('⚠️ Invalid pallet ID', 'warning');
    }
    return;
  }
  
  if (scannedBarcodes.length >= MAX_BARCODES) { showNotification('Max batch reached', 'warning'); return; }
  if (scannedBarcodes.includes(code)) { showNotification('Already in queue', 'warning'); return; }
  scannedBarcodes.push(code);
  updateScannedList();
  showNotification(`✅ Added ${code}`, 'success', 1500);
  checkAutoCreatePallet();
}

function clearAllScanned() { 
  scannedBarcodes = []; 
  updateScannedList(); 
  showNotification('Queue cleared', 'info');
}

function batchRefill() {
  if (!scannedBarcodes.length) return showNotification('Queue is empty', 'warning');
  
  scannedBarcodes.forEach(id => {
    let b = bottles.find(x => x.id === id) || createNewBottleRecord(id, 'available');
    b.status = 'available';
    b.clientId = ''; b.clientName = ''; b.clientPhone = '';
    b.refillCount = (b.refillCount||0) + 1;
    b.lastUpdated = new Date().toISOString();
    b.history.push({ action: 'Batch refilled', timestamp: new Date().toISOString() });
  });
  
  addActivity(`🔄 Batch refilled ${scannedBarcodes.length} bottles`);
  showNotification(`✅ Refilled ${scannedBarcodes.length} bottles`, 'success');
  saveData();
  updateAllDisplays();
  clearAllScanned();
}

function batchReturn() {
  if (!scannedBarcodes.length) return showNotification('Queue is empty', 'warning');
  
  scannedBarcodes.forEach(id => {
    let b = bottles.find(x => x.id === id) || createNewBottleRecord(id, 'needs-refill');
    b.status = 'needs-refill';
    b.clientId = ''; b.clientName = ''; b.clientPhone = '';
    b.lastUpdated = new Date().toISOString();
    b.history.push({ action: 'Batch returned', timestamp: new Date().toISOString() });
  });
  
  addActivity(`↩️ Batch returned ${scannedBarcodes.length} bottles`);
  showNotification(`✅ Returned ${scannedBarcodes.length} bottles`, 'success');
  saveData();
  updateAllDisplays();
  clearAllScanned();
}

function batchDeliver() {
  if (!scannedBarcodes.length) return showNotification('Queue is empty', 'warning');
  openDeliveryModal();
}

function confirmBatchDelivery() {
  let client = null;
  if (deliveryClientMode === 'existing') {
    const id = document.getElementById('delivery-client-select').value;
    client = clients.find(c => c.id === id);
  } else {
    const name = document.getElementById('delivery-new-client-name').value.trim();
    const phone = document.getElementById('delivery-new-client-phone').value.trim();
    const address = document.getElementById('delivery-new-client-address').value.trim();
    if (!name || !phone) return alert('Enter client name and phone');
    client = createNewClientRecord({ name, phone, address });
  }
  if (!client) return alert('Select or create client');

  const unavailable = scannedBarcodes.filter(id => {
    const b = bottles.find(x => x.id === id);
    return b && b.status !== 'available';
  });
  if (unavailable.length) { return alert(`Cannot deliver. ${unavailable.length} not available:\n${unavailable.join(', ')}`); }

  scannedBarcodes.forEach(id => {
    const b = bottles.find(x => x.id === id) || createNewBottleRecord(id, 'available');
    b.status = 'with-client';
    b.deliveryCount = (b.deliveryCount||0) + 1;
    b.clientId = client.id; b.clientName = client.name; b.clientPhone = client.phone;
    b.lastUpdated = new Date().toISOString();
    b.history.push({ action: `Delivered to ${client.name}`, timestamp: new Date().toISOString() });
    autoRemoveFromPallet(id);
  });
  
  updateClientBottleCounts();
  addActivity(`🚚 Delivered ${scannedBarcodes.length} bottles to ${client.name}`);
  showNotification(`✅ Delivered to ${client.name}`, 'success');
  saveData();
  updateAllDisplays();
  closeDeliveryModal();
  clearAllScanned();
}

function deliverPalletById(palletId) {
  const pallet = findPalletById(palletId);
  if (!pallet) return alert('Pallet not found');
  if (!pallet.bottleIds.length) return alert('Pallet is empty');
  scannedBarcodes = [...pallet.bottleIds];
  closePalletDetails();
  batchDeliver();
}

function returnPalletById(palletId) {
  const pallet = findPalletById(palletId);
  if (!pallet) return alert('Pallet not found');
  
  pallet.bottleIds.forEach(id => {
    const b = bottles.find(x => x.id === id) || createNewBottleRecord(id, 'needs-refill');
    b.status = 'needs-refill';
    b.clientId = ''; b.clientName = ''; b.clientPhone = '';
    b.lastUpdated = new Date().toISOString();
    b.history.push({ action: `Returned from pallet ${pallet.id}`, timestamp: new Date().toISOString() });
  });
  
  pallet.clientId = '';
  pallet.history.push({ action: 'Returned to store', timestamp: new Date().toISOString() });
  recalcPalletStatus(pallet);
  addActivity(`↩️ Pallet ${pallet.id} returned (${pallet.bottleIds.length} bottles)`);
  showNotification(`✅ Pallet ${pallet.id} returned`, 'success');
  saveData();
  updateAllDisplays();
}

function refillPalletById(palletId) {
  const pallet = findPalletById(palletId);
  if (!pallet) return alert('Pallet not found');
  
  pallet.bottleIds.forEach(id => {
    const b = bottles.find(x => x.id === id) || createNewBottleRecord(id, 'available');
    b.status = 'available';
    b.clientId = ''; b.clientName = ''; b.clientPhone = '';
    b.refillCount = (b.refillCount||0) + 1;
    b.lastUpdated = new Date().toISOString();
    b.history.push({ action: `Refilled from pallet ${pallet.id}`, timestamp: new Date().toISOString() });
  });
  
  pallet.history.push({ action: 'Batch refilled', timestamp: new Date().toISOString() });
  recalcPalletStatus(pallet);
  addActivity(`🔄 Pallet ${pallet.id} refilled (${pallet.bottleIds.length} bottles)`);
  showNotification(`✅ Pallet ${pallet.id} refilled`, 'success');
  saveData();
  updateAllDisplays();
}

function deleteBottle(id) {
  const b = bottles.find(x => x.id === id);
  if (!b) return alert('Bottle not found');
  if (!confirm(`Delete bottle ${id}?`)) return;

  deletedRecords.push({
    type: 'bottle',
    id: b.id,
    data: {...b},
    deletedAt: new Date().toISOString()
  });

  pallets.forEach(p => {
    if (p.bottleIds.includes(id)) {
      p.bottleIds = p.bottleIds.filter(x => x !== id);
      recalcPalletStatus(p);
    }
  });

  scannedBarcodes = scannedBarcodes.filter(x => x !== id);
  bottles = bottles.filter(x => x.id !== id);

  updateClientBottleCounts();
  addActivity(`🗑️ Deleted bottle ${id}`);
  saveData();
  updateAllDisplays();
  showNotification(`Bottle ${id} deleted`, 'success');
}

function deletePallet(palletId) {
  const pallet = findPalletById(palletId);
  if (!pallet) return alert('Pallet not found');
  if (!confirm(`Delete pallet ${palletId}?`)) return;

  deletedRecords.push({
    type: 'pallet',
    id: pallet.id,
    data: {...pallet},
    deletedAt: new Date().toISOString()
  });

  pallet.bottleIds.forEach(id => {
    const b = bottles.find(x => x.id === id);
    if (b) b.palletId = '';
  });

  pallets = pallets.filter(p => p.id !== palletId);
  addActivity(`🗑️ Deleted pallet ${palletId}`);
  saveData();
  updateAllDisplays();
  closePalletDetails();
  showNotification(`Pallet ${palletId} deleted`, 'success');
}

function generateExcelReport() {
  showNotification('📊 Generating Excel...', 'info', 2000);
  
  const deliveredBottles = bottles.filter(b => b.status === 'with-client' && b.clientId);
  const deliveredData = deliveredBottles.map(b => ({
    'Bottle ID': b.id,
    'Client Name': b.clientName || '',
    'Client Phone': b.clientPhone || '',
    'Delivery Count': b.deliveryCount || 0,
    'Pallet ID': b.palletId || 'None',
    'Last Updated': new Date(b.lastUpdated).toLocaleString(),
    'Created': new Date(b.created).toLocaleString()
  }));

  const refilledBottles = bottles.filter(b => b.refillCount > 0);
  const refilledData = refilledBottles.map(b => ({
    'Bottle ID': b.id,
    'Status': b.status,
    'Refill Count': b.refillCount || 0,
    'Delivery Count': b.deliveryCount || 0,
    'Pallet ID': b.palletId || 'None',
    'Last Updated': new Date(b.lastUpdated).toLocaleString()
  }));

  const deletedData = deletedRecords.map(r => ({
    'Type': r.type,
    'ID': r.id,
    'Deleted At': new Date(r.deletedAt).toLocaleString(),
    'Details': r.type === 'bottle' ? `Status: ${r.data.status}, Deliveries: ${r.data.deliveryCount || 0}` : `Bottles: ${r.data.bottleIds?.length || 0}`
  }));

  const clientsData = clients.map(c => ({
    'Client ID': c.id,
    'Name': c.name,
    'Phone': c.phone,
    'Address': c.address || '',
    'Active Bottles': c.bottleCount || 0,
    'Created': new Date(c.created).toLocaleString()
  }));

  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  const newBottles = bottles.filter(b => new Date(b.created) > thirtyDaysAgo);
  const newBottlesData = newBottles.map(b => ({
    'Bottle ID': b.id,
    'Status': b.status,
    'Created': new Date(b.created).toLocaleString(),
    'Delivery Count': b.deliveryCount || 0,
    'Refill Count': b.refillCount || 0,
    'Pallet ID': b.palletId || 'None'
  }));

  const wb = XLSX.utils.book_new();
  
  const ws1 = XLSX.utils.json_to_sheet(deliveredData.length ? deliveredData : [{'Info': 'No delivered bottles'}]);
  XLSX.utils.book_append_sheet(wb, ws1, "Delivered Bottles");
  
  const ws2 = XLSX.utils.json_to_sheet(refilledData.length ? refilledData : [{'Info': 'No refilled bottles'}]);
  XLSX.utils.book_append_sheet(wb, ws2, "Refilled Bottles");
  
  const ws3 = XLSX.utils.json_to_sheet(deletedData.length ? deletedData : [{'Info': 'No deleted records'}]);
  XLSX.utils.book_append_sheet(wb, ws3, "Deleted Records");
  
  const ws4 = XLSX.utils.json_to_sheet(clientsData.length ? clientsData : [{'Info': 'No clients'}]);
  XLSX.utils.book_append_sheet(wb, ws4, "Clients");
  
  const ws5 = XLSX.utils.json_to_sheet(newBottlesData.length ? newBottlesData : [{'Info': 'No new bottles'}]);
  XLSX.utils.book_append_sheet(wb, ws5, "New Bottles (30d)");

  const timestamp = new Date().toISOString().split('T')[0];
  const filename = `Bottle_Report_${timestamp}.xlsx`;
  
  XLSX.writeFile(wb, filename);
  
  showNotification(`✅ Downloaded: ${filename}`, 'success', 4000);
  addActivity(`📊 Excel report generated: ${filename}`);
}

function renderPallets(items=pallets) {
  const host = document.getElementById('pallet-grid');
  document.getElementById('pallet-count').textContent = String(pallets.length);
  if (!items.length) { 
    host.innerHTML = '<div class="empty-state"><div class="icon">📦</div><div class="message">No pallets yet</div></div>'; 
    return; 
  }
  host.innerHTML = items.map(p => `
    <div class="pallet-card" onclick="openPalletDetails('${p.id}')" style="cursor:pointer;">
      <div class="pallet-id">📦 ${p.name}</div>
      <div class="status ${p.status}">${p.status.toUpperCase()}</div>
      <div class="stats-mini">
        <div class="stat-badge">🧴 ${p.bottleIds.length}/${p.capacity}</div>
        <div class="stat-badge">📅 ${new Date(p.created).toLocaleDateString()}</div>
      </div>
      <div class="progress-bar" style="margin:10px 0;">
        <div class="progress-fill" style="width:${(p.bottleIds.length/p.capacity*100).toFixed(0)}%;">${p.bottleIds.length} / ${p.capacity}</div>
      </div>
      <button class="btn btn-sm btn-danger badge-danger" onclick="event.stopPropagation(); deletePallet('${p.id}')">🗑️</button>
    </div>
  `).join('');
}

function openPalletDetails(palletId) {
  const pallet = findPalletById(palletId);
  if (!pallet) return;
  currentPalletId = pallet.id;
  document.getElementById('pallet-detail-title').textContent = `📦 ${pallet.name}`;
  document.getElementById('pallet-detail-info').innerHTML = `
    <div class="status ${pallet.status}">${pallet.status.toUpperCase()}</div>
    <div class="stats-mini">
      <div class="stat-badge">🧴 ${pallet.bottleIds.length}/${pallet.capacity}</div>
      <div class="stat-badge">📅 ${new Date(pallet.created).toLocaleString()}</div>
    </div>
  `;
  const bottleList = document.getElementById('pallet-detail-bottles');
  if (!pallet.bottleIds.length) {
    bottleList.innerHTML = '<div class="empty-state" style="padding:20px;"><div class="message">No bottles</div></div>';
  } else {
    bottleList.innerHTML = '<div style="font-weight:700; margin-bottom:8px; color:#1565c0;">Bottle IDs:</div>' +
      pallet.bottleIds.map((id, idx) => {
        const b = bottles.find(x => x.id === id);
        return `<div><strong>${idx+1}.</strong> ${id} ${b ? `<span class="status ${b.status}" style="padding:3px 8px; font-size:0.7rem; margin-left:8px;">${b.status}</span>` : ''}</div>`;
      }).join('');
  }
  document.getElementById('pallet-details-modal').style.display = 'flex';
}

function closePalletDetails() { document.getElementById('pallet-details-modal').style.display = 'none'; }

function searchPallets() {
  const q = document.getElementById('search-pallets').value.trim().toLowerCase();
  const items = pallets.filter(p => p.id.toLowerCase().includes(q) || p.name.toLowerCase().includes(q));
  renderPallets(items);
}

function filterPallets() {
  const s = document.getElementById('filter-pallet-status').value;
  const items = s ? pallets.filter(p => p.status === s) : pallets;
  renderPallets(items);
}

function renderInventory(items=bottles) {
  const host = document.getElementById('bottle-inventory');
  document.getElementById('bottle-count').textContent = String(bottles.length);
  if (!items.length) { 
    host.innerHTML = '<div class="empty-state"><div class="icon">🧴</div><div class="message">No bottles</div></div>'; 
    return; 
  }
  host.innerHTML = items.map(b => `
    <div class="bottle-card">
      <div class="bottle-id">🧴 ${b.id}</div>
      <div class="status ${b.status}">${b.status}</div>
      <div class="stats-mini">
        <div class="stat-badge">📦 ${b.palletId || 'None'}</div>
        <div class="stat-badge">👤 ${b.clientName || 'No client'}</div>
      </div>
      <div class="small">🚚 ${b.deliveryCount||0} • 🔄 ${b.refillCount||0}</div>
      <div class="right" style="margin-top:12px;">
        <button class="btn btn-sm" onclick="setBottleStatus('${b.id}','available')">✅ Available</button>
        <button class="btn btn-sm btn-secondary" onclick="setBottleStatus('${b.id}','needs-refill')">⚠️ Refill</button>
        <button class="btn btn-sm btn-warning" onclick="quickReturn('${b.id}')">↩️ Return</button>
        <button class="btn btn-sm btn-danger" onclick="deleteBottle('${b.id}')">🗑️</button>
      </div>
    </div>
  `).join('');
}

function setBottleStatus(id, status) {
  let b = bottles.find(x => x.id === id);
  if (!b) b = createNewBottleRecord(id, status);
  b.status = status;
  if (status !== 'with-client') { b.clientId=''; b.clientName=''; b.clientPhone=''; }
  b.lastUpdated = new Date().toISOString();
  b.history.push({ action: `Status -> ${status}`, timestamp: new Date().toISOString() });
  saveData();
  updateAllDisplays();
  showNotification(`Bottle ${id} set to ${status}`, 'success');
}

function quickReturn(id) {
  let b = bottles.find(x => x.id === id) || createNewBottleRecord(id, 'needs-refill');
  b.status = 'needs-refill';
  b.clientId=''; b.clientName=''; b.clientPhone='';
  b.lastUpdated = new Date().toISOString();
  b.history.push({ action: 'Quick returned', timestamp: new Date().toISOString() });
  saveData();
  updateAllDisplays();
  showNotification(`Bottle ${id} returned`, 'success');
}

function addBottlePrompt() {
  const id = prompt('Enter bottle ID (5+ chars):');
  if (!id) return;
  if (id.length < 5) return alert('ID must be 5+ characters');
  if (bottles.some(x => x.id === id)) return alert('ID already exists');
  createNewBottleRecord(id, 'available');
  saveData();
  updateAllDisplays();
  showNotification(`Bottle ${id} added`, 'success');
}

function searchBottles() {
  const q = document.getElementById('search-bottles').value.trim().toLowerCase();
  const items = bottles.filter(b => b.id.toLowerCase().includes(q));
  renderInventory(items);
}

function filterBottles() {
  const s = document.getElementById('filter-status').value;
  const items = s ? bottles.filter(b => b.status === s) : bottles;
  renderInventory(items);
}

function renderClients(items=clients) {
  const host = document.getElementById('client-list');
  document.getElementById('client-count').textContent = String(clients.length);
  if (!items.length) { 
    host.innerHTML = '<div class="empty-state"><div class="icon">👥</div><div class="message">No clients</div></div>'; 
    return; 
  }
  host.innerHTML = items.map(c => `
    <div class="bottle-card">
      <div class="bottle-id">👤 ${c.name}</div>
      <div class="stats-mini">
        <div class="stat-badge">📞 ${c.phone}</div>
        <div class="stat-badge">🧴 ${c.bottleCount||0}</div>
      </div>
      ${c.address ? `<div class="small">📍 ${c.address}</div>` : ''}
    </div>
  `).join('');
}

function searchClients() {
  const q = document.getElementById('search-clients').value.trim().toLowerCase();
  const items = clients.filter(c => c.name.toLowerCase().includes(q) || c.phone.toLowerCase().includes(q));
  renderClients(items);
}

function openAddClient() { document.getElementById('add-client-modal').style.display = 'flex'; }
function closeAddClient() { document.getElementById('add-client-modal').style.display = 'none'; }
function createNewClient() {
  const name = document.getElementById('new-client-name').value.trim();
  const phone = document.getElementById('new-client-phone').value.trim();
  const address = document.getElementById('new-client-address').value.trim();
  if (!name || !phone) return alert('Enter name and phone');
  createNewClientRecord({ name, phone, address });
  closeAddClient();
  renderClients();
  populateClientDropdowns();
  showNotification(`Client ${name} created`, 'success');
}

function updateActivity() {
  const host = document.getElementById('activity-list');
  if (!activityLog.length) { 
    host.innerHTML = '<div class="empty-state"><div class="icon">📋</div><div class="message">No activity</div></div>'; 
    return; 
  }
  host.innerHTML = activityLog.slice(0,100).map(a => `
    <div class="scanned-item">
      <div>
        <div style="font-weight:600; color:#1565c0;">${a.message}</div>
        <div class="small">📅 ${new Date(a.timestamp).toLocaleString()}</div>
      </div>
    </div>
  `).join('');
}

function openDeliveryModal() {
  populateClientDropdowns();
  toggleClientMode('existing');
  document.getElementById('delivery-date').valueAsDate = new Date();
  const t = new Date(); 
  document.getElementById('delivery-time').value = `${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;
  document.getElementById('delivery-modal').style.display = 'flex';
}

function closeDeliveryModal() { document.getElementById('delivery-modal').style.display = 'none'; }

function toggleClientMode(mode) {
  deliveryClientMode = mode;
  document.getElementById('existing-client-section').style.display = mode==='existing' ? 'block' : 'none';
  document.getElementById('new-client-section').style.display = mode==='new' ? 'block' : 'none';
  document.getElementById('existing-client-btn').className = mode==='existing' ? 'btn btn-sm' : 'btn btn-sm btn-secondary';
  document.getElementById('new-client-btn').className = mode==='new' ? 'btn btn-sm' : 'btn btn-sm btn-secondary';
}

function populateClientDropdowns() {
  const sel = document.getElementById('delivery-client-select');
  sel.innerHTML = clients.map(c => `<option value="${c.id}">${c.name} — ${c.phone}</option>`).join('');
}

function filterDeliveryClients() {
  const q = document.getElementById('delivery-client-search').value.trim().toLowerCase();
  const sel = document.getElementById('delivery-client-select');
  const items = clients.filter(c => c.name.toLowerCase().includes(q) || c.phone.toLowerCase().includes(q));
  sel.innerHTML = items.map(c => `<option value="${c.id}">${c.name} — ${c.phone}</option>`).join('');
}

function updateScannedList() {
  const host = document.getElementById('scanned-items-container');
  const count = scannedBarcodes.length;
  document.getElementById('scanned-count').textContent = String(count);
  document.getElementById('btn-batch-refill').textContent = `🔄 Refill (${count})`;
  document.getElementById('btn-batch-deliver').textContent = `🚚 Deliver (${count})`;
  document.getElementById('btn-batch-return').textContent = `↩️ Return (${count})`;

  const pct = Math.min((count / PALLET_CAPACITY * 100), 100).toFixed(0);
  const fill = document.getElementById('progress-fill');
  fill.style.width = pct + '%';
  fill.textContent = `${count} / ${PALLET_CAPACITY}`;

  if (!count) {
    host.innerHTML = '<div class="empty-state"><div class="icon">📋</div><div class="message">No bottles scanned</div></div>';
    return;
  }
  host.innerHTML = scannedBarcodes.map(code => `
    <div class="scanned-item">
      <div class="scanned-item-code">🧴 ${code}</div>
      <button class="remove-btn" onclick="removeFromQueue('${code}')" title="Remove">×</button>
    </div>
  `).join('');
}

function removeFromQueue(code) {
  scannedBarcodes = scannedBarcodes.filter(x => x !== code);
  updateScannedList();
}

function openTab(id, btn) {
  document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.getElementById('barcode-input').focus();
}

function updateAllDisplays() {
  renderInventory();
  renderClients();
  renderPallets();
  updateActivity();
}

document.addEventListener('DOMContentLoaded', () => {
  loadData();
  updateAllDisplays();

  const inp = document.getElementById('barcode-input');

  inp.addEventListener('input', () => {
    const code = inp.value.trim();
    if (code.length >= 5) {
      addScannedBarcode(code);
      inp.value = '';
    }
  });

  inp.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const code = inp.value.trim();
      if (code.length >= 5) {
        addScannedBarcode(code);
        inp.value = '';
      } else if (code.length > 0) {
        showNotification('Barcode must be 5+ characters', 'warning');
      }
    }
  });

  setInterval(() => { 
    if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'SELECT' && document.activeElement.tagName !== 'TEXTAREA') {
      inp.focus(); 
    }
  }, 2000);
});
</script>
</body>
</html>
