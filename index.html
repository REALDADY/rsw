<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5-Gallon Bottle Tracking System</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .store-switcher {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        .excel-badge {
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            font-weight: 600;
            font-size: 0.9rem;
            transition: background 0.3s;
        }
        
        .excel-badge:hover {
            background: #059669;
        }
        
        .tabs {
            display: flex;
            background: #f3f4f6;
            border-bottom: 2px solid #e5e7eb;
            overflow-x: auto;
        }
        
        .tab-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.3s;
            white-space: nowrap;
            min-width: 100px;
        }
        
        .tab-btn.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .tab-btn:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .scanner-panel {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .scanner-panel h2 {
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .status-chip {
            display: inline-block;
            padding: 6px 12px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }
        
        .scanner-input {
            width: 100%;
            max-width: 500px;
            padding: 15px 20px;
            font-size: 1.2rem;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            text-align: center;
            margin: 0 auto;
            display: block;
        }
        
        .mode-toggle {
            margin: 20px 0;
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .mode-toggle label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .mode-toggle input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .queue-panel {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .queue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .queue-header h3 {
            font-size: 1.2rem;
            color: #1f2937;
        }
        
        .progress-bar {
            width: 100%;
            height: 24px;
            background: #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .scanned-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .scanned-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .scanned-item-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .remove-btn:hover {
            background: #dc2626;
        }
        
        .action-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn-warning:hover {
            background: #d97706;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-info {
            background: #3b82f6;
            color: white;
        }
        
        .btn-info:hover {
            background: #2563eb;
        }
        
        .pallet-quick-actions {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .pallet-summary-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .card:hover {
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .chip {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .chip-available {
            background: #d1fae5;
            color: #065f46;
        }
        
        .chip-needs-refill {
            background: #fed7aa;
            color: #9a3412;
        }
        
        .chip-with-client {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .chip-empty {
            background: #f3f4f6;
            color: #4b5563;
        }
        
        .chip-partial {
            background: #fef3c7;
            color: #92400e;
        }
        
        .chip-full {
            background: #d1fae5;
            color: #065f46;
        }
        
        .chip-main {
            background: #e0e7ff;
            color: #3730a3;
        }
        
        .chip-driver {
            background: #fce7f3;
            color: #831843;
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            background: #f3f4f6;
            border-radius: 8px;
            font-size: 0.8rem;
            color: #4b5563;
        }
        
        .card-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-bar input,
        .filter-bar select {
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9rem;
            flex: 1;
            min-width: 200px;
        }
        
        .kpi-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .kpi-card {
            flex: 1;
            min-width: 150px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }
        
        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .kpi-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        .activity-feed {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .activity-item {
            padding: 15px;
            background: #f9fafb;
            border-left: 4px solid #667eea;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .activity-time {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 5px;
        }
        
        .activity-message {
            color: #1f2937;
            font-size: 0.95rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        
        .close-btn:hover {
            color: #1f2937;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95rem;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border-left: 4px solid;
            animation: slideIn 0.3s;
            min-width: 300px;
        }
        
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast-success {
            border-color: #10b981;
        }
        
        .toast-warning {
            border-color: #f59e0b;
        }
        
        .toast-error {
            border-color: #ef4444;
        }
        
        .print-area {
            display: none;
        }
        
        .transfer-item {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .checkbox-label:hover {
            background: #f3f4f6;
        }
        
        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .print-area,
            .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                display: block !important;
            }
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.2rem;
            }
            
            .tab-btn {
                font-size: 0.85rem;
                padding: 12px 10px;
            }
            
            .card-grid {
                grid-template-columns: 1fr;
            }
            
            .scanner-input {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>5-Gallon Bottle Tracking System</h1>
            <div class="header-actions">
                <select id="storeSwitcher" class="store-switcher" onchange="switchStore()">
                    <!-- Populated dynamically -->
                </select>
                <button class="excel-badge" onclick="generateExcelReport()">üìä Export Excel</button>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('scanner', this)">Scanner</button>
            <button class="tab-btn" onclick="openTab('pallets', this)">Pallets</button>
            <button class="tab-btn" onclick="openTab('inventory', this)">Inventory</button>
            <button class="tab-btn" onclick="openTab('clients', this)">Clients</button>
            <button class="tab-btn" onclick="openTab('activity', this)">Activity</button>
        </div>
        
        <!-- Scanner Tab -->
        <div id="scanner" class="tab-content active">
            <div class="scanner-panel">
                <h2>üîç Barcode Scanner Active</h2>
                <div class="status-chip">üü¢ Ready to Scan</div>
                
                <div class="mode-toggle">
                    <label>
                        <input type="radio" name="scanMode" value="bottle" checked onchange="setScannerMode('bottle')">
                        Bottle Mode
                    </label>
                    <label>
                        <input type="radio" name="scanMode" value="pallet" onchange="setScannerMode('pallet')">
                        Pallet Mode
                    </label>
                </div>
                
                <input 
                    type="text" 
                    id="scannerInput" 
                    class="scanner-input" 
                    placeholder="Auto-submit on 6+ digits - Keep scanning..."
                    autocomplete="off"
                >
            </div>
            
            <div id="palletQuickActions" class="pallet-quick-actions" style="display: none;">
                <h3 style="margin-bottom: 15px;">Quick Pallet Actions</h3>
                <div id="palletSummaryCard" class="pallet-summary-card"></div>
                <div class="action-row">
                    <button class="btn btn-success" onclick="refillPalletById(window.currentScannedPallet)">Refill Pallet</button>
                    <button class="btn btn-primary" onclick="deliverPalletById(window.currentScannedPallet)">Deliver Pallet</button>
                    <button class="btn btn-warning" onclick="returnPalletById(window.currentScannedPallet)">Return Pallet</button>
                </div>
            </div>
            
            <div class="queue-panel">
                <div class="queue-header">
                    <h3>Bottle Queue (<span id="queueCount">0</span> / 32)</h3>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%;">0%</div>
                </div>
                <div class="scanned-list" id="scannedList"></div>
                <div class="action-row">
                    <button class="btn btn-primary" onclick="manualGeneratePallet()">Create Pallet from Queue</button>
                    <button class="btn btn-success" onclick="batchRefill()">Refill Queue</button>
                    <button class="btn btn-primary" onclick="batchDeliver()">Deliver Queue</button>
                    <button class="btn btn-warning" onclick="batchReturn()">Return Queue</button>
                    <button class="btn btn-secondary" onclick="clearAllScanned()">Clear</button>
                </div>
            </div>
        </div>
        
        <!-- Pallets Tab -->
        <div id="pallets" class="tab-content">
            <div class="filter-bar">
                <input type="text" id="palletSearch" placeholder="Search by ID or name..." oninput="renderPallets()">
                <select id="palletStatusFilter" onchange="renderPallets()">
                    <option value="">All Statuses</option>
                    <option value="empty">Empty</option>
                    <option value="partial">Partial</option>
                    <option value="full">Full</option>
                    <option value="with-client">With Client</option>
                    <option value="needs-refill">Needs Refill</option>
                </select>
                <button class="btn btn-info" onclick="openBulkTransferPallets()">üîÑ Transfer Pallets</button>
            </div>
            
            <div class="kpi-row" id="palletKPIs"></div>
            
            <div class="card-grid" id="palletGrid"></div>
        </div>
        
        <!-- Inventory Tab -->
        <div id="inventory" class="tab-content">
            <div class="filter-bar">
                <input type="text" id="inventorySearch" placeholder="Search by ID..." oninput="renderInventory()">
                <select id="inventoryStatusFilter" onchange="renderInventory()">
                    <option value="">All Statuses</option>
                    <option value="available">Available</option>
                    <option value="needs-refill">Needs Refill</option>
                    <option value="with-client">With Client</option>
                </select>
                <button class="btn btn-primary" onclick="openAddBottle()">+ Add Bottle</button>
                <button class="btn btn-info" onclick="openBulkTransferBottles()">üîÑ Transfer Bottles</button>
            </div>
            
            <div class="kpi-row" id="inventoryKPIs"></div>
            
            <div class="card-grid" id="inventoryGrid"></div>
        </div>
        
        <!-- Clients Tab -->
        <div id="clients" class="tab-content">
            <div class="filter-bar">
                <input type="text" id="clientSearch" placeholder="Search by name or phone..." oninput="renderClients()">
                <button class="btn btn-primary" onclick="openAddClient()">+ Add Client</button>
            </div>
            
            <div class="card-grid" id="clientGrid"></div>
        </div>
        
        <!-- Activity Tab -->
        <div id="activity" class="tab-content">
            <div style="margin-bottom: 20px;">
                <button class="btn btn-success" onclick="generateExcelReport()">üìä Export Excel Report</button>
            </div>
            <div class="activity-feed" id="activityFeed"></div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="palletDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Pallet Details</h3>
                <button class="close-btn" onclick="closePalletDetails()">√ó</button>
            </div>
            <div id="palletDetailsContent"></div>
        </div>
    </div>
    
    <div id="addClientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Client</h3>
                <button class="close-btn" onclick="closeAddClient()">√ó</button>
            </div>
            <form onsubmit="createNewClient(event)">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" id="clientName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone *</label>
                    <input type="tel" id="clientPhone" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Address</label>
                    <input type="text" id="clientAddress" class="form-input">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Create Client</button>
            </form>
        </div>
    </div>
    
    <div id="deliverModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Deliver Bottles</h3>
                <button class="close-btn" onclick="closeDeliverModal()">√ó</button>
            </div>
            <div class="form-group">
                <label class="form-label">Search Client</label>
                <input type="text" id="clientSearchInput" class="form-input" placeholder="Search by name or phone..." oninput="filterDeliveryClients()">
            </div>
            <div class="form-group">
                <label class="form-label">Select Client *</label>
                <select id="deliverClientSelect" class="form-input" required>
                    <option value="">Choose a client...</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Delivery Date/Time</label>
                <input type="datetime-local" id="deliveryDateTime" class="form-input">
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" style="flex: 1;" onclick="confirmBatchDelivery()">Confirm Delivery</button>
                <button class="btn btn-secondary" onclick="openAddClient(); closeDeliverModal();">+ New Client</button>
            </div>
        </div>
    </div>
    
    <div id="transferModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="transferModalTitle">Transfer Inventory</h3>
                <button class="close-btn" onclick="closeTransferModal()">√ó</button>
            </div>
            <div id="transferContent"></div>
        </div>
    </div>
    
    <div id="bulkTransferBottlesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Bulk Transfer Bottles</h3>
                <button class="close-btn" onclick="closeBulkTransferBottles()">√ó</button>
            </div>
            <div id="bulkTransferBottlesContent"></div>
        </div>
    </div>
    
    <div id="bulkTransferPalletsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Bulk Transfer Pallets</h3>
                <button class="close-btn" onclick="closeBulkTransferPallets()">√ó</button>
            </div>
            <div id="bulkTransferPalletsContent"></div>
        </div>
    </div>
    
    <div id="addBottleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Bottle</h3>
                <button class="close-btn" onclick="closeAddBottle()">√ó</button>
            </div>
            <form onsubmit="createManualBottle(event)">
                <div class="form-group">
                    <label class="form-label">Bottle ID (6+ digits)</label>
                    <input type="text" id="manualBottleId" class="form-input" placeholder="Enter bottle ID..." required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Add Bottle</button>
            </form>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Print Area -->
    <div id="printArea" class="print-area">
        <div id="printContent"></div>
    </div>
    
    <!-- Audio Elements -->
    <audio id="successSound" preload="auto">
        <source src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAADhAC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAA4TR0kVhAAAAAAAAAAAAAAAAAAAAAP/7kGQAD/AAAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABExBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/+5BkAA/wAABpAAAACAAADSAAAAEAAAGkAAAAIAAANIAAAARMQU1FMy4xMDBVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV" type="audio/mpeg">
    </audio>
    <audio id="warningSound" preload="auto">
        <source src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAADhAC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAA4TR0kVhAAAAAAAAAAAAAAAAAAAAAP/7kGQAD/AAAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABExBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/+5BkAA/wAABpAAAACAAADSAAAAEAAAGkAAAAIAAANIAAAARMQU1FMy4xMDBVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV" type="audio/mpeg">
    </audio>
    
    <script>
       // Constants
const STORAGE_KEY = 'bottle_app_v5_excel';
const MAX_BARCODES = 500;
const PALLET_CAPACITY = 32;

// Global State
let bottles = [];
let pallets = [];
let clients = [];
let activityLog = [];
let deletedRecords = [];
let stores = [];
let scannedBarcodes = [];
let currentStoreId = null;
let scannerMode = 'bottle';
let debounceTimer = null;

// Audio references
let successSound, warningSound;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    successSound = document.getElementById('successSound');
    warningSound = document.getElementById('warningSound');
    
    loadData();
    initializeStores();
    migrateDataToStores();
    renderStoreSwitcher();
    setupScanner();
    updateAllDisplays();
    
    // Auto-focus scanner
    document.getElementById('scannerInput').focus();
    
    // Restore last active tab
    const lastTab = localStorage.getItem('lastActiveTab') || 'scanner';
    const tabBtn = document.querySelector(`[onclick*="${lastTab}"]`);
    if (tabBtn) {
        openTab(lastTab, tabBtn);
    }
});

// Data Persistence
function saveData() {
    const data = {
        bottles,
        pallets,
        clients,
        activityLog: activityLog.slice(0, 100),
        deletedRecords,
        stores,
        currentStoreId,
        version: 5
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function loadData() {
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const data = JSON.parse(saved);
            bottles = data.bottles || [];
            pallets = data.pallets || [];
            clients = data.clients || [];
            activityLog = data.activityLog || [];
            deletedRecords = data.deletedRecords || [];
            stores = data.stores || [];
            currentStoreId = data.currentStoreId || null;
        }
    } catch (e) {
        console.error('Error loading data:', e);
        showToast('Error loading saved data', 'error');
    }
}

// Store Management
function initializeStores() {
    if (stores.length === 0) {
        const now = new Date().toISOString();
        stores = [
            {
                id: 'store_main',
                name: 'Main Store',
                type: 'main',
                created: now,
                lastUpdated: now
            }
        ];
        
        for (let i = 1; i <= 6; i++) {
            stores.push({
                id: `store_driver${i}`,
                name: `Driver ${i}`,
                type: 'driver',
                created: now,
                lastUpdated: now
            });
        }
        
        currentStoreId = 'store_main';
        saveData();
        addActivity('‚ú® Initialized 7-store system (1 Main + 6 Drivers)');
    }
    
    if (!currentStoreId) {
        currentStoreId = 'store_main';
    }
}

function migrateDataToStores() {
    let migrated = false;
    const mainStore = stores.find(s => s.type === 'main');
    
    bottles.forEach(bottle => {
        if (!bottle.storeId) {
            bottle.storeId = mainStore.id;
            bottle.storeName = mainStore.name;
            migrated = true;
        }
    });
    
    pallets.forEach(pallet => {
        if (!pallet.storeId) {
            pallet.storeId = mainStore.id;
            pallet.storeName = mainStore.name;
            migrated = true;
        }
    });
    
    if (migrated) {
        saveData();
        addActivity('üîÑ Migrated legacy data to Main Store');
    }
}

function renderStoreSwitcher() {
    const switcher = document.getElementById('storeSwitcher');
    switcher.innerHTML = stores.map(store => 
        `<option value="${store.id}" ${store.id === currentStoreId ? 'selected' : ''}>${store.name}</option>`
    ).join('');
}

function switchStore() {
    const switcher = document.getElementById('storeSwitcher');
    currentStoreId = switcher.value;
    const store = stores.find(s => s.id === currentStoreId);
    saveData();
    updateAllDisplays();
    showToast(`üìç Switched to ${store.name}`, 'success');
}

function getCurrentStore() {
    return stores.find(s => s.id === currentStoreId);
}

// Transfer Functions
function openTransferBottle(bottleId) {
    const bottle = bottles.find(b => b.id === bottleId);
    if (!bottle) return;
    
    const otherStores = stores.filter(s => s.id !== bottle.storeId);
    
    const content = `
        <div class="form-group">
            <p><strong>Bottle:</strong> ${bottle.id}</p>
            <p><strong>Current Store:</strong> ${bottle.storeName}</p>
        </div>
        <div class="form-group">
            <label class="form-label">Transfer to Store *</label>
            <select id="transferTargetStore" class="form-input">
                ${otherStores.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
            </select>
        </div>

        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn btn-primary" style="flex:1;" onclick="confirmTransfer('bottle', '${bottleId}')">Confirm Transfer to Store</button>
            <button class="btn btn-info" style="flex:1;" onclick="openSelectPalletForBottle('${bottleId}')">Transfer to Pallet</button>
        </div>
    `;
    
    document.getElementById('transferModalTitle').textContent = 'Transfer Bottle';
    document.getElementById('transferContent').innerHTML = content;
    document.getElementById('transferModal').classList.add('active');
}

function openTransferPallet(palletId) {
    const pallet = findPalletById(palletId);
    if (!pallet) return;
    
    const otherStores = stores.filter(s => s.id !== pallet.storeId);
    
    const content = `
        <div class="form-group">
            <p><strong>Pallet:</strong> ${pallet.name || pallet.id}</p>
            <p><strong>Current Store:</strong> ${pallet.storeName}</p>
            <p><strong>Bottles:</strong> ${pallet.bottleIds.length}</p>
        </div>
        <div class="form-group">
            <label class="form-label">Transfer to Store *</label>
            <select id="transferTargetStore" class="form-input">
                ${otherStores.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
            </select>
        </div>
        <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 15px;">
            Note: All bottles in this pallet will also be transferred to the target store.
        </p>
        <button class="btn btn-primary" style="width: 100%;" onclick="confirmTransfer('pallet', '${palletId}')">Confirm Transfer</button>
    `;
    
    document.getElementById('transferModalTitle').textContent = 'Transfer Pallet';
    document.getElementById('transferContent').innerHTML = content;
    document.getElementById('transferModal').classList.add('active');
}

function closeTransferModal() {
    document.getElementById('transferModal').classList.remove('active');
}

function confirmTransfer(type, id) {
    const targetStoreId = document.getElementById('transferTargetStore').value;
    const targetStore = stores.find(s => s.id === targetStoreId);
    
    if (!targetStore) return;
    
    if (type === 'bottle') {
        const bottle = bottles.find(b => b.id === id);
        if (!bottle) return;
        
        const fromStore = bottle.storeName;
        bottle.storeId = targetStore.id;
        bottle.storeName = targetStore.name;
        bottle.lastUpdated = new Date().toISOString();
        bottle.history.push({
            action: 'transferred',
            from: fromStore,
            to: targetStore.name,
            timestamp: new Date().toISOString()
        });
        
        addActivity(`üîÑ Transferred bottle ${id} from ${fromStore} to ${targetStore.name}`);
        showToast(`‚úÖ Bottle transferred to ${targetStore.name}`, 'success');
    } else if (type === 'pallet') {
        const pallet = findPalletById(id);
        if (!pallet) return;
        
        const fromStore = pallet.storeName;
        pallet.storeId = targetStore.id;
        pallet.storeName = targetStore.name;
        pallet.lastUpdated = new Date().toISOString();
        pallet.history.push({
            action: 'transferred',
            from: fromStore,
            to: targetStore.name,
            timestamp: new Date().toISOString()
        });
        
        // Transfer all bottles in the pallet
        pallet.bottleIds.forEach(bottleId => {
            const bottle = bottles.find(b => b.id === bottleId);
            if (bottle) {
                bottle.storeId = targetStore.id;
                bottle.storeName = targetStore.name;
                bottle.lastUpdated = new Date().toISOString();
                bottle.history.push({
                    action: 'transferred_with_pallet',
                    from: fromStore,
                    to: targetStore.name,
                    timestamp: new Date().toISOString()
                });
            }
        });
        
        addActivity(`üîÑ Transferred pallet ${pallet.name || pallet.id} with ${pallet.bottleIds.length} bottles from ${fromStore} to ${targetStore.name}`);
        showToast(`‚úÖ Pallet and ${pallet.bottleIds.length} bottles transferred to ${targetStore.name}`, 'success');
    }
    
    saveData();
    updateAllDisplays();
    closeTransferModal();
}

// Bulk Transfer Functions
function openBulkTransferBottles() {
    const storeBottles = bottles.filter(b => b.storeId === currentStoreId);
    const otherStores = stores.filter(s => s.id !== currentStoreId);
    
    if (storeBottles.length === 0) {
        showToast('‚ö†Ô∏è No bottles in current store', 'warning');
        return;
    }
    
    const content = `
        <div class="form-group">
            <p><strong>Current Store:</strong> ${getCurrentStore().name}</p>
            <p><strong>Available Bottles:</strong> ${storeBottles.length}</p>
        </div>
        
        <div class="form-group">
            <label class="form-label">Select Bottles to Transfer</label>
            <div class="checkbox-group" id="bulkBottleCheckboxes">
                ${storeBottles.map(b => `
                    <label class="checkbox-label">
                        <input type="checkbox" value="${b.id}" class="bulk-bottle-checkbox">
                        <span><strong>${b.id}</strong> - ${b.status} ${b.palletId ? `(${b.palletId})` : ''}</span>
                    </label>
                `).join('')}
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Transfer to Store *</label>
            <select id="bulkTransferTargetStore" class="form-input">
                ${otherStores.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
            </select>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" style="flex: 1;" onclick="selectAllBottles(true)">Select All</button>
            <button class="btn btn-secondary" style="flex: 1;" onclick="selectAllBottles(false)">Deselect All</button>
        </div>
        
        <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="confirmBulkTransferBottles()">Transfer Selected Bottles</button>
    `;
    
    document.getElementById('bulkTransferBottlesContent').innerHTML = content;
    document.getElementById('bulkTransferBottlesModal').classList.add('active');
}

function closeBulkTransferBottles() {
    document.getElementById('bulkTransferBottlesModal').classList.remove('active');
}

function selectAllBottles(select) {
    document.querySelectorAll('.bulk-bottle-checkbox').forEach(cb => {
        cb.checked = select;
    });
}

function confirmBulkTransferBottles() {
    const selectedBottleIds = Array.from(document.querySelectorAll('.bulk-bottle-checkbox:checked')).map(cb => cb.value);
    
    if (selectedBottleIds.length === 0) {
        showToast('‚ö†Ô∏è Please select at least one bottle', 'warning');
        return;
    }
    
    const targetStoreId = document.getElementById('bulkTransferTargetStore').value;
    const targetStore = stores.find(s => s.id === targetStoreId);
    const fromStore = getCurrentStore();
    
    selectedBottleIds.forEach(bottleId => {
        const bottle = bottles.find(b => b.id === bottleId);
        if (bottle) {
            // Remove from pallet if in different store
            if (bottle.palletId) {
                const pallet = findPalletById(bottle.palletId);
                if (pallet && pallet.storeId !== targetStoreId) {
                    removeBottleFromPallet(bottleId, bottle.palletId);
                }
            }
            
            bottle.storeId = targetStore.id;
            bottle.storeName = targetStore.name;
            bottle.lastUpdated = new Date().toISOString();
            bottle.history.push({
                action: 'bulk_transferred',
                from: fromStore.name,
                to: targetStore.name,
                timestamp: new Date().toISOString()
            });
        }
    });
    
    addActivity(`üîÑ Bulk transferred ${selectedBottleIds.length} bottles from ${fromStore.name} to ${targetStore.name}`);
    saveData();
    updateAllDisplays();
    closeBulkTransferBottles();
    showToast(`‚úÖ Transferred ${selectedBottleIds.length} bottles to ${targetStore.name}`, 'success');
}

function openBulkTransferPallets() {
    const storePallets = pallets.filter(p => p.storeId === currentStoreId);
    const otherStores = stores.filter(s => s.id !== currentStoreId);
    
    if (storePallets.length === 0) {
        showToast('‚ö†Ô∏è No pallets in current store', 'warning');
        return;
    }
    
    const content = `
        <div class="form-group">
            <p><strong>Current Store:</strong> ${getCurrentStore().name}</p>
            <p><strong>Available Pallets:</strong> ${storePallets.length}</p>
        </div>
        
        <div class="form-group">
            <label class="form-label">Select Pallets to Transfer</label>
            <div class="checkbox-group" id="bulkPalletCheckboxes">
                ${storePallets.map(p => `
                    <label class="checkbox-label">
                        <input type="checkbox" value="${p.id}" class="bulk-pallet-checkbox">
                        <span><strong>${p.name || p.id}</strong> - ${p.status} (${p.bottleIds.length} bottles)</span>
                    </label>
                `).join('')}
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Transfer to Store *</label>
            <select id="bulkTransferTargetStorePallet" class="form-input">
                ${otherStores.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
            </select>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" style="flex: 1;" onclick="selectAllPallets(true)">Select All</button>
            <button class="btn btn-secondary" style="flex: 1;" onclick="selectAllPallets(false)">Deselect All</button>
        </div>
        
        <p style="color: #6b7280; font-size: 0.9rem; margin: 15px 0;">
            Note: All bottles in selected pallets will also be transferred.
        </p>
        
        <button class="btn btn-primary" style="width: 100%;" onclick="confirmBulkTransferPallets()">Transfer Selected Pallets</button>
    `;
    
    document.getElementById('bulkTransferPalletsContent').innerHTML = content;
    document.getElementById('bulkTransferPalletsModal').classList.add('active');
}

function closeBulkTransferPallets() {
    document.getElementById('bulkTransferPalletsModal').classList.remove('active');
}

function selectAllPallets(select) {
    document.querySelectorAll('.bulk-pallet-checkbox').forEach(cb => {
        cb.checked = select;
    });
}

function confirmBulkTransferPallets() {
    const selectedPalletIds = Array.from(document.querySelectorAll('.bulk-pallet-checkbox:checked')).map(cb => cb.value);
    
    if (selectedPalletIds.length === 0) {
        showToast('‚ö†Ô∏è Please select at least one pallet', 'warning');
        return;
    }
    
    const targetStoreId = document.getElementById('bulkTransferTargetStorePallet').value;
    const targetStore = stores.find(s => s.id === targetStoreId);
    const fromStore = getCurrentStore();
    
    let totalBottles = 0;
    
    selectedPalletIds.forEach(palletId => {
        const pallet = findPalletById(palletId);
        if (pallet) {
            pallet.storeId = targetStore.id;
            pallet.storeName = targetStore.name;
            pallet.lastUpdated = new Date().toISOString();
            pallet.history.push({
                action: 'bulk_transferred',
                from: fromStore.name,
                to: targetStore.name,
                timestamp: new Date().toISOString()
            });
            
            // Transfer all bottles
            pallet.bottleIds.forEach(bottleId => {
                const bottle = bottles.find(b => b.id === bottleId);
                if (bottle) {
                    bottle.storeId = targetStore.id;
                    bottle.storeName = targetStore.name;
                    bottle.lastUpdated = new Date().toISOString();
                    bottle.history.push({
                        action: 'bulk_transferred_with_pallet',
                        from: fromStore.name,
                        to: targetStore.name,
                        timestamp: new Date().toISOString()
                    });
                    totalBottles++;
                }
            });
        }
    });
    
    addActivity(`üîÑ Bulk transferred ${selectedPalletIds.length} pallets with ${totalBottles} bottles from ${fromStore.name} to ${targetStore.name}`);
    saveData();
    updateAllDisplays();
    closeBulkTransferPallets();
    showToast(`‚úÖ Transferred ${selectedPalletIds.length} pallets and ${totalBottles} bottles to ${targetStore.name}`, 'success');
}

// Tab Navigation
function openTab(tabId, btn) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active from all buttons
    document.querySelectorAll('.tab-btn').forEach(button => {
        button.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabId).classList.add('active');
    btn.classList.add('active');
    
    // Auto-focus scanner when switching to Scanner tab
    if (tabId === 'scanner') {
        setTimeout(() => {
            document.getElementById('scannerInput').focus();
        }, 100);
    }
    
    // Save last active tab
    localStorage.setItem('lastActiveTab', tabId);
}

// Scanner Setup
function setupScanner() {
    const input = document.getElementById('scannerInput');
    
    // Auto-submit on 6+ digits with debounce
    input.addEventListener('input', function(e) {
        clearTimeout(debounceTimer);
        
        // Strip non-digits and keep letters (allow PAL-)
        let value = e.target.value.replace(/[^\w\-]/g, '');
        e.target.value = value;
        
        // If contains letters (PAL) allow immediate submit; else require 6+ chars
        const isPotentialPallet = /^PAL[-_]?/i.test(value);
        if (isPotentialPallet || value.length >= 6) {
            debounceTimer = setTimeout(() => {
                handleScannerSubmit(value);
            }, 120);
        }
    });
    
    // Enter key fallback
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            clearTimeout(debounceTimer);
            const value = e.target.value.replace(/[^\w\-]/g, '');
            if (value.length >= 1) {
                handleScannerSubmit(value);
            } else {
                showToast('‚ö†Ô∏è Please enter a valid code', 'warning');
                warningSound.play();
            }
        }
    });
}

function handleScannerSubmit(barcode) {
    const input = document.getElementById('scannerInput');
    if (!barcode) {
        input.value = '';
        input.focus();
        return;
    }
    
    const code = barcode.trim();
    // If it's a pallet id (PAL or PAL-...), load pallet
    if (/^PAL[-_]?/i.test(code) || /^PAL-/i.test(code)) {
        // normalize to PAL-<rest>
        let rest = code.replace(/^PAL[-_]?/i, '').trim();
        const formatted = `PAL-${rest}`;
        handlePalletScan(formatted);
        input.value = '';
        input.focus();
        return;
    }
    
    // If scanner is in pallet mode AND a pallet is currently loaded, add bottle to that pallet
    if (scannerMode === 'pallet' && window.currentScannedPallet) {
        addScannedBottleToCurrentPallet(code);
        input.value = '';
        input.focus();
        return;
    }
    
    // Default behaviour: add to scanned queue
    addScannedBarcode(code);
    input.value = '';
    input.focus();
}

function setScannerMode(mode) {
    scannerMode = mode;
    updatePalletScanUI();
    document.getElementById('scannerInput').focus();
}

function updatePalletScanUI() {
    const quickActions = document.getElementById('palletQuickActions');
    if (scannerMode === 'pallet') {
        quickActions.style.display = 'block';
    } else {
        quickActions.style.display = 'none';
        window.currentScannedPallet = null;
    }
}

function handlePalletScan(palletId) {
    const formattedId = palletId.startsWith('PAL-') ? palletId : `PAL-${palletId}`;
    const pallet = findPalletById(formattedId);
    
    if (!pallet) {
        showToast(`‚ö†Ô∏è Pallet ${formattedId} not found`, 'warning');
        warningSound.play();
        return;
    }
    
    window.currentScannedPallet = formattedId;
    
    const card = document.getElementById('palletSummaryCard');
    card.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <strong style="font-size: 1.1rem;">${pallet.name || pallet.id}</strong>
            <span class="chip ${getStoreChipClass(pallet.storeId)}">${pallet.storeName}</span>
        </div>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <span class="chip chip-${pallet.status}">${pallet.status.replace('-', ' ').toUpperCase()}</span>
            <span class="badge">üì¶ ${pallet.bottleIds.length} / ${pallet.capacity}</span>
        </div>
        <div style="font-size:0.9rem; color:#374151; margin-top:8px;">
            Tip: Now in Pallet mode ‚Äî scan bottle barcodes to add them to this pallet.
        </div>
    `;
    
    successSound.play();
    showToast(`‚úÖ Loaded ${pallet.name || pallet.id} ‚Äî scanning bottles will add them to this pallet`, 'success');
}

// Bottle Queue Management
function addScannedBarcode(barcode) {
    if (scannedBarcodes.length >= MAX_BARCODES) {
        showToast('‚ö†Ô∏è Queue is full (500 max)', 'warning');
        warningSound.play();
        return;
    }
    
    if (scannedBarcodes.includes(barcode)) {
        showToast('‚ö†Ô∏è Bottle already in queue', 'warning');
        warningSound.play();
        return;
    }
    
    scannedBarcodes.push(barcode);
    updateScannedList();
    successSound.play();
    
    // Auto-create pallet at 32 bottles
    if (scannedBarcodes.length === 32) {
        setTimeout(() => {
            autoCreatePallet();
        }, 300);
    }
}

function removeFromQueue(barcode) {
    scannedBarcodes = scannedBarcodes.filter(b => b !== barcode);
    updateScannedList();
}

function updateScannedList() {
    const count = scannedBarcodes.length;
    const percentage = Math.min((count / 32) * 100, 100);
    
    document.getElementById('queueCount').textContent = count;
    const progressFill = document.getElementById('progressFill');
    progressFill.style.width = percentage + '%';
    progressFill.textContent = Math.round(percentage) + '%';
    
    const list = document.getElementById('scannedList');
    list.innerHTML = scannedBarcodes.map((barcode, index) => `
        <div class="scanned-item">
            <div class="scanned-item-info">
                <strong>#${index + 1}</strong>
                <span>${barcode}</span>
            </div>
            <button class="remove-btn" onclick="removeFromQueue('${barcode}')">Remove</button>
        </div>
    `).join('');
}

function clearAllScanned() {
    if (scannedBarcodes.length === 0) return;
    
    if (confirm(`Clear all ${scannedBarcodes.length} bottles from queue?`)) {
        scannedBarcodes = [];
        updateScannedList();
        showToast('üóëÔ∏è Queue cleared', 'success');
    }
}

function autoCreatePallet() {
    if (scannedBarcodes.length !== 32) return;
    
    const store = getCurrentStore();
    const pallet = createNewPalletRecord(store.id, store.name);
    
    // First, ensure all bottles exist and are assigned to the current store
    scannedBarcodes.forEach(bottleId => {
        let bottle = bottles.find(b => b.id === bottleId);
        if (!bottle) {
            bottle = createNewBottleRecord(bottleId, store.id, store.name);
            bottles.push(bottle);
        } else {
            // Update bottle to current store if needed
            bottle.storeId = store.id;
            bottle.storeName = store.name;
        }
    });
    
    // Add pallet to array
    pallets.push(pallet);
    
    // Now add bottles to pallet (they're all in the same store now)
    scannedBarcodes.forEach(bottleId => {
        addBottleToPallet(bottleId, pallet.id);
    });
    
    recalcPalletStatus(pallet.id);
    
    scannedBarcodes = [];
    updateScannedList();
    
    addActivity(`[${store.name}] üéâ Auto-created ${pallet.name || pallet.id} with 32 bottles`);
    saveData();
    updateAllDisplays();
    showToast(`‚úÖ Created ${pallet.name || pallet.id}`, 'success');
    successSound.play();
}

function manualGeneratePallet() {
    if (scannedBarcodes.length === 0) {
        showToast('‚ö†Ô∏è Queue is empty', 'warning');
        return;
    }
    
    const store = getCurrentStore();
    const pallet = createNewPalletRecord(store.id, store.name);
    
    // First, ensure all bottles exist and are assigned to the current store
    scannedBarcodes.forEach(bottleId => {
        let bottle = bottles.find(b => b.id === bottleId);
        if (!bottle) {
            bottle = createNewBottleRecord(bottleId, store.id, store.name);
            bottles.push(bottle);
        } else {
            // Update bottle to current store if needed
            bottle.storeId = store.id;
            bottle.storeName = store.name;
        }
    });
    
    // Add pallet to array
    pallets.push(pallet);
    
    // Now add bottles to pallet (they're all in the same store now)
    scannedBarcodes.forEach(bottleId => {
        addBottleToPallet(bottleId, pallet.id);
    });
    
    recalcPalletStatus(pallet.id);
    
    addActivity(`[${store.name}] üì¶ Created ${pallet.name || pallet.id} with ${scannedBarcodes.length} bottles`);
    
    scannedBarcodes = [];
    updateScannedList();
    saveData();
    updateAllDisplays();
    showToast(`‚úÖ Created ${pallet.name || pallet.id}`, 'success');
}

// Batch Actions
function batchRefill() {
    if (scannedBarcodes.length === 0) {
        showToast('‚ö†Ô∏è Queue is empty', 'warning');
        return;
    }
    
    const store = getCurrentStore();
    let refilled = 0;
    
    scannedBarcodes.forEach(bottleId => {
        let bottle = bottles.find(b => b.id === bottleId);
        if (!bottle) {
            bottle = createNewBottleRecord(bottleId, store.id, store.name);
            bottles.push(bottle);
        }
        
        const oldClientId = bottle.clientId;
        
        bottle.status = 'available';
        bottle.clientId = null;
        bottle.clientName = null;
        bottle.clientPhone = null;
        bottle.refillCount++;
        bottle.lastUpdated = new Date().toISOString();
        bottle.history.push({
            action: 'refilled',
            timestamp: new Date().toISOString()
        });
        
        if (oldClientId) {
            updateClientBottleCounts(oldClientId);
        }
        
        refilled++;
    });
    
    addActivity(`[${store.name}] üîÑ Refilled ${refilled} bottles`);
    scannedBarcodes = [];
    updateScannedList();
    saveData();
    updateAllDisplays();
    showToast(`‚úÖ Refilled ${refilled} bottles`, 'success');
}

function batchReturn() {
    if (scannedBarcodes.length === 0) {
        showToast('‚ö†Ô∏è Queue is empty', 'warning');
        return;
    }
    
    const store = getCurrentStore();
    let returned = 0;
    
    scannedBarcodes.forEach(bottleId => {
        let bottle = bottles.find(b => b.id === bottleId);
        if (!bottle) {
            bottle = createNewBottleRecord(bottleId, store.id, store.name);
            bottles.push(bottle);
        }
        
        const oldClientId = bottle.clientId;
        
        bottle.status = 'needs-refill';
        bottle.clientId = null;
        bottle.clientName = null;
        bottle.clientPhone = null;
        bottle.lastUpdated = new Date().toISOString();
        bottle.history.push({
            action: 'returned',
            timestamp: new Date().toISOString()
        });
        
        if (oldClientId) {
            updateClientBottleCounts(oldClientId);
        }
        
        returned++;
    });
    
    addActivity(`[${store.name}] ‚Ü©Ô∏è Returned ${returned} bottles (needs refill)`);
    scannedBarcodes = [];
    updateScannedList();
    saveData();
    updateAllDisplays();
    showToast(`‚úÖ Returned ${returned} bottles`, 'success');
}

function batchDeliver() {
    if (scannedBarcodes.length === 0) {
        showToast('‚ö†Ô∏è Queue is empty', 'warning');
        return;
    }
    
    populateClientDropdowns();
    document.getElementById('deliverModal').classList.add('active');
}

function confirmBatchDelivery() {
    const clientSelect = document.getElementById('deliverClientSelect');
    const clientId = clientSelect.value;
    
    if (!clientId) {
        showToast('‚ö†Ô∏è Please select a client', 'warning');
        return;
    }
    
    const client = clients.find(c => c.id === clientId);
    const store = getCurrentStore();
    let delivered = 0;
    
    scannedBarcodes.forEach(bottleId => {
        let bottle = bottles.find(b => b.id === bottleId);
        if (!bottle) {
            bottle = createNewBottleRecord(bottleId, store.id, store.name);
            bottles.push(bottle);
        }
        
        if (bottle.status === 'available' || !bottle.status) {
            autoRemoveFromPallet(bottle.id);
            
            bottle.status = 'with-client';
            bottle.clientId = client.id;
            bottle.clientName = client.name;
            bottle.clientPhone = client.phone;
            bottle.deliveryCount++;
            bottle.lastUpdated = new Date().toISOString();
            bottle.history.push({
                action: 'delivered',
                client: client.name,
                timestamp: new Date().toISOString()
            });
            
            delivered++;
        }
    });
    
    updateClientBottleCounts(client.id);
    addActivity(`[${store.name}] üöö Delivered ${delivered} bottles to ${client.name}`);
    
    scannedBarcodes = [];
    updateScannedList();
    closeDeliverModal();
    saveData();
    updateAllDisplays();
    showToast(`‚úÖ Delivered ${delivered} bottles to ${client.name}`, 'success');
}

function closeDeliverModal() {
    document.getElementById('deliverModal').classList.remove('active');
}

// Data Model Functions
function createNewBottleRecord(id, storeId, storeName) {
    return {
        id,
        status: 'available',
        palletId: null,
        deliveryCount: 0,
        refillCount: 0,
        clientId: null,
        clientName: null,
        clientPhone: null,
        storeId,
        storeName,
        created: new Date().toISOString(),
        lastUpdated: new Date().toISOString(),
        history: [{
            action: 'created',
            timestamp: new Date().toISOString()
        }]
    };
}

function createNewClientRecord(name, phone, address = '') {
    return {
        id: 'client_' + Date.now(),
        name,
        phone,
        address,
        bottleCount: 0,
        created: new Date().toISOString(),
        lastUpdated: new Date().toISOString(),
        history: [{
            action: 'created',
            timestamp: new Date().toISOString()
        }]
    };
}

function updateClientBottleCounts(clientId) {
    const client = clients.find(c => c.id === clientId);
    if (!client) return;
    
    client.bottleCount = bottles.filter(b => b.clientId === clientId).length;
    client.lastUpdated = new Date().toISOString();
}

function createNewPalletRecord(storeId, storeName) {
    const timestamp = Date.now();
    return {
        id: `PAL-${timestamp}`,
        name: `Pallet ${timestamp}`,
        bottleIds: [],
        capacity: PALLET_CAPACITY,
        status: 'empty',
        clientId: null,
        storeId,
        storeName,
        created: new Date().toISOString(),
        lastUpdated: new Date().toISOString(),
        history: [{
            action: 'created',
            timestamp: new Date().toISOString()
        }]
    };
}

function findPalletById(palletId) {
    return pallets.find(p => p.id === palletId);
}

function recalcPalletStatus(palletId) {
    const pallet = findPalletById(palletId);
    if (!pallet) return;
    
    const count = pallet.bottleIds.length;
    const palletBottles = bottles.filter(b => pallet.bottleIds.includes(b.id));
    
    if (count === 0) {
        pallet.status = 'empty';
    } else if (palletBottles.every(b => b.status === 'with-client')) {
        pallet.status = 'with-client';
    } else if (palletBottles.some(b => b.status === 'needs-refill')) {
        pallet.status = 'needs-refill';
    } else if (count === pallet.capacity) {
        pallet.status = 'full';
    } else {
        pallet.status = 'partial';
    }
    
    pallet.lastUpdated = new Date().toISOString();
}

function addBottleToPallet(bottleId, palletId) {
    const bottle = bottles.find(b => b.id === bottleId);
    const pallet = findPalletById(palletId);
    
    if (!bottle || !pallet) return false;
    
    if (pallet.bottleIds.includes(bottleId)) return false;
    
    if (bottle.palletId) {
        removeBottleFromPallet(bottleId, bottle.palletId);
    }
    
    pallet.bottleIds.push(bottleId);
    bottle.palletId = palletId;
    bottle.lastUpdated = new Date().toISOString();
    
    return true;
}

function removeBottleFromPallet(bottleId, palletId) {
    const bottle = bottles.find(b => b.id === bottleId);
    const pallet = findPalletById(palletId);
    
    if (!bottle || !pallet) return false;
    
    pallet.bottleIds = pallet.bottleIds.filter(id => id !== bottleId);
    bottle.palletId = null;
    bottle.lastUpdated = new Date().toISOString();
    
    recalcPalletStatus(palletId);
    return true;
}

function autoRemoveFromPallet(bottleId) {
    const bottle = bottles.find(b => b.id === bottleId);
    if (bottle && bottle.palletId) {
        removeBottleFromPallet(bottleId, bottle.palletId);
    }
}

// Pallet Actions
function deliverPalletById(palletId) {
    const pallet = findPalletById(palletId);
    if (!pallet) return;
    
    populateClientDropdowns();
    
    const modal = document.getElementById('deliverModal');
    modal.setAttribute('data-pallet-id', palletId);
    modal.classList.add('active');
}

function refillPalletById(palletId) {
    const pallet = findPalletById(palletId);
    if (!pallet || pallet.bottleIds.length === 0) {
        showToast('‚ö†Ô∏è Pallet is empty', 'warning');
        return;
    }
    
    let refilled = 0;
    pallet.bottleIds.forEach(bottleId => {
        const bottle = bottles.find(b => b.id === bottleId);
        if (bottle) {
            const oldClientId = bottle.clientId;
            
            bottle.status = 'available';
            bottle.clientId = null;
            bottle.clientName = null;
            bottle.clientPhone = null;
            bottle.refillCount++;
            bottle.lastUpdated = new Date().toISOString();
            bottle.history.push({
                action: 'refilled',
                timestamp: new Date().toISOString()
            });
            
            if (oldClientId) {
                updateClientBottleCounts(oldClientId);
            }
            
            refilled++;
        }
    });
    
    recalcPalletStatus(palletId);
    addActivity(`[${pallet.storeName}] üîÑ Refilled ${refilled} bottles in ${pallet.name || pallet.id}`);
    saveData();
    updateAllDisplays();
    showToast(`‚úÖ Refilled ${refilled} bottles`, 'success');
}

function returnPalletById(palletId) {
    const pallet = findPalletById(palletId);
    if (!pallet || pallet.bottleIds.length === 0) {
        showToast('‚ö†Ô∏è Pallet is empty', 'warning');
        return;
    }
    
    let returned = 0;
    pallet.bottleIds.forEach(bottleId => {
        const bottle = bottles.find(b => b.id === bottleId);
        if (bottle) {
            const oldClientId = bottle.clientId;
            
            bottle.status = 'needs-refill';
            bottle.clientId = null;
            bottle.clientName = null;
            bottle.clientPhone = null;
            bottle.lastUpdated = new Date().toISOString();
            bottle.history.push({
                action: 'returned',
                timestamp: new Date().toISOString()
            });
            
            if (oldClientId) {
                updateClientBottleCounts(oldClientId);
            }
            
            returned++;
        }
    });
    
    recalcPalletStatus(palletId);
    addActivity(`[${pallet.storeName}] ‚Ü©Ô∏è Returned ${returned} bottles in ${pallet.name || pallet.id}`);
    saveData();
    updateAllDisplays();
    showToast(`‚úÖ Returned ${returned} bottles`, 'success');
}

// Delete Functions
function deleteBottle(bottleId) {
    if (!confirm(`Delete bottle ${bottleId}?`)) return;
    
    const bottle = bottles.find(b => b.id === bottleId);
    if (!bottle) return;
    
    if (bottle.palletId) {
        removeBottleFromPallet(bottleId, bottle.palletId);
    }
    
    if (bottle.clientId) {
        updateClientBottleCounts(bottle.clientId);
    }
    
    deletedRecords.push({
        ...bottle,
        deletedAt: new Date().toISOString()
    });
    
    bottles = bottles.filter(b => b.id !== bottleId);
    addActivity(`[${bottle.storeName}] üóëÔ∏è Deleted bottle ${bottleId}`);
    saveData();
    updateAllDisplays();
    showToast(`‚úÖ Deleted bottle ${bottleId}`, 'success');
}

function deletePallet(palletId) {
    if (!confirm(`Delete pallet ${palletId}? All bottles will be removed from it.`)) return;
    
    const pallet = findPalletById(palletId);
    if (!pallet) return;
    
    pallet.bottleIds.forEach(bottleId => {
        const bottle = bottles.find(b => b.id === bottleId);
        if (bottle) {
            bottle.palletId = null;
        }
    });
    
    deletedRecords.push({
        ...pallet,
        deletedAt: new Date().toISOString()
    });
    
    pallets = pallets.filter(p => p.id !== palletId);
    addActivity(`[${pallet.storeName}] üóëÔ∏è Deleted pallet ${palletId}`);
    saveData();
    updateAllDisplays();
    showToast(`‚úÖ Deleted pallet ${palletId}`, 'success');
}

// Render Functions
function renderPallets() {
    const search = document.getElementById('palletSearch').value.toLowerCase();
    const statusFilter = document.getElementById('palletStatusFilter').value;
    
    let filtered = pallets.filter(p => p.storeId === currentStoreId);
    
    if (search) {
        filtered = filtered.filter(p => 
            p.id.toLowerCase().includes(search) || 
            (p.name && p.name.toLowerCase().includes(search))
        );
    }
    
    if (statusFilter) {
        filtered = filtered.filter(p => p.status === statusFilter);
    }
    
    // Render KPIs
    const storePallets = pallets.filter(p => p.storeId === currentStoreId);
    const kpisHtml = `
        <div class="kpi-card">
            <div class="kpi-value">${storePallets.filter(p => p.status === 'empty').length}</div>
            <div class="kpi-label">Empty</div>
        </div>
               <div class="kpi-card">
            <div class="kpi-value">${storePallets.filter(p => p.status === 'partial').length}</div>
            <div class="kpi-label">Partial</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value">${storePallets.filter(p => p.status === 'full').length}</div>
            <div class="kpi-label">Full</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value">${storePallets.filter(p => p.status === 'with-client').length}</div>
            <div class="kpi-label">With Client</div>
        </div>
    `;
    document.getElementById('palletKPIs').innerHTML = kpisHtml;
    
    // Render grid
    const grid = document.getElementById('palletGrid');
    if (filtered.length === 0) {
        grid.innerHTML = '<p style="text-align: center; color: #6b7280;">No pallets found</p>';
        return;
    }
    
    grid.innerHTML = filtered.map(pallet => `
        <div class="card">
            <div class="card-header">
                <div class="card-title">${pallet.name || pallet.id}</div>
                <span class="chip ${getStoreChipClass(pallet.storeId)}">${pallet.storeName}</span>
            </div>
            <div style="margin-bottom: 10px;">
                <span class="chip chip-${pallet.status}">${pallet.status.replace('-', ' ').toUpperCase()}</span>
            </div>
            <div class="progress-bar" style="margin-bottom: 10px;">
                <div class="progress-fill" style="width: ${(pallet.bottleIds.length / pallet.capacity) * 100}%;">
                    ${pallet.bottleIds.length} / ${pallet.capacity}
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <span class="badge">üì¶ ${pallet.bottleIds.length} bottles</span>
            </div>
            <div class="card-actions">
                <button class="btn btn-primary btn-small" onclick="openPalletDetails('${pallet.id}')">Details</button>
                <button class="btn btn-info btn-small" onclick="openTransferPallet('${pallet.id}')">üîÑ Transfer</button>
                <button class="btn btn-secondary btn-small" onclick="printPalletBarcode('${pallet.id}')">üñ®Ô∏è Print</button>
                <button class="btn btn-danger btn-small" onclick="deletePallet('${pallet.id}')">Delete</button>
            </div>
        </div>
    `).join('');
}

function renderInventory() {
    const search = document.getElementById('inventorySearch').value.toLowerCase();
    const statusFilter = document.getElementById('inventoryStatusFilter').value;
    
    let filtered = bottles.filter(b => b.storeId === currentStoreId);
    
    if (search) {
        filtered = filtered.filter(b => b.id.toLowerCase().includes(search));
    }
    
    if (statusFilter) {
        filtered = filtered.filter(b => b.status === statusFilter);
    }
    
    // Render KPIs
    const storeBottles = bottles.filter(b => b.storeId === currentStoreId);
    const kpisHtml = `
        <div class="kpi-card">
            <div class="kpi-value">${storeBottles.filter(b => b.status === 'available').length}</div>
            <div class="kpi-label">Available</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value">${storeBottles.filter(b => b.status === 'needs-refill').length}</div>
            <div class="kpi-label">Needs Refill</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value">${storeBottles.filter(b => b.status === 'with-client').length}</div>
            <div class="kpi-label">With Client</div>
        </div>
    `;
    document.getElementById('inventoryKPIs').innerHTML = kpisHtml;
    
    // Render grid
    const grid = document.getElementById('inventoryGrid');
    if (filtered.length === 0) {
        grid.innerHTML = '<p style="text-align: center; color: #6b7280;">No bottles found</p>';
        return;
    }
    
    grid.innerHTML = filtered.map(bottle => `
        <div class="card">
            <div class="card-header">
                <div class="card-title">${bottle.id}</div>
                <span class="chip ${getStoreChipClass(bottle.storeId)}">${bottle.storeName}</span>
            </div>
            <div style="margin-bottom: 10px;">
                <span class="chip chip-${bottle.status}">${bottle.status.replace('-', ' ').toUpperCase()}</span>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                <span class="badge">üöö ${bottle.deliveryCount} deliveries</span>
                <span class="badge">üîÑ ${bottle.refillCount} refills</span>
            </div>
            ${bottle.palletId ? `<div style="margin-bottom: 10px;"><span class="badge">üì¶ ${bottle.palletId}</span></div>` : ''}
            ${bottle.clientName ? `<div style="margin-bottom: 10px;"><span class="badge">üë§ ${bottle.clientName}</span></div>` : ''}
            <div class="card-actions">
                <button class="btn btn-success btn-small" onclick="setBottleStatus('${bottle.id}', 'available')">Available</button>
                <button class="btn btn-warning btn-small" onclick="setBottleStatus('${bottle.id}', 'needs-refill')">Needs Refill</button>
                <button class="btn btn-info btn-small" onclick="openTransferBottle('${bottle.id}')">üîÑ Transfer</button>
                <button class="btn btn-info btn-small" onclick="openSelectPalletForBottle('${bottle.id}')">‚ûï To Pallet</button>
                <button class="btn btn-danger btn-small" onclick="deleteBottle('${bottle.id}')">Delete</button>
            </div>
        </div>
    `).join('');
}

function setBottleStatus(bottleId, status) {
    const bottle = bottles.find(b => b.id === bottleId);
    if (!bottle) return;
    
    const oldClientId = bottle.clientId;
    bottle.status = status;
    
    if (status === 'available' || status === 'needs-refill') {
        bottle.clientId = null;
        bottle.clientName = null;
        bottle.clientPhone = null;
    }
    
    bottle.lastUpdated = new Date().toISOString();
    bottle.history.push({
        action: `status_changed_to_${status}`,
        timestamp: new Date().toISOString()
    });
    
    if (oldClientId) {
        updateClientBottleCounts(oldClientId);
    }
    
    if (bottle.palletId) {
        recalcPalletStatus(bottle.palletId);
    }
    
    addActivity(`[${bottle.storeName}] üìù Bottle ${bottleId} status: ${status}`);
    saveData();
    updateAllDisplays();
    showToast(`‚úÖ Updated bottle ${bottleId}`, 'success');
}

function renderClients() {
    const search = document.getElementById('clientSearch').value.toLowerCase();
    
    let filtered = clients;
    if (search) {
        filtered = clients.filter(c => 
            c.name.toLowerCase().includes(search) || 
            c.phone.toLowerCase().includes(search)
        );
    }
    
    const grid = document.getElementById('clientGrid');
    if (filtered.length === 0) {
        grid.innerHTML = '<p style="text-align: center; color: #6b7280;">No clients found</p>';
        return;
    }
    
    grid.innerHTML = filtered.map(client => `
        <div class="card">
            <div class="card-header">
                <div class="card-title">${client.name}</div>
            </div>
            <div style="margin-bottom: 10px;">
                <span class="badge">üìû ${client.phone}</span>
            </div>
            ${client.address ? `<div style="margin-bottom: 10px;"><span class="badge">üìç ${client.address}</span></div>` : ''}
            <div style="margin-bottom: 10px;">
                <span class="badge">üì¶ ${client.bottleCount} active bottles</span>
            </div>
        </div>
    `).join('');
}

function updateActivity() {
    const feed = document.getElementById('activityFeed');
    if (activityLog.length === 0) {
        feed.innerHTML = '<p style="text-align: center; color: #6b7280;">No activity yet</p>';
        return;
    }
    
    feed.innerHTML = activityLog.slice().reverse().map(item => `
        <div class="activity-item">
            <div class="activity-time">${new Date(item.timestamp).toLocaleString()}</div>
            <div class="activity-message">${item.message}</div>
        </div>
    `).join('');
}

function addActivity(message) {
    activityLog.push({
        id: Date.now().toString(),
        message,
        timestamp: new Date().toISOString()
    });
    
    // Keep only last 100
    if (activityLog.length > 100) {
        activityLog = activityLog.slice(-100);
    }
}

// Pallet Details Modal
function openPalletDetails(palletId) {
    const pallet = findPalletById(palletId);
    if (!pallet) return;
    
    const palletBottles = bottles.filter(b => pallet.bottleIds.includes(b.id));
    // bottles available in same store and not already in a pallet
    const availableBottles = bottles.filter(b => b.storeId === pallet.storeId && !b.palletId);
    
    const content = `
        <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>${pallet.name || pallet.id}</h3>
                <span class="chip ${getStoreChipClass(pallet.storeId)}">${pallet.storeName}</span>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <span class="chip chip-${pallet.status}">${pallet.status.replace('-', ' ').toUpperCase()}</span>
                <span class="badge">üì¶ ${pallet.bottleIds.length} / ${pallet.capacity}</span>
            </div>
            <div id="palletBarcode" style="text-align: center; margin: 20px 0;"></div>
        </div>
        
        <h4 style="margin-bottom: 10px;">Bottles in Pallet</h4>
        <div style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
            ${palletBottles.length === 0 ? '<p style="color: #6b7280;">No bottles in this pallet</p>' : 
                palletBottles.map(b => `
                    <div style="padding: 10px; background: #f9fafb; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${b.id}</strong>
                            <span class="chip chip-${b.status}" style="margin-left: 10px;">${b.status}</span>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-danger btn-small" onclick="removeBottleFromPallet('${b.id}', '${pallet.id}'); openPalletDetails('${pallet.id}'); updateAllDisplays();">Remove</button>
                        </div>
                    </div>
                `).join('')
            }
        </div>

        <h4 style="margin-bottom: 10px;">Add bottles from inventory (same store)</h4>
        <div style="max-height: 240px; overflow-y: auto; margin-bottom: 20px;">
            ${availableBottles.length === 0 ? '<p style="color:#6b7280;">No available bottles in inventory for this store.</p>' :
                availableBottles.map(b => `
                    <div style="padding: 8px; background: #fff; border-radius: 8px; margin-bottom: 8px; display:flex; align-items:center; justify-content:space-between;">
                        <div><strong>${b.id}</strong> <span class="small" style="margin-left:8px;">${b.status}</span></div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-success btn-small" onclick="addBottleToPalletFromInventory('${b.id}','${pallet.id}'); openPalletDetails('${pallet.id}'); updateAllDisplays();">Add</button>
                        </div>
                    </div>
                `).join('')
            }
        </div>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn btn-success" onclick="refillPalletById('${pallet.id}'); closePalletDetails();">Refill All</button>
            <button class="btn btn-primary" onclick="deliverPalletById('${pallet.id}'); closePalletDetails();">Deliver All</button>
            <button class="btn btn-warning" onclick="returnPalletById('${pallet.id}'); closePalletDetails();">Return All</button>
            <button class="btn btn-info" onclick="openTransferPallet('${pallet.id}'); closePalletDetails();">üîÑ Transfer</button>
            <button class="btn btn-secondary" onclick="printPalletBarcode('${pallet.id}')">üñ®Ô∏è Print</button>
            <button class="btn btn-danger" onclick="deletePallet('${pallet.id}'); closePalletDetails();">Delete</button>
        </div>
    `;
    
    document.getElementById('palletDetailsContent').innerHTML = content;
    document.getElementById('palletDetailsModal').classList.add('active');
    
    addBarcodeToDetails(pallet.id);
}

function closePalletDetails() {
    document.getElementById('palletDetailsModal').classList.remove('active');
}

function addBarcodeToDetails(palletId) {
    try {
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('id', 'barcodeDetails');
        document.getElementById('palletBarcode').innerHTML = '';
        document.getElementById('palletBarcode').appendChild(svg);
        
        JsBarcode('#barcodeDetails', palletId, {
            format: 'CODE128',
            width: 2,
            height: 60,
            displayValue: true
        });
    } catch (e) {
        console.error('Barcode generation error:', e);
    }
}

function addBottleToPalletFromInventory(bottleId, palletId) {
    const pallet = findPalletById(palletId);
    const bottle = bottles.find(b => b.id === bottleId);
    if (!pallet || !bottle) {
        showToast('‚ö†Ô∏è Pallet or bottle not found', 'warning');
        return;
    }
    if (pallet.bottleIds.length >= pallet.capacity) {
        showToast('‚ö†Ô∏è Pallet is full', 'warning');
        warningSound.play();
        return;
    }
    const added = addBottleToPallet(bottleId, palletId);
    if (added) {
        // Ensure bottle store matches pallet
        bottle.storeId = pallet.storeId;
        bottle.storeName = pallet.storeName;
        recalcPalletStatus(palletId);
        saveData();
        updateAllDisplays();
        addActivity(`[${pallet.storeName}] ‚ûï Added bottle ${bottleId} to ${pallet.name || pallet.id}`);
        showToast(`‚úÖ Added ${bottleId} to ${pallet.name || pallet.id}`, 'success');
    } else {
        showToast('‚ö†Ô∏è Could not add bottle to pallet', 'warning');
        warningSound.play();
    }
}

function openSelectPalletForBottle(bottleId) {
    const bottle = bottles.find(b => b.id === bottleId);
    if (!bottle) return;

    const storePallets = pallets.filter(p => p.storeId === bottle.storeId);

    let content = `
        <div class="form-group">
            <p><strong>Bottle:</strong> ${bottle.id}</p>
            <p><strong>Current Store:</strong> ${bottle.storeName}</p>
        </div>
    `;

    if (storePallets.length === 0) {
        content += `
            <p style="color:#6b7280;">No pallets found in this store.</p>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn btn-primary" style="flex:1;" onclick="createPalletAndAddBottle('${bottleId}')">Create new pallet and add</button>
                <button class="btn btn-secondary" style="flex:1;" onclick="closeTransferModal()">Cancel</button>
            </div>
        `;
    } else {
        content += `
            <div class="form-group">
                <label class="form-label">Select Pallet *</label>
                <select id="selectPalletForBottle" class="form-input">
                    ${storePallets.map(p => `<option value="${p.id}">${p.name || p.id} ‚Äî ${p.bottleIds.length}/${p.capacity}</option>`).join('')}
                </select>
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn btn-primary" style="flex:1;" onclick="confirmSelectPalletForBottle('${bottleId}')">Add to Pallet</button>
                <button class="btn btn-secondary" style="flex:1;" onclick="closeTransferModal()">Cancel</button>
            </div>
        `;
    }

    document.getElementById('transferModalTitle').textContent = 'Add Bottle to Pallet';
    document.getElementById('transferContent').innerHTML = content;
    document.getElementById('transferModal').classList.add('active');
}

function confirmSelectPalletForBottle(bottleId) {
    const sel = document.getElementById('selectPalletForBottle');
    if (!sel) {
        showToast('‚ö†Ô∏è No pallet selected', 'warning');
        return;
    }
    const palletId = sel.value;
    const pallet = findPalletById(palletId);
    const bottle = bottles.find(b => b.id === bottleId);

    if (!pallet || !bottle) {
        showToast('‚ö†Ô∏è Pallet or bottle not found', 'warning');
        return;
    }

    if (pallet.bottleIds.length >= pallet.capacity) {
        showToast('‚ö†Ô∏è Pallet is full', 'warning');
        warningSound.play();
        return;
    }

    // If bottle exists in another pallet, remove it
    if (bottle.palletId && bottle.palletId !== palletId) {
        removeBottleFromPallet(bottleId, bottle.palletId);
    }

    // Ensure bottle assigned to pallet store
    bottle.storeId = pallet.storeId;
    bottle.storeName = pallet.storeName;
    bottle.lastUpdated = new Date().toISOString();

    const added = addBottleToPallet(bottleId, palletId);
    if (added) {
        recalcPalletStatus(palletId);
        saveData();
        updateAllDisplays();
        addActivity(`[${pallet.storeName}] ‚ûï Added bottle ${bottleId} to ${pallet.name || pallet.id}`);
        showToast(`‚úÖ Added ${bottleId} to ${pallet.name || pallet.id}`, 'success');
    } else {
        showToast('‚ö†Ô∏è Could not add bottle to pallet (maybe already there)', 'warning');
        warningSound.play();
    }

    closeTransferModal();
}

function createPalletAndAddBottle(bottleId) {
    const bottle = bottles.find(b => b.id === bottleId);
    const store = bottle ? stores.find(s => s.id === bottle.storeId) : getCurrentStore();
    if (!store) {
        showToast('‚ö†Ô∏è Store not found', 'warning');
        return;
    }

    const pallet = createNewPalletRecord(store.id, store.name);
    pallets.push(pallet);

    // Ensure bottle exists
    let b = bottles.find(x => x.id === bottleId);
    if (!b) {
        b = createNewBottleRecord(bottleId, store.id, store.name);
        bottles.push(b);
    } else {
        // assign to same store
        b.storeId = store.id;
        b.storeName = store.name;
    }

    const added = addBottleToPallet(bottleId, pallet.id);
    if (added) {
        recalcPalletStatus(pallet.id);
        saveData();
        updateAllDisplays();
        addActivity(`[${store.name}] üÜï Created ${pallet.name || pallet.id} and added ${bottleId}`);
        showToast(`‚úÖ Created ${pallet.name || pallet.id} and added ${bottleId}`, 'success');
    } else {
        showToast('‚ö†Ô∏è Could not add bottle to new pallet', 'warning');
        warningSound.play();
    }

    closeTransferModal();
}

// Excel Export
function generateExcelReport() {
    const wb = XLSX.utils.book_new();
    
    // Delivered Bottles
    const deliveredBottles = bottles.filter(b => b.status === 'with-client');
    const deliveredData = deliveredBottles.length > 0 ? deliveredBottles.map(b => ({
        'Bottle ID': b.id,
        'Client Name': b.clientName || '',
        'Client Phone': b.clientPhone || '',
        'Store': b.storeName,
        'Delivery Count': b.deliveryCount,
        'Pallet ID': b.palletId || 'None',
        'Created': new Date(b.created).toLocaleString(),
        'Last Updated': new Date(b.lastUpdated).toLocaleString()
    })) : [{ Info: 'No delivered bottles' }];
    const ws1 = XLSX.utils.json_to_sheet(deliveredData);
    XLSX.utils.book_append_sheet(wb, ws1, 'Delivered Bottles');
    
    // Refilled Bottles
    const refilledBottles = bottles.filter(b => b.refillCount > 0);
    const refilledData = refilledBottles.length > 0 ? refilledBottles.map(b => ({
        'Bottle ID': b.id,
        'Status': b.status,
        'Store': b.storeName,
        'Refill Count': b.refillCount,
        'Delivery Count': b.deliveryCount,
        'Pallet ID': b.palletId || 'None',
        'Created': new Date(b.created).toLocaleString()
    })) : [{ Info: 'No refilled bottles' }];
    const ws2 = XLSX.utils.json_to_sheet(refilledData);
    XLSX.utils.book_append_sheet(wb, ws2, 'Refilled Bottles');
    
    // Deleted Records
    const deletedData = deletedRecords.length > 0 ? deletedRecords.map(r => ({
        'Type': r.bottleIds ? 'Pallet' : 'Bottle',
        'ID': r.id,
        'Store': r.storeName || '',
        'Status': r.status || '',
        'Deleted At': new Date(r.deletedAt).toLocaleString()
    })) : [{ Info: 'No deleted records' }];
    const ws3 = XLSX.utils.json_to_sheet(deletedData);
    XLSX.utils.book_append_sheet(wb, ws3, 'Deleted Records');
    
    // Clients
    const clientData = clients.length > 0 ? clients.map(c => ({
        'Name': c.name,
        'Phone': c.phone,
        'Address': c.address || '',
        'Active Bottles': c.bottleCount,
        'Created': new Date(c.created).toLocaleString()
    })) : [{ Info: 'No clients' }];
    const ws4 = XLSX.utils.json_to_sheet(clientData);
    XLSX.utils.book_append_sheet(wb, ws4, 'Clients');
    
    // New Bottles (last 30 days)
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    const newBottles = bottles.filter(b => new Date(b.created) > thirtyDaysAgo);
    const newBottlesData = newBottles.length > 0 ? newBottles.map(b => ({
        'Bottle ID': b.id,
        'Status': b.status,
        'Store': b.storeName,
        'Pallet ID': b.palletId || 'None',
        'Created': new Date(b.created).toLocaleString()
    })) : [{ Info: 'No new bottles in last 30 days' }];
    const ws5 = XLSX.utils.json_to_sheet(newBottlesData);
    XLSX.utils.book_append_sheet(wb, ws5, 'New Bottles');
    
    // Stores Summary
    const storesSummary = stores.map(store => {
        const storeBottles = bottles.filter(b => b.storeId === store.id);
        const storePallets = pallets.filter(p => p.storeId === store.id);
        
        return {
            'Store Name': store.name,
            'Type': store.type,
            'Total Bottles': storeBottles.length,
            'Available': storeBottles.filter(b => b.status === 'available').length,
            'Needs Refill': storeBottles.filter(b => b.status === 'needs-refill').length,
            'With Client': storeBottles.filter(b => b.status === 'with-client').length,
            'Total Pallets': storePallets.length,
            'Empty Pallets': storePallets.filter(p => p.status === 'empty').length,
            'Partial Pallets': storePallets.filter(p => p.status === 'partial').length,
            'Full Pallets': storePallets.filter(p => p.status === 'full').length
        };
    });
    const ws6 = XLSX.utils.json_to_sheet(storesSummary);
    XLSX.utils.book_append_sheet(wb, ws6, 'Stores Summary');
    
    // Generate file
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
    XLSX.writeFile(wb, `Bottle_Tracking_Report_${timestamp}.xlsx`);
    
    addActivity('üìä Generated Excel report');
    showToast('‚úÖ Excel report downloaded', 'success');
}

// Utility Functions
function getStoreChipClass(storeId) {
    const store = stores.find(s => s.id === storeId);
    return store && store.type === 'main' ? 'chip-main' : 'chip-driver';
}

function updateAllDisplays() {
    renderPallets();
    renderInventory();
    renderClients();
    updateActivity();
}

function showToast(message, type = 'success') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s reverse';
        setTimeout(() => {
            container.removeChild(toast);
        }, 300);
    }, 3000);
}

    </script>
</body>
</html>
