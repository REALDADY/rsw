<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>5-Gallon Bottle Tracking System</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* Place this inside a <style> tag in your <head> section for improved UX/UI */

body {
    background: linear-gradient(135deg,#e3f2fd 0%,#f8f9fa 100%);
    font-family: 'Segoe UI', Arial, sans-serif;
    color: #222;
    margin: 0;
    padding: 0;
}

.container {
    max-width: 1100px;
    margin: 40px auto;
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 8px 32px rgba(33,150,243,0.08);
    padding: 32px 24px;
}

.header {
    text-align: center;
    margin-bottom: 32px;
}

.tabs {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-bottom: 32px;
    flex-wrap: wrap;
}

.tab {
    background: linear-gradient(90deg,#2196F3 0%,#20c997 100%);
    color: #fff;
    border: none;
    border-radius: 25px;
    padding: 12px 28px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s, box-shadow 0.2s;
    box-shadow: 0 2px 8px rgba(33,150,243,0.08);
}

.tab:not(.active):hover {
    background: linear-gradient(90deg,#20c997 0%,#2196F3 100%);
    color: #fff;
}

.tab.active {
    background: linear-gradient(90deg,#1565c0 0%,#43e97b 100%);
    color: #fff;
    box-shadow: 0 4px 16px rgba(33,150,243,0.12);
}

.tab-content {
    display: none;
    animation: fadeIn 0.3s;
    padding-bottom: 32px;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px);}
    to { opacity: 1; transform: translateY(0);}
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
    gap: 18px;
    margin-bottom: 32px;
}

.stat-card {
    background: #fff;
    border-radius: 15px;
    box-shadow: 0 2px 8px rgba(33,150,243,0.07);
    padding: 24px 18px;
    text-align: center;
}

.stat-number {
    font-size: 2.2rem;
    font-weight: bold;
    color: #2196F3;
    margin-bottom: 8px;
}

.stat-label {
    font-size: 1rem;
    color: #6c757d;
}

.bottle-grid, #client-list, #users-list {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(320px,1fr));
    gap: 18px;
    margin-top: 18px;
}

.bottle-card {
    background: #fff;
    border-radius: 15px;
    box-shadow: 0 2px 8px rgba(33,150,243,0.07);
    padding: 22px 18px;
    transition: box-shadow 0.2s;
    position: relative;
}

.bottle-card:hover {
    box-shadow: 0 6px 24px rgba(33,150,243,0.13);
}

.bottle-id {
    font-size: 1.2rem;
    font-weight: bold;
    color: #1565c0;
    margin-bottom: 8px;
}

.status {
    display: inline-block;
    padding: 6px 16px;
    border-radius: 12px;
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 8px;
}

.status.available { background: #e3f2fd; color: #2196F3; }
.status.with-client { background: #d4edda; color: #28a745; }
.status.needs-refill { background: #fff3cd; color: #856404; }
.status.maintenance { background: #f8d7da; color: #dc3545; }

.btn, .login-btn {
    background: linear-gradient(90deg,#2196F3 0%,#20c997 100%);
    color: #fff;
    border: none;
    border-radius: 25px;
    padding: 10px 24px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    margin: 4px 0;
    transition: background 0.2s, box-shadow 0.2s;
    box-shadow: 0 2px 8px rgba(33,150,243,0.08);
}

.btn:hover, .login-btn:hover {
    background: linear-gradient(90deg,#20c997 0%,#2196F3 100%);
}

.btn-success { background: linear-gradient(90deg,#43e97b 0%,#38f9d7 100%); color: #fff; }
.btn-warning { background: linear-gradient(90deg,#ffc107 0%,#ff9800 100%); color: #fff; }
.btn-danger { background: linear-gradient(90deg,#dc3545 0%,#ff6a00 100%); color: #fff; }
.btn-secondary { background: linear-gradient(90deg,#6c757d 0%,#b0bec5 100%); color: #fff; }
.btn-sm { padding: 6px 14px; font-size: 0.95rem; border-radius: 18px; }

input, select, textarea {
    font-size: 1rem;
    padding: 12px;
    border-radius: 10px;
    border: 2px solid #e9ecef;
    margin-bottom: 8px;
    width: 100%;
    box-sizing: border-box;
    transition: border 0.2s;
}

input:focus, select:focus, textarea:focus {
    border-color: #2196F3;
    outline: none;
}

.search-input {
    max-width: 320px;
    margin-right: 12px;
}

.search-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 18px;
}

.modal {
    display: none;
    position: fixed;
    z-index: 4000;
    left: 0; top: 0;
    width: 100vw; height: 100vh;
    background: rgba(33,150,243,0.12);
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 8px 32px rgba(33,150,243,0.18);
    padding: 32px 24px;
    max-width: 420px;
    width: 95vw;
    position: relative;
    animation: fadeIn 0.3s;
}

.close {
    position: absolute;
    top: 18px;
    right: 24px;
    font-size: 2rem;
    color: #2196F3;
    cursor: pointer;
    font-weight: bold;
}

@media (max-width: 768px) {
    .container { padding: 12px 4px; }
    .tabs { gap: 6px; }
    .stat-card, .bottle-card { padding: 14px 8px; }
    .modal-content { padding: 18px 8px; }
    .search-row { flex-direction: column; gap: 6px; }
}

.floating-particles {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    pointer-events: none;
    z-index: 0;
    overflow: hidden;
}
.particle {
    position: absolute;
    width: 8px; height: 8px;
    background: #2196F3;
    border-radius: 50%;
    opacity: 0.12;
    animation: floatUp linear infinite;
}
@keyframes floatUp {
    from { top: 100vh; }
    to { top: -20px; }
}

.user-info-badge {
    position: absolute;
    top: 18px; right: 24px;
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 2px 8px rgba(33,150,243,0.08);
    padding: 10px 18px;
    display: flex;
    align-items: center;
    gap: 18px;
    font-size: 1rem;
    z-index: 100;
}

.logout-btn {
    background: linear-gradient(90deg,#dc3545 0%,#ff6a00 100%);
    color: #fff;
    border: none;
    border-radius: 18px;
    padding: 6px 18px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(33,150,243,0.08);
}

#login-screen {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: linear-gradient(135deg,#2196F3 0%,#43e97b 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 5000;
}

.login-box {
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 8px 32px rgba(33,150,243,0.18);
    padding: 38px 28px;
    max-width: 350px;
    width: 95vw;
}

.login-input {
    font-size: 1rem;
    padding: 12px;
    border-radius: 10px;
    border: 2px solid #e9ecef;
    margin-bottom: 12px;
    width: 100%;
    box-sizing: border-box;
    transition: border 0.2s;
}

.login-input:focus {
    border-color: #2196F3;
    outline: none;
}

.small {
    font-size: 0.95rem;
    color: #6c757d;
}

::-webkit-scrollbar {
    width: 8px;
    background: #e3f2fd;
}
::-webkit-scrollbar-thumb {
    background: #2196F3;
    border-radius: 8px;
    opacity: 0.15;
}
</style>
</head>

<body>
<!-- LOGIN SCREEN -->
<div id="login-screen" style="display:none;">
    <div class="login-box">
        <div style="text-align:center;margin-bottom:30px;">
            <h1 style="color:#2196F3;font-size:2.5rem;margin-bottom:10px;"> Bottle Tracker</h1>
            <p style="color:#6c757d;">Secure Login Required</p>
        </div>
        
        <!-- Login Form -->
        <div id="login-form">
            <input type="text" id="login-username" placeholder="Username" class="login-input">
            <input type="password" id="login-password" placeholder="Password" class="login-input" onkeypress="if(event.key==='Enter')attemptLogin()">
            <button onclick="attemptLogin()" class="login-btn">ğŸ”“ Login</button>
            <div style="text-align:center;margin-top:20px;">
                <a href="#" onclick="showRequestAccess();return false;" style="color:#2196F3;text-decoration:none;font-weight:600;">ğŸ“ Request Access</a>
            </div>
        </div>
        
        <!-- Request Access Form -->
        <div id="request-form" style="display:none;">
            <input type="text" id="req-name" placeholder="Your Full Name" class="login-input">
            <input type="text" id="req-username" placeholder="Desired Username" class="login-input">
            <input type="password" id="req-password" placeholder="Password" class="login-input">
            <select id="req-role" class="login-input">
                <option value="">Select Role</option>
                <option value="worker">ğŸ‘· Store Worker - Refill & Return Only</option>
                <option value="driver">ğŸšš Driver - Deliver Only + Inventory/Clients</option>
                <option value="manager">ğŸª Store Manager - Full Access (except users)</option>
                <option value="admin">ğŸ‘‘ Admin - Complete Control (requires approval)</option>
            </select>
            <button onclick="submitAccessRequest()" class="login-btn" style="background:linear-gradient(45deg,#28a745,#20c997);margin-bottom:10px;">ğŸ“¤ Submit Request</button>
            <button onclick="showLoginForm()" class="login-btn" style="background:#6c757d;">â† Back to Login</button>
        </div>
    </div>
</div>

<div id="mobile-nav" style="display:none;position:fixed;top:20px;right:20px;z-index:3000;">
  <button id="hamburger-btn" class="btn" style="padding:10px 15px;font-size:22px;">
    â˜°
  </button>
  <div id="drawer" style="display:none;position:absolute;top:50px;right:0;background:white;border-radius:15px;box-shadow:0 8px 24px rgba(0,0,0,0.15);min-width:180px;">
    <button class="tab" onclick="showTab(event,'dashboard')" id="dashboard-tab-mobile">ğŸ  Dashboard</button>
    <button class="tab" onclick="showTab(event,'scanner')" id="scanner-tab-mobile">ğŸ“± Scanner</button>
    <button class="tab" onclick="showTab(event,'inventory')" id="inventory-tab-mobile">ğŸ“¦ Inventory</button>
    <button class="tab" onclick="showTab(event,'clients')" id="clients-tab-mobile">ğŸ‘¥ Clients</button>
    <button class="tab" onclick="showTab(event,'reports')" id="reports-tab-mobile">ğŸ”’ Reports</button>
    <button class="tab" onclick="showTab(event,'users')" id="users-tab-mobile" style="display:none;">ğŸ‘¥ Users</button>
  </div>
</div>

<div class="floating-particles"></div>
<div class="container">
<div class="header">
<h1> Bottle Tracking System</h1>
<p>all rights are are credited to AR GREEN </p>
</div>

<div class="tabs">
<button class="tab active" onclick="showTab(event,'dashboard')" id="dashboard-tab">ğŸ  Dashboard</button>
<button class="tab" onclick="showTab(event,'scanner')" id="scanner-tab">ğŸ“± Scanner</button>
<button class="tab" onclick="showTab(event,'inventory')" id="inventory-tab">ğŸ“¦ Inventory</button>
<button class="tab" onclick="showTab(event,'clients')" id="clients-tab">ğŸ‘¥ Clients</button>
<button class="tab" onclick="showTab(event,'reports')" id="reports-tab">ğŸ”’ Reports</button>
<button class="tab" onclick="showTab(event,'users')" id="users-tab" style="display:none;">ğŸ‘¥ Users</button>
</div>

<!-- Dashboard Tab -->
<div id="dashboard" class="tab-content active">
<h2>ğŸ“Š System Overview</h2>
<div class="stats-grid">
<div class="stat-card">
<div class="stat-number" id="total-bottles">0</div>
<div class="stat-label">Total Bottles</div>
</div>
<div class="stat-card">
<div class="stat-number" id="available-bottles">0</div>
<div class="stat-label">Available</div>
</div>
<div class="stat-card">
<div class="stat-number" id="with-client-bottles">0</div>
<div class="stat-label">With Clients</div>
</div>
<div class="stat-card">
<div class="stat-number" id="needs-refill-bottles">0</div>
<div class="stat-label">Need Refill</div>
</div>
<div class="stat-card">
<div class="stat-number" id="maintenance-bottles">0</div>
<div class="stat-label">Maintenance</div>
</div>
<div class="stat-card">
<div class="stat-number" id="total-clients">0</div>
<div class="stat-label">Active Clients</div>
</div>
</div>

<h3>ğŸ”¥ Recent Activity</h3>
<div id="recent-activity" style="background:rgba(255,255,255,0.8);border-radius:15px;padding:20px;margin-top:15px;max-height:300px;overflow-y:auto;">
<p class="small">No recent activity</p>
</div>

<h3 style="margin-top:25px;">âš ï¸ Alerts & Notifications</h3>
<div id="alerts" style="background:rgba(255,255,255,0.8);border-radius:15px;padding:20px;margin-top:15px;">
<p class="small">No alerts</p>
</div>
</div>

<!-- Scanner Tab -->
<div id="scanner" class="tab-content">
<h2>ğŸ“± Camera Barcode Scanner</h2>

<div style="text-align:center;margin-bottom:30px;">
<div id="camera-container" style="position:relative;max-width:500px;margin:0 auto;">
<div id="barcode-scanner" style="width:100%;height:300px;border-radius:15px;overflow:hidden;background:#000;position:relative;">
<div id="scanner-placeholder" style="width:100%;height:100%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;color:white;font-size:18px;">
<div style="text-align:center;">
<div style="font-size:4rem;margin-bottom:15px;">ğŸ“·</div>
<div>Click "Start Scanner" to begin</div>
</div>
</div>
</div>

<div id="scan-result" style="margin-top:15px;padding:15px;background:rgba(40,167,69,0.1);border-radius:10px;color:#155724;font-weight:bold;display:none;">
<div style="display:flex;align-items:center;justify-content:center;gap:10px;">
<span>âœ… Scanned:</span>
<span id="scanned-code" style="font-family:monospace;font-size:18px;"></span>
</div>
</div>
</div>

<div style="margin:15px 0;">
<button class="btn" id="start-scanner-btn" onclick="startBarcodeScanner()">ğŸ“· Start Scanner</button>
<button class="btn btn-secondary" id="stop-scanner-btn" onclick="stopBarcodeScanner()" style="display:none;">â¹ï¸ Stop Scanner</button>
</div>
</div>

<div class="barcode-input">
<h3 style="text-align:center;margin-bottom:20px;">ğŸ“ Manual Entry</h3>
<label for="manual-barcode" style="font-weight:600;color:#495057;">Enter Barcode Manually:</label>
<input type="text" id="manual-barcode" placeholder="Type barcode numbers here..." 
       style="padding:15px 20px;border-radius:10px;border:2px solid #e9ecef;font-size:18px;font-family:monospace;">

<div class="barcode-display" id="barcode-display">
Waiting for barcode input...
</div>

<button class="btn" onclick="processBottle()" style="align-self:center;padding:15px 30px;font-size:18px;">
ğŸ” Process Bottle
</button>
</div>
</div>

<!-- Inventory Tab -->
<div id="inventory" class="tab-content">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;margin-bottom:25px;">
<h2>ğŸ“¦ Inventory Management</h2>
<div id="add-bottle-btn-container"></div>
</div>

<div class="search-row">
<input type="text" id="search-bottles" class="search-input" placeholder="ğŸ” Search bottles by ID, status, or client..." onkeyup="searchBottles()">
<select id="filter-status" onchange="filterBottles()" style="padding:12px;border-radius:25px;border:2px solid #e9ecef;">
<option value="">All Statuses</option>
<option value="available">Available</option>
<option value="with-client">With Client</option>
<option value="needs-refill">Needs Refill</option>
<option value="maintenance">Maintenance</option>
</select>
</div>

<div id="bottle-inventory" class="bottle-grid">
</div>
</div>

<!-- Clients Tab -->
<div id="clients" class="tab-content">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;margin-bottom:25px;">
<h2>ğŸ‘¥ Client Management</h2>
<div id="add-client-btn-container"></div>
</div>

<div class="search-row">
<input type="text" id="search-clients" class="search-input" placeholder="ğŸ” Search clients by name or phone..." onkeyup="searchClients()">
</div>

<div id="client-list" class="bottle-grid">
</div>
</div>

<!-- Reports Tab -->
<div id="reports" class="tab-content">
<h2>ğŸ“Š Reports & Analytics</h2>

<div class="search-row">
<input type="date" id="report-start" style="padding:12px;border-radius:10px;border:2px solid #e9ecef;">
<input type="date" id="report-end" style="padding:12px;border-radius:10px;border:2px solid #e9ecef;">
<button class="btn" onclick="generateReport()">ğŸ“ˆ Generate Report</button>
<button class="btn btn-success" onclick="exportToExcel()">ğŸ“¥ Export to Excel</button>
</div>

<div id="reports-content" style="margin-top:25px;">
<div style="background:rgba(255,255,255,0.8);border-radius:15px;padding:25px;">
<h3>ğŸ“‹ Summary Report</h3>
<div id="report-summary">
<p class="small">Select date range and click "Generate Report" to view analytics.</p>
</div>
</div>
</div>
</div>

<!-- Users Tab (Admin Only) -->
<div id="users" class="tab-content">
<h2>ğŸ‘¥ User Management</h2>

<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;margin-bottom:25px;">
    <div style="display:flex;gap:15px;flex-wrap:wrap;">
        <span style="padding:10px 20px;background:rgba(33,150,243,0.1);border-radius:10px;color:#2196F3;font-weight:bold;">
            Total Users: <span id="total-users">0</span>
        </span>
        <span style="padding:10px 20px;background:rgba(255,193,7,0.1);border-radius:10px;color:#856404;font-weight:bold;">
            Pending Requests: <span id="pending-requests">0</span>
        </span>
    </div>
</div>

<!-- Access Requests -->
<div id="access-requests-section" style="margin-bottom:30px;">
    <h3>ğŸ“‹ Pending Access Requests</h3>
    <div id="access-requests-list" style="background:rgba(255,255,255,0.8);border-radius:15px;padding:20px;margin-top:15px;">
        <p class="small">No pending requests</p>
    </div>
</div>

<!-- Active Users -->
<h3>âœ… Active Users</h3>
<div id="users-list" class="bottle-grid"></div>
</div>
</div>

<!-- Modals -->
<div id="bottle-modal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeModal()">&times;</span>
<h2 id="modal-title">Bottle Actions</h2>
<div id="modal-bottle-info"></div>
<div id="modal-action-buttons" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:20px;">
<!-- Buttons will be dynamically added here -->
</div>
</div>
</div>

<div id="add-bottle-modal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeAddModal()">&times;</span>
<h2>â• Add New Bottle</h2>
<div style="display:flex;flex-direction:column;gap:15px;margin-top:20px;">
<input type="text" id="new-bottle-id" placeholder="Bottle Barcode/ID" style="padding:12px;border-radius:10px;border:2px solid #e9ecef;">
<input type="text" id="new-bottle-client-search" placeholder="ğŸ” Search client..." oninput="filterNewBottleClients()" style="padding:12px;border-radius:10px;border:2px solid #e9ecef;">
<select id="new-bottle-client-select" size="5" style="padding:12px;border-radius:10px;border:2px solid #e9ecef;">
<option value="">Select Client (optional)</option>
</select>
<select id="new-bottle-status" style="padding:12px;border-radius:10px;border:2px solid #e9ecef;">
<option value="available">Available</option>
<option value="with-client">With Client</option>
<option value="needs-refill">Needs Refill</option>
<option value="maintenance">Maintenance</option>
</select>
<button class="btn btn-success" onclick="createNewBottle()" style="margin-top:10px;">âœ… Create Bottle</button>
</div>
</div>
</div>

<div id="add-client-modal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeClientModal()">&times;</span>
<h2>â• Add New Client</h2>
<div style="display:flex;flex-direction:column;gap:15px;margin-top:20px;">
<input type="text" id="new-client-name" placeholder="Client Name" style="padding:12px;border-radius:10px;border:2px solid #e9ecef;">
<input type="tel" id="new-client-phone" placeholder="Phone Number" style="padding:12px;border-radius:10px;border:2px solid #e9ecef;">
<input type="text" id="new-client-address" placeholder="Address (optional)" style="padding:12px;border-radius:10px;border:2px solid #e9ecef;">
<textarea id="new-client-notes" placeholder="Notes (optional)" style="padding:12px;border-radius:10px;border:2px solid #e9ecef;resize:vertical;min-height:80px;"></textarea>
<button class="btn btn-success" onclick="createNewClient()" style="margin-top:10px;">âœ… Create Client</button>
</div>
</div>
</div>

<div id="delivery-modal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeDeliveryModal()">&times;</span>
<h2>ğŸšš Deliver Bottle</h2>
<div style="display:flex;flex-direction:column;gap:15px;margin-top:20px;">

<div style="display:flex;gap:10px;margin-bottom:10px;">
<button class="btn btn-sm" id="existing-client-btn" onclick="toggleClientMode('existing')" style="flex:1;">Existing Client</button>
<button class="btn btn-sm btn-secondary" id="new-client-btn" onclick="toggleClientMode('new')" style="flex:1;">New Client</button>
</div>

<div id="existing-client-section">
<input type="text" id="delivery-client-search" placeholder="ğŸ” Search client by name or phone..." 
       style="padding:12px;border-radius:10px;border:2px solid #e9ecef;width:100%;margin-bottom:10px;"
       oninput="filterDeliveryClients()">
<select id="delivery-client-select" size="5" style="padding:12px;border-radius:10px;border:2px solid #e9ecef;width:100%;">
<option value="">Select Client</option>
</select>
</div>

<div id="new-client-section" style="display:none;flex-direction:column;gap:15px;">
<input type="text" id="delivery-new-client-name" placeholder="Client Name *" style="padding:12px;border-radius:10px;border:2px solid #e9ecef;">
<input type="tel" id="delivery-new-client-phone" placeholder="Phone Number *" style="padding:12px;border-radius:10px;border:2px solid #e9ecef;">
<input type="text" id="delivery-new-client-address" placeholder="Address (optional)" style="padding:12px;border-radius:10px;border:2px solid #e9ecef;">
<textarea id="delivery-new-client-notes" placeholder="Notes (optional)" style="padding:12px;border-radius:10px;border:2px solid #e9ecef;resize:vertical;min-height:60px;"></textarea>
</div>

<input type="date" id="delivery-date" style="padding:12px;border-radius:10px;border:2px solid #e9ecef;">
<input type="time" id="delivery-time" style="padding:12px;border-radius:10px;border:2px solid #e9ecef;">
<textarea id="delivery-notes" placeholder="Delivery notes (optional)" style="padding:12px;border-radius:10px;border:2px solid #e9ecef;resize:vertical;min-height:80px;"></textarea>
<button class="btn btn-success" onclick="confirmDelivery()" style="margin-top:10px;">âœ… Confirm Delivery</button>
</div>
</div>
</div>

<script>
const STORAGE_KEY = 'bottleAppData_v3';

const SUPABASE_URL = 'https://oqvrssqsbwxxijhnneev.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xdnJzc3FzYnd4eGlqaG5uZWV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxODEzOTMsImV4cCI6MjA3NDc1NzM5M30.lh7LKucWlSaoC54d6yCb8bHSR3OHkBTbnm4ozWdRFag';


const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// USER AUTHENTICATION SYSTEM
let currentUser = null;
let users = [
    {
        id: 'admin_001',
        username: 'admin',
        password: '1234',
        role: 'admin',
        name: 'Administrator',
        created: new Date().toISOString(),
        active: true
    },
    {
        id: 'manager_001',
        username: 'manager',
        password: '1234',
        role: 'manager',
        name: 'Store Manager',
        created: new Date().toISOString(),
        active: true
    },
    {
        id: 'driver_001',
        username: 'driver',
        password: '1234',
        role: 'driver',
        name: 'Driver',
        created: new Date().toISOString(),
        active: true
    },
    {
        id: 'worker_001',
        username: 'worker',
        password: '1234',
        role: 'worker',
        name: 'Store Worker',
        created: new Date().toISOString(),
        active: true
    }
];
let accessRequests = [];

let bottles = [];
let clients = [];
let currentBottleId = null;
let activityLog = [];
let scannerActive = false;
let deliveryClientMode = 'existing';

const DELETE_PASSWORD = '1234';
const REPORTS_PASSWORD = '1234';
let reportsUnlocked = false;

// ================================================
// AUTHENTICATION FUNCTIONS
// ================================================

async function loadUsers() {
    try {
        const { data } = await supabase
            .from('bottle_data')
            .select('users')
            .eq('id', 'main')
            .single();
        
        if (data && Array.isArray(data.users) && data.users.length > 0) {
            users = data.users;
        } else {
            // Fallback to hardcoded users if Supabase is empty
            users = [
                {
                    id: 'admin_001',
                    username: 'admin',
                    password: '1234',
                    role: 'admin',
                    name: 'Administrator',
                    created: new Date().toISOString(),
                    active: true
                },
                {
                    id: 'manager_001',
                    username: 'manager',
                    password: '1234',
                    role: 'manager',
                    name: 'Store Manager',
                    created: new Date().toISOString(),
                    active: true
                },
                {
                    id: 'driver_001',
                    username: 'driver',
                    password: '1234',
                    role: 'driver',
                    name: 'Driver',
                    created: new Date().toISOString(),
                    active: true
                },
                {
                    id: 'worker_001',
                    username: 'worker',
                    password: '1234',
                    role: 'worker',
                    name: 'Store Worker',
                    created: new Date().toISOString(),
                    active: true
                }
            ];
        }
    } catch (error) {
        console.error('Error loading users:', error);
    }
}

async function saveUsers() {
    try {
        const { data: existing } = await supabase
            .from('bottle_data')
            .select('*')
            .eq('id', 'main')
            .single();
        
        await supabase
            .from('bottle_data')
            .upsert({
                ...existing,
                id: 'main',
                users: users,
                // access_requests: accessRequests, // removed
                last_updated: new Date().toISOString()
            });
        console.log('Users saved successfully');
    } catch (error) {
        console.error('Error saving users:', error);
    }
}

function checkAuth() {
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        return true;
    }
    return false;
}

function login(username, password) {
    const user = users.find(u => u.username === username && u.password === password && u.active);
    if (user) {
        currentUser = user;
        localStorage.setItem('currentUser', JSON.stringify(user));
        return true;
    }
    return false;
}

function logout() {
    if (confirm('Are you sure you want to logout?')) {
        currentUser = null;
        localStorage.removeItem('currentUser');
        reportsUnlocked = false;
        location.reload();
    }
}

function hasPermission(tab) {
    if (!currentUser) return false;
    
    const permissions = {
        'admin': ['dashboard', 'scanner', 'inventory', 'clients', 'reports', 'users'],
        'manager': ['dashboard', 'scanner', 'inventory', 'reports'],
        'driver': ['inventory', 'clients'],
        'worker': ['scanner']
    };
    
    return permissions[currentUser.role]?.includes(tab) || false;
}

function attemptLogin() {
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value;
    
    if (!username || !password) {
        alert('Please enter username and password');
        return;
    }
    
    if (login(username, password)) {
        document.getElementById('login-screen').style.display = 'none';
        initializeApp();
        showUserInfo();
        setupBarcodeInput();
        createFloatingParticles();
        setupDefaultDates();
    } else {
        alert('âŒ Invalid username or password!');
    }
}

function showRequestAccess() {
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('request-form').style.display = 'block';
}

function showLoginForm() {
    document.getElementById('login-form').style.display = 'block';
    document.getElementById('request-form').style.display = 'none';
}

async function submitAccessRequest() {
    const name = document.getElementById('req-name').value.trim();
    const username = document.getElementById('req-username').value.trim();
    const password = document.getElementById('req-password').value;
    const role = document.getElementById('req-role').value;
    
    if (!name || !username || !password || !role) {
        alert('Please fill in all fields');
        return;
    }
    
    if (users.find(u => u.username === username)) {
        alert('âŒ Username already exists! Please choose a different username.');
        return;
    }
    
    if (accessRequests.find(r => r.username === username)) {
        alert('âŒ A request with this username already exists!');
        return;
    }
    
    const request = {
        id: 'req_' + Date.now(),
        name: name,
        username: username,
        password: password,
        role: role,
        requested: new Date().toISOString(),
        status: 'pending'
    };
    
    accessRequests.push(request);
    await saveUsers();
    
    alert('âœ… Access request submitted!\n\nYour request has been sent to the administrator for approval. You will be able to login once approved.');
    showLoginForm();
    
    document.getElementById('req-name').value = '';
    document.getElementById('req-username').value = '';
    document.getElementById('req-password').value = '';
    document.getElementById('req-role').value = '';
}

function showUserInfo() {
    const header = document.querySelector('.header');
    
    const existingBadge = header.querySelector('.user-info-badge');
    if (existingBadge) existingBadge.remove();
    
    const roleIcons = {
        'admin': 'ğŸ‘‘',
        'manager': 'ğŸª',
        'driver': 'ğŸšš',
        'worker': 'ğŸ‘·'
    };
    
    const userInfo = document.createElement('div');
    userInfo.className = 'user-info-badge';
    userInfo.innerHTML = `
        <div>
            <strong>${roleIcons[currentUser.role]} ${currentUser.name}</strong><br>
            <span style="font-size:13px;opacity:0.9;">${currentUser.role.toUpperCase()}</span>
        </div>
        <button onclick="logout()" class="logout-btn">ğŸšª Logout</button>
    `;
    header.appendChild(userInfo);
    
    // Show/hide tabs based on permissions
    const allTabs = ['dashboard', 'scanner', 'inventory', 'clients', 'reports', 'users'];
    allTabs.forEach(tab => {
        const desktopTab = document.getElementById(`${tab}-tab`);
        const mobileTab = document.getElementById(`${tab}-tab-mobile`);
        
        if (hasPermission(tab)) {
            if (desktopTab) desktopTab.style.display = 'block';
            if (mobileTab) mobileTab.style.display = 'block';
        } else {
            if (desktopTab) desktopTab.style.display = 'none';
            if (mobileTab) mobileTab.style.display = 'none';
        }
    });
    
    // Set default tab based on role
    const firstAllowedTab = allTabs.find(tab => hasPermission(tab));
    if (firstAllowedTab) {
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        
        document.getElementById(firstAllowedTab).classList.add('active');
        const tabBtn = document.getElementById(`${firstAllowedTab}-tab`);
        if (tabBtn) tabBtn.classList.add('active');
    }
}

async function approveRequest(requestId) {
    const request = accessRequests.find(r => r.id === requestId);
    if (!request) return;
    
    if (!confirm(`Approve access request from ${request.name}?\n\nUsername: ${request.username}\nRole: ${request.role}`)) {
        return;
    }
    
    const newUser = {
        id: 'user_' + Date.now(),
        username: request.username,
        password: request.password,
        role: request.role,
        name: request.name,
        created: new Date().toISOString(),
        active: true
    };
    
    users.push(newUser);
    accessRequests = accessRequests.filter(r => r.id !== requestId);
    
    await saveUsers();
    alert(`âœ… User ${request.name} has been approved!\n\nThey can now login with username: ${request.username}`);
    updateUsersDisplay();
}

async function rejectRequest(requestId) {
    const request = accessRequests.find(r => r.id === requestId);
    if (!request) return;
    
    if (confirm(`Reject access request from ${request.name}?`)) {
        accessRequests = accessRequests.filter(r => r.id !== requestId);
        await saveUsers();
        alert('âŒ Request rejected');
        updateUsersDisplay();
    }
}

async function deleteUser(userId) {
    const password = prompt('âš ï¸ Enter admin password to delete user:');
    if (password !== DELETE_PASSWORD) {
        alert('âŒ Incorrect password!');
        return;
    }
    
    const user = users.find(u => u.id === userId);
    if (!user) return;
    
    if (user.id === currentUser.id) {
        alert('âŒ You cannot delete yourself!');
        return;
    }
    
    if (confirm(`Delete user ${user.name}?\n\nThis action cannot be undone.`)) {
        users = users.filter(u => u.id !== userId);
        await saveUsers();
        alert('âœ… User deleted successfully');
        updateUsersDisplay();
    }
}

function updateUsersDisplay() {
    const requestsList = document.getElementById('access-requests-list');
    document.getElementById('pending-requests').textContent = accessRequests.length;
    
    if (accessRequests.length > 0) {
        requestsList.innerHTML = accessRequests.map(req => {
            const roleLabels = {
                'worker': 'ğŸ‘· Store Worker - Refill & Return Only',
                'driver': 'ğŸšš Driver - Deliver Only',
                'manager': 'ğŸª Store Manager - Full Access',
                'admin': 'ğŸ‘‘ Admin - Complete Control'
            };
            
            return `
            <div style="background:rgba(255,193,7,0.1);padding:20px;border-radius:15px;margin:10px 0;border-left:4px solid #ffc107;">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;">
                    <div>
                        <strong style="font-size:18px;">${req.name}</strong><br>
                        <span style="color:#6c757d;">Username: <strong>${req.username}</strong></span><br>
                        <span style="color:#6c757d;">Role: <strong>${roleLabels[req.role]}</strong></span><br>
                        <span style="color:#6c757d;font-size:14px;">Requested: ${new Date(req.requested).toLocaleString()}</span>
                    </div>
                    <div style="display:flex;gap:10px;">
                        <button class="btn btn-success btn-sm" onclick="approveRequest('${req.id}')">âœ… Approve</button>
                        <button class="btn btn-danger btn-sm" onclick="rejectRequest('${req.id}')">âŒ Reject</button>
                    </div>
                </div>
            </div>
        `;
        }).join('');
    } else {
        requestsList.innerHTML = '<p class="small" style="text-align:center;padding:20px;color:#6c757d;">No pending requests</p>';
    }
    
    const usersList = document.getElementById('users-list');
    document.getElementById('total-users').textContent = users.length;
    
    const roleIcons = {
        'admin': 'ğŸ‘‘',
        'manager': 'ğŸª',
        'driver': 'ğŸšš',
        'worker': 'ğŸ‘·'
    };
    
    usersList.innerHTML = users.map(user => `
        <div class="bottle-card">
            <div class="bottle-id">${roleIcons[user.role]} ${user.name}</div>
            <div class="status ${user.role === 'admin' ? 'available' : user.role === 'manager' ? 'with-client' : 'needs-refill'}">${user.role.toUpperCase()}</div>
            <div style="margin:15px 0;">
                <div><strong>Username:</strong> ${user.username}</div>
                <div><strong>Role:</strong> ${roleIcons[user.role]} ${user.role === 'admin' ? 'Administrator' : user.role === 'manager' ? 'Store Manager' : user.role === 'driver' ? 'Driver' : 'Store Worker'}</div>
                <div><strong>Created:</strong> ${new Date(user.created).toLocaleString()}</div>
                <div><strong>Status:</strong> ${user.active ? 'âœ… Active' : 'âŒ Inactive'}</div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                ${user.id !== currentUser.id ? `<button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')">ğŸ—‘ï¸ Delete</button>` : '<span style="color:#6c757d;font-style:italic;">Current User</span>'}
            </div>
        </div>
    `).join('');
}

async function initializeApp() {
    await loadData();
    updateAllDisplays();
    if (currentUser && currentUser.role === 'admin') {
        updateUsersDisplay();
    }
}

// ================================================
// DATA MANAGEMENT
// ================================================

document.addEventListener('DOMContentLoaded', async () => {
    console.log('Initializing system with authentication...');
    
    await loadUsers();
    
    if (checkAuth()) {
        document.getElementById('login-screen').style.display = 'none';
        await initializeApp();
        showUserInfo();
        setupBarcodeInput();
        createFloatingParticles();
        setupDefaultDates();
    } else {
        document.getElementById('login-screen').style.display = 'flex';
    }
});

// Fix: Remove 'access_requests' from Supabase upsert if not in schema
async function saveData() {
    console.log('Saving data to Supabase...');
    try {
        const { data, error } = await supabase
            .from('bottle_data')
            .upsert({
                id: 'main',
                bottles: bottles,
                clients: clients,
                activity_log: activityLog,
                users: users,
                // access_requests: accessRequests, // <-- REMOVE this line
                last_updated: new Date().toISOString()
            });
        
        if (error) throw error;
        console.log('Data saved to Supabase successfully!');
        
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
            bottles: bottles,
            clients: clients,
            activityLog: activityLog,
            lastUpdated: new Date().toISOString()
        }));
        
    } catch (error) {
        console.error('Error saving data to Supabase:', error);
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({
                bottles: bottles,
                clients: clients,
                activityLog: activityLog,
                lastUpdated: new Date().toISOString()
            }));
            console.log('Data saved to localStorage as fallback');
        } catch (localError) {
            console.error('Error saving to localStorage:', localError);
            alert('Error saving data. Please check your connection.');
        }
    }
}

async function loadData() {
    console.log('Loading data from Supabase...');
    try {
        const { data, error } = await supabase
            .from('bottle_data')
            .select('*')
            .eq('id', 'main')
            .single();
        
        if (data) {
            bottles = Array.isArray(data.bottles) ? data.bottles : [];
            clients = Array.isArray(data.clients) ? data.clients : [];
            activityLog = Array.isArray(data.activity_log) ? data.activity_log : [];
            console.log(`Loaded ${bottles.length} bottles and ${clients.length} clients from Supabase`);
        } else {
            console.log('No data found in Supabase, checking localStorage...');
            const raw = localStorage.getItem(STORAGE_KEY);
            if (raw) {
                const localData = JSON.parse(raw);
                bottles = localData.bottles || [];
                clients = localData.clients || [];
                activityLog = localData.activityLog || [];
                console.log(`Loaded ${bottles.length} bottles and ${clients.length} clients from localStorage`);
                await saveData();
            } else {
                console.log('No existing data found, initializing empty system');
                initializeSampleData();
                await saveData();
            }
        }
    } catch (error) {
        console.error('Error loading data from Supabase:', error);
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (raw) {
                const localData = JSON.parse(raw);
                bottles = localData.bottles || [];
                clients = localData.clients || [];
                activityLog = localData.activityLog || [];
                console.log(`Loaded ${bottles.length} bottles and ${clients.length} clients from localStorage fallback`);
            } else {
                console.log('No localStorage data found, initializing empty system');
                initializeSampleData();
            }
        } catch (localError) {
            console.error('Error loading from localStorage:', localError);
            initializeSampleData();
        }
    }
}

function initializeSampleData() {
    clients = [];
    bottles = [];
    activityLog = [
        { action: 'System initialized', timestamp: new Date().toISOString() }
    ];
}

function updateClientBottleCounts() {
    clients.forEach(client => {
        client.bottleCount = bottles.filter(bottle => bottle.clientId === client.id).length;
    });
}

function showTab(event, tabName) {
    if (tabName === 'reports' && !reportsUnlocked) {
        const password = prompt('ğŸ”’ Reports section is protected.\n\nEnter password to access:');
        
        if (password !== REPORTS_PASSWORD) {
            alert('âŒ Incorrect password! Access denied.');
            return;
        }
        
        reportsUnlocked = true;
        alert('âœ… Access granted! Reports unlocked for this session.');
    }
    
    if (!hasPermission(tabName)) {
        alert('âŒ You don\'t have permission to access this section!');
        return;
    }
    
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tabName).classList.add('active');
    
    if (tabName === 'dashboard') updateDashboard();
    if (tabName === 'inventory') updateInventoryDisplay();
    if (tabName === 'clients') updateClientDisplay();
    if (tabName === 'reports') updateReports();
    if (tabName === 'users' && currentUser && currentUser.role === 'admin') {
        updateUsersDisplay();
    }
}

function startBarcodeScanner() {
    if (scannerActive) return;
    Quagga.offDetected();
    const scannerDiv = document.getElementById('barcode-scanner');
    const placeholder = document.getElementById('scanner-placeholder');
    const startBtn = document.getElementById('start-scanner-btn');
    const stopBtn = document.getElementById('stop-scanner-btn');
    placeholder.style.display = 'none';

    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: scannerDiv,
            constraints: {
                width: 640,
                height: 480,
                facingMode: "environment"
            }
        },
        locator: {
            patchSize: "medium",
            halfSample: false
        },
        numOfWorkers: 2,
        frequency: 5,
        decoder: {
            readers: [
                "code_128_reader",
                "ean_reader",
                "ean_8_reader",
                "code_39_reader",
                "upc_reader",
                "upc_e_reader"
            ]
        }
    }, function(err) {
        if (err) {
            console.error('QuaggaJS initialization error:', err);
            placeholder.style.display = 'flex';
            alert('Camera access failed or not found. Please check permissions and device.');
            return;
        }
        Quagga.start();
        scannerActive = true;
        startBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
    });

    let lastScannedCodes = [];
    let confirmationCount = 0;
    const REQUIRED_CONFIRMATIONS = 2;

    Quagga.onDetected(function(data) {
        const code = data.codeResult.code;
        if (!isValidBarcode(code)) return;

        lastScannedCodes.push(code);
        if (lastScannedCodes.length > 8) lastScannedCodes.shift();

        if (lastScannedCodes.length >= REQUIRED_CONFIRMATIONS &&
            lastScannedCodes.slice(-REQUIRED_CONFIRMATIONS).every(c => c === code)) {

            document.getElementById('scanned-code').textContent = code;
            document.getElementById('scan-result').style.display = 'block';
            document.getElementById('manual-barcode').value = code;
            updateBarcodeDisplay(code);

            stopBarcodeScanner();
            lastScannedCodes = [];
            confirmationCount = 0;

            setTimeout(() => {
                processBottle();
            }, 800);
        }
    });
}

function stopBarcodeScanner() {
    if (!scannerActive) return;
    Quagga.stop();
    scannerActive = false;

    const placeholder = document.getElementById('scanner-placeholder');
    const startBtn = document.getElementById('start-scanner-btn');
    const stopBtn = document.getElementById('stop-scanner-btn');

    placeholder.style.display = 'flex';
    startBtn.style.display = 'inline-block';
    stopBtn.style.display = 'none';

    setTimeout(() => {
        document.getElementById('scan-result').style.display = 'none';
    }, 2000);
}

function isValidBarcode(code) {
    const numericCode = code.replace(/[^0-9]/g, '');
    return numericCode.length >= 6 && numericCode.length <= 20;
}

function setupBarcodeInput() {
    const input = document.getElementById('manual-barcode');
    const display = document.getElementById('barcode-display');
    
    input.addEventListener('input', (e) => {
        const value = e.target.value;
        updateBarcodeDisplay(value);
    });
    
    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            processBottle();
        }
    });
}

function updateBarcodeDisplay(barcode) {
    const display = document.getElementById('barcode-display');
    if (barcode && barcode.length > 0) {
        const numericBarcode = barcode.replace(/[^0-9]/g, '');
        if (numericBarcode.length > 0) {
            display.innerHTML = `
                <div style="font-size:24px;color:#2196F3;margin-bottom:10px;">ğŸ“Š</div>
                <div style="font-size:20px;font-weight:bold;">${numericBarcode}</div>
                <div style="font-size:14px;color:#6c757d;margin-top:5px;">Barcode Ready for Processing</div>
            `;
        } else {
            display.innerHTML = `
                <div style="color:#dc3545;">âŒ Invalid barcode format</div>
                <div style="font-size:14px;color:#6c757d;">Please enter numbers only</div>
            `;
        }
    } else {
        display.innerHTML = 'Waiting for barcode input...';
    }
}

function processBottle() {
    const input = document.getElementById('manual-barcode');
    const bottleId = input.value.replace(/[^0-9]/g, '');
    
    if (!bottleId) {
        alert('Please enter a valid barcode');
        return;
    }
    
    currentBottleId = bottleId;
    const bottle = bottles.find(b => b.id === bottleId);
    
    const modal = document.getElementById('bottle-modal');
    const title = document.getElementById('modal-title');
    const info = document.getElementById('modal-bottle-info');
    
    if (bottle) {
        const client = clients.find(c => c.id === bottle.clientId);
        title.textContent = `Bottle ${bottleId}`;
        info.innerHTML = `
            <div style="background:rgba(33,150,243,0.1);padding:20px;border-radius:15px;margin:15px 0;">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                    <div>
                        <strong>ğŸ·ï¸ Status:</strong><br>
                        <span class="status ${bottle.status}">${bottle.status.replace('-', ' ').toUpperCase()}</span>
                    </div>
                    <div>
                        <strong>ğŸ”„ Refill Count:</strong><br>
                        <span style="font-size:18px;font-weight:bold;color:#2196F3;">${bottle.refillCount || 0}</span>
                    </div>
                    <div>
                        <strong>ğŸšš Delivery Count:</strong><br>
                        <span style="font-size:18px;font-weight:bold;color:#28a745;">${bottle.deliveryCount || 0}</span>
                    </div>
                    <div>
                        <strong>ğŸ“… Last Updated:</strong><br>
                        <span style="font-size:14px;">${new Date(bottle.lastUpdated).toLocaleString()}</span>
                    </div>
                </div>
                ${bottle.clientName ? `
                <div style="margin-top:15px;padding:15px;background:rgba(40,167,69,0.1);border-radius:10px;">
                    <strong>ğŸ‘¤ Current Client:</strong><br>
                    <div style="font-size:16px;font-weight:bold;color:#155724;">${bottle.clientName}</div>
                    <div style="font-size:14px;color:#155724;">ğŸ“ ${bottle.clientPhone}</div>
                    ${bottle.deliveryDate ? `<div style="font-size:14px;color:#155724;">ğŸ“… Delivered: ${new Date(bottle.deliveryDate).toLocaleString()}</div>` : ''}
                    ${bottle.deliveryNotes ? `<div style="font-size:14px;color:#155724;">ğŸ“ ${bottle.deliveryNotes}</div>` : ''}
                </div>
                ` : ''}
                ${bottle.history && bottle.history.length > 0 ? `
                <div style="margin-top:15px;">
                    <strong>ğŸ“‹ Recent History:</strong>
                    <div style="max-height:120px;overflow-y:auto;margin-top:8px;">
                        ${bottle.history.slice(-3).map(h => `
                            <div style="padding:5px;margin:3px 0;background:rgba(0,0,0,0.05);border-radius:5px;font-size:13px;">
                                ${h.action} - ${new Date(h.timestamp).toLocaleString()}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            </div>
        `;
    } else {
        title.textContent = `New Bottle ${bottleId}`;
        info.innerHTML = `
            <div style="background:rgba(40,167,69,0.1);padding:20px;border-radius:15px;margin:15px 0;color:#155724;">
                <div style="text-align:center;">
                    <div style="font-size:3rem;margin-bottom:10px;">ğŸ†•</div>
                    <strong style="font-size:18px;">New bottle detected!</strong><br>
                    <div style="margin-top:10px;">This bottle is not in the system yet. Choose an action to add it.</div>
                </div>
            </div>
        `;
    }
    
    // Show buttons based on user role
    showActionButtons();
    
    modal.style.display = 'block';
}

function showActionButtons() {
    const buttonsContainer = document.getElementById('modal-action-buttons');
    
    let buttonsHTML = '';
    
    // Worker can only Refill and Return
    if (currentUser.role === 'worker') {
        buttonsHTML = `
            <button class="btn btn-success" onclick="actionRefill()">ğŸ”„ Refill</button>
            <button class="btn btn-secondary" onclick="actionReturn()">â†©ï¸ Return</button>
        `;
    }
    // Driver can only Deliver
    else if (currentUser.role === 'driver') {
        buttonsHTML = `
            <button class="btn btn-warning" onclick="actionDeliver()">ğŸšš Deliver</button>
        `;
    }
    // Manager has all actions
    else if (currentUser.role === 'manager') {
        buttonsHTML = `
            <button class="btn btn-success" onclick="actionRefill()">ğŸ”„ Refill</button>
            <button class="btn btn-warning" onclick="actionDeliver()">ğŸšš Deliver</button>
            <button class="btn btn-secondary" onclick="actionReturn()">â†©ï¸ Return</button>
            <button class="btn" onclick="actionManual()">âœï¸ Manual Update</button>
        `;
    }
    // Admin has all actions
    else if (currentUser.role === 'admin') {
        buttonsHTML = `
            <button class="btn btn-success" onclick="actionRefill()">ğŸ”„ Refill</button>
            <button class="btn btn-warning" onclick="actionDeliver()">ğŸšš Deliver</button>
            <button class="btn btn-secondary" onclick="actionReturn()">â†©ï¸ Return</button>
            <button class="btn" onclick="actionManual()">âœï¸ Manual Update</button>
        `;
    }
    
    buttonsContainer.innerHTML = buttonsHTML;
}

function closeModal() {
    document.getElementById('bottle-modal').style.display = 'none';
}

function closeAddModal() {
    document.getElementById('add-bottle-modal').style.display = 'none';
}

function closeClientModal() {
    document.getElementById('add-client-modal').style.display = 'none';
}

function closeDeliveryModal() {
    document.getElementById('delivery-modal').style.display = 'none';
}

function toggleClientMode(mode) {
    deliveryClientMode = mode;
    const existingSection = document.getElementById('existing-client-section');
    const newSection = document.getElementById('new-client-section');
    const existingBtn = document.getElementById('existing-client-btn');
    const newBtn = document.getElementById('new-client-btn');
    
    if (mode === 'existing') {
        existingSection.style.display = 'block';
        newSection.style.display = 'none';
        existingBtn.classList.remove('btn-secondary');
        newBtn.classList.add('btn-secondary');
    } else {
        existingSection.style.display = 'none';
        newSection.style.display = 'flex';
        newBtn.classList.remove('btn-secondary');
        existingBtn.classList.add('btn-secondary');
    }
}

function filterDeliveryClients() {
    const searchTerm = document.getElementById('delivery-client-search').value.toLowerCase();
    const select = document.getElementById('delivery-client-select');
    
    select.innerHTML = '';
    
    const filteredClients = clients.filter(client => 
        client.name.toLowerCase().includes(searchTerm) ||
        client.phone.toLowerCase().includes(searchTerm)
    );
    
    if (filteredClients.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No clients found';
        option.disabled = true;
        select.appendChild(option);
    } else {
        filteredClients.forEach(client => {
            const option = document.createElement('option');
            option.value = client.id;
            option.textContent = `${client.name} (${client.phone})`;
            select.appendChild(option);
        });
    }
}

function filterNewBottleClients() {
    const searchTerm = document.getElementById('new-bottle-client-search').value.toLowerCase();
    const select = document.getElementById('new-bottle-client-select');
    
    select.innerHTML = '<option value="">Select Client (optional)</option>';
    
    const filteredClients = clients.filter(client => 
        client.name.toLowerCase().includes(searchTerm) ||
        client.phone.toLowerCase().includes(searchTerm)
    );
    
    filteredClients.forEach(client => {
        const option = document.createElement('option');
        option.value = client.id;
        option.textContent = `${client.name} (${client.phone})`;
        select.appendChild(option);
    });
}

function actionRefill() {
    let bottle = bottles.find(b => b.id === currentBottleId);
    
    if (!bottle) {
        bottle = createNewBottleRecord(currentBottleId, 'available');
        addActivity(`Bottle ${currentBottleId} added and refilled (Refill #1) - now available by ${currentUser.name}`);
    } else {
        if (bottle.status !== 'needs-refill') {
            alert(`âŒ Cannot refill this bottle!\n\nBottle must be in "Needs Refill" status.\nCurrent status: ${bottle.status.toUpperCase().replace('-', ' ')}`);
            return;
        }
        
        bottle.refillCount = (bottle.refillCount || 0) + 1;
        bottle.status = 'available';
        bottle.clientId = '';
        bottle.clientName = '';
        bottle.clientPhone = '';
        bottle.lastUpdated = new Date().toISOString();
        bottle.history = bottle.history || [];
        bottle.history.push({
            action: `Refilled (Count: ${bottle.refillCount}) by ${currentUser.name}`,
            timestamp: new Date().toISOString()
        });
        addActivity(`Bottle ${currentBottleId} refilled (Refill #${bottle.refillCount}) by ${currentUser.name}`);
    }
    
    updateClientBottleCounts();
    saveData();
    updateAllDisplays();
    closeModal();
}

function actionDeliver() {
    let bottle = bottles.find(b => b.id === currentBottleId);
    
    if (bottle && bottle.status !== 'available') {
        alert(`âŒ Cannot deliver this bottle!\n\nBottle must be "Available" (refilled) before delivery.\nCurrent status: ${bottle.status.toUpperCase().replace('-', ' ')}`);
        return;
    }
    
    if (!bottle) {
        const confirmed = window.confirm(`This is a new bottle. Do you want to add it as "Available" and proceed with delivery?`);
        if (!confirmed) return;
    }
    
    populateClientDropdowns();
    deliveryClientMode = 'existing';
    toggleClientMode('existing');
    document.getElementById('delivery-date').value = new Date().toISOString().split('T')[0];
    document.getElementById('delivery-time').value = new Date().toTimeString().slice(0,5);
    document.getElementById('delivery-client-search').value = '';
    document.getElementById('delivery-modal').style.display = 'block';
}

function confirmDelivery() {
    const deliveryDate = document.getElementById('delivery-date').value;
    const deliveryTime = document.getElementById('delivery-time').value;
    const deliveryNotes = document.getElementById('delivery-notes').value;

    let clientId, client;

    if (deliveryClientMode === 'existing') {
        clientId = document.getElementById('delivery-client-select').value;
        if (!clientId) {
            alert('Please select a client for delivery');
            return;
        }
        client = clients.find(c => c.id === clientId);
        if (!client) {
            alert('Selected client not found');
            return;
        }
    } else {
        const name = document.getElementById('delivery-new-client-name').value.trim();
        const phone = document.getElementById('delivery-new-client-phone').value.trim();
        const address = document.getElementById('delivery-new-client-address').value.trim();
        const notes = document.getElementById('delivery-new-client-notes').value.trim();

        if (!name) {
            alert('Please enter a client name');
            return;
        }
        if (!phone) {
            alert('Please enter a phone number');
            return;
        }

        const existingClient = clients.find(c => c.phone === phone);
        if (existingClient) {
            if (confirm(`A client with this phone number already exists: ${existingClient.name}. Use this client instead?`)) {
                client = existingClient;
                clientId = existingClient.id;
            } else {
                return;
            }
        } else {
            client = {
                id: 'client_' + Date.now(),
                name: name,
                phone: phone,
                address: address,
                notes: notes,
                created: new Date().toISOString(),
                bottleCount: 0
            };
            clients.push(client);
            clientId = client.id;
            addActivity(`New client added during delivery: ${name} (${phone}) by ${currentUser.name}`);
        }
    }
    
    let bottle = bottles.find(b => b.id === currentBottleId);
    
    if (!bottle) {
        bottle = createNewBottleRecord(currentBottleId, 'with-client');
    } else {
        bottle.status = 'with-client';
        bottle.deliveryCount = (bottle.deliveryCount || 0) + 1;
        bottle.lastUpdated = new Date().toISOString();
    }
    
    bottle.clientId = clientId;
    bottle.clientName = client.name;
    bottle.clientPhone = client.phone;
    bottle.deliveryDate = deliveryDate && deliveryTime ? `${deliveryDate}T${deliveryTime}` : new Date().toISOString();
    bottle.deliveryNotes = deliveryNotes;
    
    bottle.history = bottle.history || [];
    bottle.history.push({
        action: `Delivered to ${client.name} (Delivery #${bottle.deliveryCount}) by ${currentUser.name}`,
        timestamp: new Date().toISOString(),
        client: client.name,
        phone: client.phone,
        notes: deliveryNotes
    });
    
    addActivity(`Bottle ${currentBottleId} delivered to ${client.name} (${client.phone}) by ${currentUser.name}`);
    updateClientBottleCounts();
    saveData();
    updateAllDisplays();
    closeDeliveryModal();
    closeModal();

    document.getElementById('delivery-new-client-name').value = '';
    document.getElementById('delivery-new-client-phone').value = '';
    document.getElementById('delivery-new-client-address').value = '';
    document.getElementById('delivery-new-client-notes').value = '';
}

function actionReturn() {
    let bottle = bottles.find(b => b.id === currentBottleId);
    
    if (!bottle) {
        bottle = createNewBottleRecord(currentBottleId, 'needs-refill');
    } else {
        bottle.status = 'needs-refill';
        bottle.returnDate = new Date().toISOString();
        bottle.lastUpdated = new Date().toISOString();
        bottle.history = bottle.history || [];
        bottle.history.push({
            action: `Returned from ${bottle.clientName || 'client'}, needs refill - by ${currentUser.name}`,
            timestamp: new Date().toISOString(),
            client: bottle.clientName
        });
    }
    
    addActivity(`Bottle ${currentBottleId} returned from ${bottle.clientName || 'client'} by ${currentUser.name}`);
    updateClientBottleCounts();
    saveData();
    updateAllDisplays();
    closeModal();
}

function actionManual() {
    const status = prompt('Select status:\n1. Available\n2. With Client\n3. Needs Refill\n4. Maintenance\n\nEnter number (1-4):');
    const statusMap = {
        '1': 'available',
        '2': 'with-client', 
        '3': 'needs-refill',
        '4': 'maintenance'
    };
    
    if (statusMap[status]) {
        let bottle = bottles.find(b => b.id === currentBottleId);
        
        if (!bottle) {
            bottle = createNewBottleRecord(currentBottleId, statusMap[status]);
        } else {
            bottle.status = statusMap[status];
            bottle.lastUpdated = new Date().toISOString();
            bottle.history = bottle.history || [];
            bottle.history.push({
                action: `Manually updated to ${statusMap[status]} by ${currentUser.name}`,
                timestamp: new Date().toISOString()
            });
        }
        
        if (status === '2') {
            actionDeliver();
            return;
        }
        
        addActivity(`Bottle ${currentBottleId} manually updated to ${statusMap[status]} by ${currentUser.name}`);
        updateClientBottleCounts();
        saveData();
        updateAllDisplays();
    }
    closeModal();
}

function createNewBottleRecord(bottleId, status) {
    const newBottle = {
        id: bottleId,
        status: status,
        clientId: '',
        clientName: '',
        clientPhone: '',
        refillCount: status === 'available' ? 1 : 0,
        deliveryCount: 0,
        lastUpdated: new Date().toISOString(),
        created: new Date().toISOString(),
        history: [{
            action: `Bottle created with status: ${status} by ${currentUser.name}`,
            timestamp: new Date().toISOString()
        }]
    };
    
    bottles.push(newBottle);
    return newBottle;
}

function updateAllDisplays() {
    updateDashboard();
    updateInventoryDisplay();
    updateClientDisplay();
    updateReports();
    populateClientDropdowns();
    updateAddButtons();
}

function updateAddButtons() {
    // Update Add Bottle Button
    const addBottleContainer = document.getElementById('add-bottle-btn-container');
    if (currentUser.role !== 'worker') {
        addBottleContainer.innerHTML = '<button class="btn btn-success" onclick="addNewBottle()">â• Add New Bottle</button>';
    } else {
        addBottleContainer.innerHTML = '';
    }
    
    // Update Add Client Button
    const addClientContainer = document.getElementById('add-client-btn-container');
    if (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'driver') {
        addClientContainer.innerHTML = '<button class="btn btn-success" onclick="addNewClient()">â• Add New Client</button>';
    } else {
        addClientContainer.innerHTML = '';
    }
}

function updateDashboard() {
    const stats = {
        total: bottles.length,
        available: bottles.filter(b => b.status === 'available').length,
        withClient: bottles.filter(b => b.status === 'with-client').length,
        needsRefill: bottles.filter(b => b.status === 'needs-refill').length,
        maintenance: bottles.filter(b => b.status === 'maintenance').length,
        clients: clients.length
    };
    
    document.getElementById('total-bottles').textContent = stats.total;
    document.getElementById('available-bottles').textContent = stats.available;
    document.getElementById('with-client-bottles').textContent = stats.withClient;
    document.getElementById('needs-refill-bottles').textContent = stats.needsRefill;
    document.getElementById('maintenance-bottles').textContent = stats.maintenance;
    document.getElementById('total-clients').textContent = stats.clients;
    
    const activityDiv = document.getElementById('recent-activity');
    if (activityLog.length > 0) {
        activityDiv.innerHTML = activityLog.slice(0, 15).map(activity => `
            <div style="padding:12px;margin:8px 0;background:rgba(33,150,243,0.05);border-radius:10px;border-left:4px solid #2196F3;">
                <div style="font-weight:600;color:#2196F3;margin-bottom:5px;">${activity.action}</div>
                <div class="small" style="color:#6c757d;">${new Date(activity.timestamp).toLocaleString()}</div>
            </div>
        `).join('');
    } else {
        activityDiv.innerHTML = '<p class="small">No recent activity</p>';
    }
    
    const alertsDiv = document.getElementById('alerts');
    const alerts = [];
    
    const needsRefill = bottles.filter(b => b.status === 'needs-refill').length;
    const maintenance = bottles.filter(b => b.status === 'maintenance').length;
    const highRefillCount = bottles.filter(b => (b.refillCount || 0) > 10).length;
    
    if (needsRefill > 0) {
        alerts.push(`${needsRefill} bottle(s) need refilling`);
    }
    if (maintenance > 0) {
        alerts.push(`${maintenance} bottle(s) need maintenance`);
    }
    if (highRefillCount > 0) {
        alerts.push(`${highRefillCount} bottle(s) have high refill count (>10)`);
    }
    
    if (alerts.length > 0) {
        alertsDiv.innerHTML = alerts.map(alert => `
            <div style="padding:12px;margin:8px 0;background:rgba(255,193,7,0.1);border-radius:10px;border-left:4px solid #ffc107;color:#856404;">
                âš ï¸ ${alert}
            </div>
        `).join('');
    } else {
        alertsDiv.innerHTML = '<p class="small">No alerts</p>';
    }
}

function updateInventoryDisplay() {
    const inventoryDiv = document.getElementById('bottle-inventory');
    const searchTerm = document.getElementById('search-bottles').value.toLowerCase();
    const statusFilter = document.getElementById('filter-status').value;
    
    let filteredBottles = bottles.filter(bottle => {
        const matchesSearch = !searchTerm || 
            bottle.id.toLowerCase().includes(searchTerm) ||
            (bottle.clientName && bottle.clientName.toLowerCase().includes(searchTerm)) ||
            (bottle.clientPhone && bottle.clientPhone.toLowerCase().includes(searchTerm)) ||
            bottle.status.toLowerCase().includes(searchTerm);
        
        const matchesStatus = !statusFilter || bottle.status === statusFilter;
        
        return matchesSearch && matchesStatus;
    });
    
    if (filteredBottles.length > 0) {
        inventoryDiv.innerHTML = filteredBottles.map(bottle => `
            <div class="bottle-card">
                <div class="bottle-id">Bottle #${bottle.id}</div>
                <div class="status ${bottle.status}">${bottle.status.replace('-', ' ').toUpperCase()}</div>
                <div style="margin:15px 0;">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
                        <div><strong>ğŸ”„ Refills:</strong> ${bottle.refillCount || 0}</div>
                        <div><strong>ğŸšš Deliveries:</strong> ${bottle.deliveryCount || 0}</div>
                    </div>
                    ${bottle.clientName ? `
                        <div style="background:rgba(40,167,69,0.1);padding:10px;border-radius:8px;margin:10px 0;">
                            <strong>ğŸ‘¤ Client:</strong> ${bottle.clientName}<br>
                            <strong>ğŸ“ Phone:</strong> ${bottle.clientPhone}<br>
                            ${bottle.deliveryDate ? `<strong>ğŸ“… Delivered:</strong> ${new Date(bottle.deliveryDate).toLocaleString()}<br>` : ''}
                            ${bottle.deliveryNotes ? `<strong>ğŸ“ Notes:</strong> ${bottle.deliveryNotes}` : ''}
                        </div>
                    ` : '<div><strong>ğŸ‘¤ Client:</strong> None</div>'}
                    <div style="margin-top:10px;"><strong>ğŸ“… Last Updated:</strong> ${new Date(bottle.lastUpdated).toLocaleString()}</div>
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    <button class="btn btn-sm" onclick="viewBottleDetails('${bottle.id}')">ğŸ‘ï¸ Details</button>
                    <button class="btn btn-sm btn-warning" onclick="editBottle('${bottle.id}')">âœï¸ Edit</button>
                    ${(currentUser.role === 'admin' || currentUser.role === 'manager') ? `<button class="btn btn-sm btn-danger" onclick="deleteBottle('${bottle.id}')">ğŸ—‘ï¸ Delete</button>` : ''}
                </div>
            </div>
        `).join('');
    } else {
        inventoryDiv.innerHTML = '<div style="text-align:center;padding:40px;color:#6c757d;">No bottles found matching your criteria.</div>';
    }
}

function updateClientDisplay() {
    updateClientBottleCounts();
    const clientDiv = document.getElementById('client-list');
    const searchTerm = document.getElementById('search-clients').value.toLowerCase();
    
    let filteredClients = clients.filter(client => {
        return !searchTerm || 
            client.name.toLowerCase().includes(searchTerm) ||
            client.phone.toLowerCase().includes(searchTerm) ||
            (client.address && client.address.toLowerCase().includes(searchTerm));
    });
    
    if (filteredClients.length > 0) {
        clientDiv.innerHTML = filteredClients.map(client => `
            <div class="bottle-card">
                <div class="bottle-id">ğŸ‘¤ ${client.name}</div>
                <div class="status with-client">CLIENT</div>
                <div style="margin:15px 0;">
                    <div><strong>ğŸ“ Phone:</strong> ${client.phone}</div>
                    ${client.address ? `<div><strong>ğŸ“ Address:</strong> ${client.address}</div>` : ''}
                    <div><strong>ğŸ¶ Bottles:</strong> ${client.bottleCount || 0}</div>
                    ${client.notes ? `<div style="margin-top:10px;"><strong>ğŸ“ Notes:</strong> ${client.notes}</div>` : ''}
                    <div style="margin-top:10px;"><strong>ğŸ“… Added:</strong> ${new Date(client.created).toLocaleString()}</div>
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    <button class="btn btn-sm" onclick="viewClientBottles('${client.id}')">ğŸ¶ View Bottles</button>
                    ${(currentUser.role === 'admin' || currentUser.role === 'manager') ? `<button class="btn btn-sm btn-warning" onclick="editClient('${client.id}')">âœï¸ Edit</button>` : ''}
                    ${(currentUser.role === 'admin' || currentUser.role === 'manager') ? `<button class="btn btn-sm btn-danger" onclick="deleteClient('${client.id}')">ğŸ—‘ï¸ Delete</button>` : ''}
                </div>
            </div>
        `).join('');
    } else {
        clientDiv.innerHTML = '<div style="text-align:center;padding:40px;color:#6c757d;">No clients found matching your criteria.</div>';
    }
}

function searchBottles() {
    updateInventoryDisplay();
}

function filterBottles() {
    updateInventoryDisplay();
}

function searchClients() {
    updateClientDisplay();
}

function addNewClient() {
    document.getElementById('add-client-modal').style.display = 'block';
}

function createNewClient() {
    const name = document.getElementById('new-client-name').value.trim();
    const phone = document.getElementById('new-client-phone').value.trim();
    const address = document.getElementById('new-client-address').value.trim();
    const notes = document.getElementById('new-client-notes').value.trim();
    
    if (!name) {
        alert('Please enter a client name');
        return;
    }
    
    if (!phone) {
        alert('Please enter a phone number');
        return;
    }
    
    if (clients.find(c => c.phone === phone)) {
        alert('A client with this phone number already exists');
        return;
    }
    
    const newClient = {
        id: 'client_' + Date.now(),
        name: name,
        phone: phone,
        address: address,
        notes: notes,
        created: new Date().toISOString(),
        bottleCount: 0
    };
    
    clients.push(newClient);
    addActivity(`New client added: ${name} (${phone}) by ${currentUser.name}`);
    
    document.getElementById('new-client-name').value = '';
    document.getElementById('new-client-phone').value = '';
    document.getElementById('new-client-address').value = '';
    document.getElementById('new-client-notes').value = '';
    
    closeClientModal();
    saveData();
    updateAllDisplays();
}

function viewClientBottles(clientId) {
    const client = clients.find(c => c.id === clientId);
    const clientBottles = bottles.filter(b => b.clientId === clientId);
    
    if (!client) return;
    
    let message = `Bottles for ${client.name} (${client.phone}):\n\n`;
    
    if (clientBottles.length > 0) {
        clientBottles.forEach(bottle => {
            message += `â€¢ Bottle ${bottle.id} - ${bottle.status.toUpperCase()}\n`;
            message += `  Refills: ${bottle.refillCount || 0}, Deliveries: ${bottle.deliveryCount || 0}\n`;
            if (bottle.deliveryDate) {
                message += `  Last Delivered: ${new Date(bottle.deliveryDate).toLocaleString()}\n`;
            }
            message += '\n';
        });
    } else {
        message += 'No bottles currently with this client.';
    }
    
    alert(message);
}

function editClient(clientId) {
    const client = clients.find(c => c.id === clientId);
    if (!client) return;
    
    const newName = prompt('Enter new client name:', client.name);
    if (newName && newName !== client.name) {
        const oldName = client.name;
        client.name = newName;
        
        bottles.forEach(bottle => {
            if (bottle.clientId === clientId) {
                bottle.clientName = newName;
            }
        });
        
        addActivity(`Client name updated from ${oldName} to ${newName} by ${currentUser.name}`);
        saveData();
        updateAllDisplays();
    }
}

function deleteClient(clientId) {
    const password = prompt('âš ï¸ Enter password to delete this client:');
    
    if (password !== DELETE_PASSWORD) {
        alert('âŒ Incorrect password! Deletion cancelled.');
        return;
    }
    
    const client = clients.find(c => c.id === clientId);
    if (!client) return;
    
    const clientBottles = bottles.filter(b => b.clientId === clientId);
    
    if (clientBottles.length > 0) {
        if (!confirm(`Client ${client.name} has ${clientBottles.length} bottle(s). Deleting will remove client info from bottles. Continue?`)) {
            return;
        }
        
        clientBottles.forEach(bottle => {
            bottle.clientId = '';
            bottle.clientName = '';
            bottle.clientPhone = '';
        });
    }
    
    if (confirm(`Are you sure you want to delete client ${client.name}? This action cannot be undone.`)) {
        clients = clients.filter(c => c.id !== clientId);
        addActivity(`Client deleted: ${client.name} (${client.phone}) by ${currentUser.name}`);
        saveData();
        updateAllDisplays();
    }
}

function addNewBottle() {
    populateClientDropdowns();
    document.getElementById('new-bottle-client-search').value = '';
    document.getElementById('add-bottle-modal').style.display = 'block';
}

function createNewBottle() {
    const id = document.getElementById('new-bottle-id').value.trim();
    const clientId = document.getElementById('new-bottle-client-select').value;
    const status = document.getElementById('new-bottle-status').value;
    
    if (!id) {
        alert('Please enter a bottle ID');
        return;
    }
    
    if (bottles.find(b => b.id === id)) {
        alert('A bottle with this ID already exists');
        return;
    }
    
    const client = clientId ? clients.find(c => c.id === clientId) : null;
    
    const newBottle = {
        id: id,
        status: status,
        clientId: clientId || '',
        clientName: client ? client.name : '',
        clientPhone: client ? client.phone : '',
        refillCount: status === 'available' ? 1 : 0,
        deliveryCount: 0,
        lastUpdated: new Date().toISOString(),
        created: new Date().toISOString(),
        history: [{
            action: `Bottle created with status: ${status} by ${currentUser.name}`,
            timestamp: new Date().toISOString(),
            client: client ? client.name : ''
        }]
    };
    
    bottles.push(newBottle);
    addActivity(`New bottle ${id} added to inventory${client ? ` for ${client.name}` : ''} by ${currentUser.name}`);
    
    document.getElementById('new-bottle-id').value = '';
    document.getElementById('new-bottle-client-select').value = '';
    document.getElementById('new-bottle-status').value = 'available';
    
    closeAddModal();
    saveData();
    updateAllDisplays();
}

function populateClientDropdowns() {
    const selects = [
        document.getElementById('new-bottle-client-select'),
        document.getElementById('delivery-client-select')
    ];
    
    selects.forEach(select => {
        if (select) {
            const currentValue = select.value;
            const isDeliverySelect = select.id === 'delivery-client-select';
            
            if (isDeliverySelect) {
                select.innerHTML = '';
            } else {
                select.innerHTML = '<option value="">Select Client (optional)</option>';
            }
            
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `${client.name} (${client.phone})`;
                if (client.id === currentValue) option.selected = true;
                select.appendChild(option);
            });
        }
    });
}

function viewBottleDetails(bottleId) {
    const bottle = bottles.find(b => b.id === bottleId);
    if (!bottle) return;
    
    let details = `Bottle Details for #${bottle.id}\n\n`;
    details += `Status: ${bottle.status.toUpperCase()}\n`;
    details += `Refill Count: ${bottle.refillCount || 0}\n`;
    details += `Delivery Count: ${bottle.deliveryCount || 0}\n`;
    details += `Created: ${new Date(bottle.created).toLocaleString()}\n`;
    details += `Last Updated: ${new Date(bottle.lastUpdated).toLocaleString()}\n\n`;
    
    if (bottle.clientName) {
        details += `Current Client: ${bottle.clientName}\n`;
        details += `Phone: ${bottle.clientPhone}\n`;
        if (bottle.deliveryDate) {
            details += `Delivered: ${new Date(bottle.deliveryDate).toLocaleString()}\n`;
        }
        if (bottle.deliveryNotes) {
            details += `Notes: ${bottle.deliveryNotes}\n`;
        }
        details += '\n';
    }
    
    if (bottle.history && bottle.history.length > 0) {
        details += 'Recent History:\n';
        bottle.history.slice(-5).forEach(h => {
            details += `â€¢ ${h.action} - ${new Date(h.timestamp).toLocaleString()}\n`;
        });
    }
    
    alert(details);
}

function editBottle(bottleId) {
    const bottle = bottles.find(b => b.id === bottleId);
    if (!bottle) return;
    currentBottleId = bottleId;
    document.getElementById('manual-barcode').value = bottleId; // Set barcode input
    processBottle();
}

function deleteBottle(bottleId) {
    const password = prompt('âš ï¸ Enter password to delete this bottle:');
    
    if (password !== DELETE_PASSWORD) {
        alert('âŒ Incorrect password! Deletion cancelled.');
        return;
    }
    
    if (confirm(`Are you sure you want to delete bottle ${bottleId}? This action cannot be undone.`)) {
        const bottle = bottles.find(b => b.id === bottleId);
        bottles = bottles.filter(b => b.id !== bottleId);
        addActivity(`Bottle ${bottleId} deleted from inventory${bottle && bottle.clientName ? ` (was with ${bottle.clientName})` : ''} by ${currentUser.name}`);
        updateClientBottleCounts();
        saveData();
        updateAllDisplays();
    }
}

function updateReports() {
    console.log('Reports updated');
}

function generateReport() {
    const startDate = document.getElementById('report-start').value;
    const endDate = document.getElementById('report-end').value;
    
    if (!startDate || !endDate) {
        alert('Please select both start and end dates');
        return;
    }
    
    if (!Array.isArray(activityLog)) {
        console.warn('activityLog is not an array, resetting to empty array');
        activityLog = [];
    }
    
    const start = new Date(startDate);
    start.setHours(0, 0, 0, 0);
    
    const end = new Date(endDate);
    end.setHours(23, 59, 59, 999);
    
    const filteredActivities = activityLog.filter(activity => {
        const activityDate = new Date(activity.timestamp);
        return activityDate >= start && activityDate <= end;
    });
    
    const totalRefills = bottles.reduce((sum, bottle) => sum + (bottle.refillCount || 0), 0);
    const totalDeliveries = bottles.reduce((sum, bottle) => sum + (bottle.deliveryCount || 0), 0);
    
    const reportSummary = document.getElementById('report-summary');
    reportSummary.innerHTML = `
        <h4>ğŸ“Š Report for ${startDate} to ${endDate}</h4>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0;">
            <div style="background:rgba(33,150,243,0.1);padding:15px;border-radius:10px;">
                <strong>Total Activities:</strong><br>
                <span style="font-size:24px;font-weight:bold;color:#2196F3;">${filteredActivities.length}</span>
            </div>
            <div style="background:rgba(40,167,69,0.1);padding:15px;border-radius:10px;">
                <strong>Total Bottles:</strong><br>
                <span style="font-size:24px;font-weight:bold;color:#28a745;">${bottles.length}</span>
            </div>
            <div style="background:rgba(255,193,7,0.1);padding:15px;border-radius:10px;">
                <strong>Total Refills:</strong><br>
                <span style="font-size:24px;font-weight:bold;color:#856404;">${totalRefills}</span>
            </div>
            <div style="background:rgba(220,53,69,0.1);padding:15px;border-radius:10px;">
                <strong>Total Deliveries:</strong><br>
                <span style="font-size:24px;font-weight:bold;color:#dc3545;">${totalDeliveries}</span>
            </div>
        </div>
        
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin:15px 0;">
            <div><strong>Available:</strong> ${bottles.filter(b => b.status === 'available').length}</div>
            <div><strong>With Clients:</strong> ${bottles.filter(b => b.status === 'with-client').length}</div>
            <div><strong>Need Refill:</strong> ${bottles.filter(b => b.status === 'needs-refill').length}</div>
            <div><strong>Maintenance:</strong> ${bottles.filter(b => b.status === 'maintenance').length}</div>
            <div><strong>Total Clients:</strong> ${clients.length}</div>
        </div>
        
        <div style="margin-top:20px;">
            <h5>ğŸ“‹ Activities in Period (${filteredActivities.length}):</h5>
            <div style="max-height:300px;overflow-y:auto;margin-top:10px;">
                ${filteredActivities.length > 0 ? 
                    filteredActivities.slice(0, 20).map(activity => `
                        <div style="padding:8px;margin:4px 0;background:rgba(0,0,0,0.05);border-radius:8px;border-left:3px solid #2196F3;">
                            <div style="font-weight:600;">${activity.action}</div>
                            <div style="font-size:13px;color:#6c757d;">${new Date(activity.timestamp).toLocaleString()}</div>
                        </div>
                    `).join('') 
                    : 
                    '<p>No activities in this period</p>'
                }
                ${filteredActivities.length > 20 ? `<div style="text-align:center;padding:10px;color:#6c757d;">... and ${filteredActivities.length - 20} more activities</div>` : ''}
            </div>
        </div>
    `;
    
    console.log('Report generated successfully!');
}

function exportToExcel() {
    console.log('Exporting data to Excel...');
    
    let csvContent = '\uFEFF';
    
    csvContent += '===== BOTTLE TRACKING SYSTEM - DATA EXPORT =====\n';
    csvContent += `Export Date:,${new Date().toLocaleString()}\n`;
    csvContent += `Exported By:,${currentUser.name} (${currentUser.role})\n`;
    csvContent += '\n';
    
    csvContent += '===== SUMMARY STATISTICS =====\n';
    csvContent += `Total Bottles:,${bottles.length}\n`;
    csvContent += `Total Clients:,${clients.length}\n`;
    csvContent += `Total Activities:,${activityLog.length}\n`;
    csvContent += `Available Bottles:,${bottles.filter(b => b.status === 'available').length}\n`;
    csvContent += `Bottles With Clients:,${bottles.filter(b => b.status === 'with-client').length}\n`;
    csvContent += `Bottles Need Refill:,${bottles.filter(b => b.status === 'needs-refill').length}\n`;
    csvContent += `Bottles In Maintenance:,${bottles.filter(b => b.status === 'maintenance').length}\n`;
    csvContent += `Total Refills:,${bottles.reduce((sum, b) => sum + (b.refillCount || 0), 0)}\n`;
    csvContent += `Total Deliveries:,${bottles.reduce((sum, b) => sum + (b.deliveryCount || 0), 0)}\n`;
    csvContent += '\n\n\n';
    
    csvContent += '===== BOTTLES DATA =====\n';
    csvContent += 'Bottle ID,Status,Client Name,Client Phone,Refill Count,Delivery Count,Last Updated,Created Date\n';
    
    bottles.forEach(bottle => {
        const bottleId = bottle.id || '';
        const status = bottle.status || '';
        const clientName = bottle.clientName ? bottle.clientName.replace(/"/g, '""') : 'None';
        const clientPhone = bottle.clientPhone || 'N/A';
        const refillCount = bottle.refillCount || 0;
        const deliveryCount = bottle.deliveryCount || 0;
        const lastUpdated = new Date(bottle.lastUpdated).toLocaleString();
        const created = new Date(bottle.created).toLocaleString();
        
        csvContent += `"${bottleId}","${status}","${clientName}","${clientPhone}",${refillCount},${deliveryCount},"${lastUpdated}","${created}"\n`;
    });
    
    csvContent += '\n\n\n';
    
    csvContent += '===== CLIENTS DATA =====\n';
    csvContent += 'Client ID,Name,Phone,Address,Bottles Count,Notes,Created Date\n';
    
    clients.forEach(client => {
        const clientId = client.id || '';
        const name = client.name ? client.name.replace(/"/g, '""') : '';
        const phone = client.phone || '';
        const address = client.address ? client.address.replace(/"/g, '""') : 'N/A';
        const bottleCount = client.bottleCount || 0;
        const notes = client.notes ? client.notes.replace(/"/g, '""') : 'N/A';
        const created = new Date(client.created).toLocaleString();
        
        csvContent += `"${clientId}","${name}","${phone}","${address}",${bottleCount},"${notes}","${created}"\n`;
    });
    
    csvContent += '\n\n\n';
    
    csvContent += '===== ACTIVITY LOG (Last 100 Activities) =====\n';
    csvContent += 'Action,Date & Time\n';
    
    const recentActivities = Array.isArray(activityLog) ? activityLog.slice(0, 100) : [];
    recentActivities.forEach(activity => {
        const action = activity.action ? activity.action.replace(/"/g, '""') : '';
        const timestamp = new Date(activity.timestamp).toLocaleString();
        
        csvContent += `"${action}","${timestamp}"\n`;
    });
    
    csvContent += '\n\n===== END OF REPORT =====\n';
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    const today = new Date();
    const dateStr = today.toISOString().slice(0, 10);
    const timeStr = today.toTimeString().slice(0, 5).replace(':', '-');
    const filename = `Bottle_Tracking_Report_${dateStr}_${timeStr}.csv`;
    
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert(`âœ… Data exported successfully!\n\nğŸ“„ File: ${filename}\n\nExported by: ${currentUser.name}\n\nTotal:\nâ€¢ ${bottles.length} bottles\nâ€¢ ${clients.length} clients\nâ€¢ ${recentActivities.length} activity logs`);
    
    addActivity(`Data exported by ${currentUser.name}: ${bottles.length} bottles, ${clients.length} clients`);
    
    console.log('Export completed successfully!');
}

function addActivity(message) {
    activityLog.unshift({
        action: message,
        timestamp: new Date().toISOString()
    });
    
    if (activityLog.length > 100) {
        activityLog = activityLog.slice(0, 100);
    }
    
    saveData();
    updateDashboard();
}

function setupDefaultDates() {
    const today = new Date();
    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
    document.getElementById('report-start').value = lastMonth.toISOString().split('T')[0];
    document.getElementById('report-end').value = today.toISOString().split('T')[0];
}

function createFloatingParticles() {
    const container = document.querySelector('.floating-particles');
    if (!container) return;
    for (let i = 0; i < 50; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 15 + 's';
        particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
        container.appendChild(particle);
    }
}

const hamburgerBtn = document.getElementById('hamburger-btn');
const drawer = document.getElementById('drawer');
hamburgerBtn && hamburgerBtn.addEventListener('click', () => {
    drawer.style.display = drawer.style.display === 'block' ? 'none' : 'block';
});
window.addEventListener('resize', () => {
    if (window.innerWidth < 768) {
        document.getElementById('mobile-nav').style.display = 'block';
        document.querySelector('.tabs').style.display = 'none';
    } else {
        document.getElementById('mobile-nav').style.display = 'none';
        document.querySelector('.tabs').style.display = 'flex';
        drawer.style.display = 'none';
    }
});
if (window.innerWidth < 768) {
    document.getElementById('mobile-nav').style.display = 'block';
    document.querySelector('.tabs').style.display = 'none';
}

// Make showTab globally accessible for inline onclick handlers
window.showTab = showTab;
</script>
</body>
</html>
